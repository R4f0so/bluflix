// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\adicionar_perfis.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';
import 'pin_verification.dart';

class AdicionarPerfisScreen extends StatefulWidget {
  const AdicionarPerfisScreen({super.key});

  @override
  State<AdicionarPerfisScreen> createState() => _AdicionarPerfisScreenState();
}

class _AdicionarPerfisScreenState extends State<AdicionarPerfisScreen> {
  List<Map<String, dynamic>> _perfisFilhos = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _carregarPerfis();
  }

  void _mostrarOpcoesPerfi(
    int index,
    Map<String, dynamic> perfil,
    AppTema appTema,
  ) {
    final apelido = perfil['apelido'] ?? 'este perfil';

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (modalContext) {
        // âœ… Use modalContext separado
        return Container(
          decoration: BoxDecoration(
            color: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: SafeArea(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey[600],
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),

                Padding(
                  padding: const EdgeInsets.all(20.0),
                  child: Row(
                    children: [
                      CircleAvatar(
                        radius: 24,
                        backgroundImage: AssetImage(
                          perfil['avatar'] ?? 'assets/avatar1.png',
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          apelido,
                          style: TextStyle(
                            color: appTema.textColor,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                const Divider(height: 1),

                ListTile(
                  leading: Icon(
                    Icons.edit_outlined,
                    color: appTema.textSecondaryColor,
                  ),
                  title: Text(
                    'Editar Perfil',
                    style: TextStyle(color: appTema.textSecondaryColor),
                  ),
                  subtitle: Text(
                    'Em desenvolvimento',
                    style: TextStyle(
                      color: appTema.textSecondaryColor.withValues(alpha: 0.6),
                      fontSize: 12,
                    ),
                  ),
                  onTap: () {
                    Navigator.pop(modalContext); // âœ… modalContext
                    if (mounted) {
                      // âœ… Verifica se ainda estÃ¡ montado
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('FunÃ§Ã£o em desenvolvimento...'),
                          duration: Duration(seconds: 2),
                        ),
                      );
                    }
                  },
                ),

                ListTile(
                  leading: const Icon(Icons.delete_outline, color: Colors.red),
                  title: const Text(
                    'Excluir Perfil',
                    style: TextStyle(color: Colors.red),
                  ),
                  onTap: () {
                    Navigator.pop(modalContext); // âœ… modalContext
                    if (mounted) {
                      // âœ… Verifica se ainda estÃ¡ montado
                      _confirmarExclusao(index);
                    }
                  },
                ),

                const SizedBox(height: 8),
              ],
            ),
          ),
        );
      },
    );
  }

  Future<void> _carregarPerfis() async {
    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final data = userDoc.data();
          final perfis = data?['perfisFilhos'] as List<dynamic>? ?? [];

          setState(() {
            _perfisFilhos = perfis
                .map((p) => Map<String, dynamic>.from(p))
                .toList();
            _isLoading = false;
          });
        }
      }
    } catch (e) {
      print('Erro ao carregar perfis: $e');
      setState(() => _isLoading = false);
    }
  }

  Future<void> _confirmarExclusao(int index) async {
    final perfil = _perfisFilhos[index];
    final apelido = perfil['apelido'] ?? 'este perfil';

    // âœ… Verifica se estÃ¡ montado antes de verificar PIN
    if (!mounted) return;

    // Primeiro verifica o PIN
    final pinVerificado = await VerificarPinDialog.verificar(context);
    if (!pinVerificado) {
      return; // UsuÃ¡rio cancelou ou PIN incorreto
    }

    // âœ… Verifica novamente apÃ³s operaÃ§Ã£o assÃ­ncrona
    if (!mounted) return;

    // ApÃ³s verificar PIN, pede confirmaÃ§Ã£o
    final appTema = Provider.of<AppTema>(context, listen: false);
    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
        title: Row(
          children: [
            const Icon(
              Icons.warning_amber_rounded,
              color: Colors.orange,
              size: 28,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                'Excluir Perfil',
                style: TextStyle(color: appTema.textColor),
              ),
            ),
          ],
        ),
        content: Text(
          'Deseja realmente excluir o perfil "$apelido"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.',
          style: TextStyle(color: appTema.textSecondaryColor),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              'Cancelar',
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: const Text('Excluir'),
          ),
        ],
      ),
    );

    if (confirmar == true) {
      await _excluirPerfil(index);
    }
  }

  Future<void> _excluirPerfil(int index) async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) return;

      final perfilExcluido = _perfisFilhos[index];
      final apelidoExcluido = perfilExcluido['apelido'];

      // âœ… Remove do array local
      _perfisFilhos.removeAt(index);

      // âœ… Atualiza no Firestore
      await FirebaseFirestore.instance.collection('users').doc(user.uid).update(
        {'perfisFilhos': _perfisFilhos},
      );

      print("âœ… Perfil excluÃ­do com sucesso!");

      if (!mounted) return; // âœ… Sempre verifica

      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );

      if (perfilProvider.perfilAtivoApelido == apelidoExcluido) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final data = userDoc.data();
          await perfilProvider.setPerfilAtivo(
            apelido: data?['apelido'] ?? 'UsuÃ¡rio',
            avatar: data?['avatar'] ?? 'assets/avatar1.png',
            isPai: true,
          );

          if (!mounted) return; // âœ… Verifica de novo

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text(
                'Perfil excluÃ­do! Voltando para o perfil principal.',
              ),
              backgroundColor: Colors.orange,
              duration: Duration(seconds: 3),
            ),
          );
        }
      } else {
        if (!mounted) return; // âœ… Verifica

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Perfil "$apelidoExcluido" excluÃ­do com sucesso!'),
            backgroundColor: Colors.green,
            duration: const Duration(seconds: 2),
          ),
        );
      }

      if (mounted) {
        // âœ… Verifica antes de setState
        setState(() {});
      }
    } catch (e) {
      print("âŒ Erro ao excluir perfil: $e");
      if (!mounted) return; // âœ… Verifica

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Erro ao excluir: ${e.toString()}'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 4),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    if (_isLoading) {
      return Scaffold(
        backgroundColor: appTema.backgroundColor,
        body: Center(
          child: CircularProgressIndicator(color: const Color(0xFFA9DBF4)),
        ),
      );
    }

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 20),

              Text(
                "Seus Familiares",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),

              const SizedBox(height: 30),

              // Grid de perfis
              Expanded(
                child: GridView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 40),
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 20,
                    mainAxisSpacing: 20,
                  ),
                  itemCount: _perfisFilhos.length + 1,
                  itemBuilder: (context, index) {
                    if (index < _perfisFilhos.length) {
                      return _buildPerfilExistente(
                        _perfisFilhos[index],
                        index,
                        appTema,
                      );
                    } else {
                      return _buildAdicionarPerfil(appTema);
                    }
                  },
                ),
              ),

              // InformaÃ§Ã£o
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Text(
                  'Toque em um perfil para gerenciÃ¡-lo',
                  style: TextStyle(
                    color: appTema.textSecondaryColor,
                    fontSize: 12,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPerfilExistente(
    Map<String, dynamic> perfil,
    int index,
    AppTema appTema,
  ) {
    return GestureDetector(
      onTap: () {
        _mostrarOpcoesPerfi(index, perfil, appTema);
      },
      child: Container(
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.3)
              : Colors.white.withValues(alpha: 0.5),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
            width: 2,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            // Avatar
            Stack(
              children: [
                CircleAvatar(
                  radius: 40,
                  backgroundImage: AssetImage(
                    perfil['avatar'] ?? 'assets/avatar1.png',
                  ),
                ),
                // Badge de opÃ§Ãµes
                Positioned(
                  top: 0,
                  right: 0,
                  child: Container(
                    padding: const EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: Colors.black.withValues(alpha: 0.6),
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      Icons.more_vert,
                      color: Colors.white,
                      size: 16,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),

            // Nome
            Text(
              perfil['apelido'] ?? 'Sem nome',
              style: TextStyle(
                color: appTema.textColor,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAdicionarPerfil(AppTema appTema) {
    // Verifica se jÃ¡ atingiu o limite
    if (_perfisFilhos.length >= 4) {
      return Container(
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.3)
              : Colors.white.withValues(alpha: 0.5),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
            width: 2,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.block,
              size: 50,
              color: appTema.textSecondaryColor.withValues(alpha: 0.3),
            ),
            const SizedBox(height: 12),
            Text(
              'Limite\natingido',
              style: TextStyle(color: appTema.textSecondaryColor, fontSize: 14),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    return GestureDetector(
      onTap: () async {
        await context.push('/avatar-filho');
        // Recarrega os perfis quando voltar
        _carregarPerfis();
      },
      child: Container(
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.3)
              : Colors.white.withValues(alpha: 0.5),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: const Color(0xFFA9DBF4), width: 2),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(color: const Color(0xFFA9DBF4), width: 3),
              ),
              child: const Icon(Icons.add, size: 40, color: Color(0xFFA9DBF4)),
            ),
            const SizedBox(height: 12),
            Text(
              'Adicionar\nFamiliar',
              style: TextStyle(
                color: appTema.textColor,
                fontSize: 14,
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\admin_add_video_screen.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';
import 'video_service_youtube.dart';
import 'video_model_youtube.dart';

class AdminAddVideoScreen extends StatefulWidget {
  const AdminAddVideoScreen({super.key});

  @override
  State<AdminAddVideoScreen> createState() => _AdminAddVideoScreenState();
}

class _AdminAddVideoScreenState extends State<AdminAddVideoScreen> {
  final _formKey = GlobalKey<FormState>();
  final _videoService = VideoServiceYoutube();

  final _tituloController = TextEditingController();
  final _descricaoController = TextEditingController();
  final _youtubeUrlController = TextEditingController();

  final List<String> _todosGeneros = [
    'AÃ§Ã£o',
    'ComÃ©dia',
    'Drama',
    'Terror',
    'FicÃ§Ã£o CientÃ­fica',
    'Romance',
    'AnimaÃ§Ã£o',
    'DocumentÃ¡rio',
  ];

  final List<String> _generosSelecionados = [];
  bool _isLoading = false;

  @override
  void dispose() {
    _tituloController.dispose();
    _descricaoController.dispose();
    _youtubeUrlController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      backgroundColor: appTema.backgroundColor,
      appBar: AppBar(
        backgroundColor: const Color(0xFFA9DBF4),
        foregroundColor: Colors.black,
        title: const Text(
          'Adicionar VÃ­deo do YouTube',
          style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, size: 28),
          onPressed: () => context.pop(),
        ),
        actions: const [
          Padding(
            padding: EdgeInsets.only(right: 16.0),
            child: ThemeToggleButton(),
          ),
        ],
      ),
      body: _isLoading
          ? const Center(
              child: CircularProgressIndicator(color: Color(0xFFA9DBF4)),
            )
          : SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // INSTRUÃ‡Ã•ES
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: const Color(0xFFA9DBF4).withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: const Color(0xFFA9DBF4),
                          width: 2,
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Icon(
                                Icons.info_outline,
                                color: Color(0xFFA9DBF4),
                                size: 24,
                              ),
                              const SizedBox(width: 8),
                              Text(
                                'Como adicionar vÃ­deos:',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                  color: appTema.textColor,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          Text(
                            '1. FaÃ§a upload do vÃ­deo no YouTube\n'
                            '2. Configure como "NÃ£o listado"\n'
                            '3. Copie o link do vÃ­deo\n'
                            '4. Cole abaixo e preencha os dados',
                            style: TextStyle(
                              fontSize: 14,
                              height: 1.5,
                              color: appTema.textSecondaryColor,
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 24),

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CAMPO: LINK DO YOUTUBE
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    _buildLabel('Link do YouTube', appTema),
                    TextFormField(
                      controller: _youtubeUrlController,
                      decoration: InputDecoration(
                        hintText: 'https://www.youtube.com/watch?v=...',
                        hintStyle: TextStyle(color: appTema.textSecondaryColor),
                        filled: true,
                        fillColor: appTema.isDarkMode
                            ? Colors.white.withValues(alpha: 0.1)
                            : Colors.black.withValues(alpha: 0.05),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide.none,
                        ),
                        prefixIcon: const Icon(Icons.link),
                      ),
                      style: TextStyle(color: appTema.textColor),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Cole o link do vÃ­deo do YouTube';
                        }
                        if (VideoModelYoutube.extractYoutubeId(value) == null) {
                          return 'Link do YouTube invÃ¡lido';
                        }
                        return null;
                      },
                    ),

                    const SizedBox(height: 20),

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CAMPO: TÃTULO
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    _buildLabel('TÃ­tulo', appTema),
                    TextFormField(
                      controller: _tituloController,
                      decoration: InputDecoration(
                        hintText: 'Digite o tÃ­tulo do vÃ­deo',
                        hintStyle: TextStyle(color: appTema.textSecondaryColor),
                        filled: true,
                        fillColor: appTema.isDarkMode
                            ? Colors.white.withValues(alpha: 0.1)
                            : Colors.black.withValues(alpha: 0.05),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide.none,
                        ),
                      ),
                      style: TextStyle(color: appTema.textColor),
                      maxLength: 100,
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Digite o tÃ­tulo do vÃ­deo';
                        }
                        return null;
                      },
                    ),

                    const SizedBox(height: 20),

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CAMPO: DESCRIÃ‡ÃƒO
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    _buildLabel('DescriÃ§Ã£o', appTema),
                    TextFormField(
                      controller: _descricaoController,
                      decoration: InputDecoration(
                        hintText: 'Descreva o conteÃºdo do vÃ­deo',
                        hintStyle: TextStyle(color: appTema.textSecondaryColor),
                        filled: true,
                        fillColor: appTema.isDarkMode
                            ? Colors.white.withValues(alpha: 0.1)
                            : Colors.black.withValues(alpha: 0.05),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide.none,
                        ),
                      ),
                      style: TextStyle(color: appTema.textColor),
                      maxLines: 4,
                      maxLength: 500,
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Digite uma descriÃ§Ã£o';
                        }
                        return null;
                      },
                    ),

                    const SizedBox(height: 20),

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // SELEÃ‡ÃƒO DE GÃŠNEROS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    _buildLabel('GÃªneros', appTema),
                    const SizedBox(height: 8),
                    Wrap(
                      spacing: 8,
                      runSpacing: 8,
                      children: _todosGeneros.map((genero) {
                        final isSelected = _generosSelecionados.contains(
                          genero,
                        );
                        return FilterChip(
                          label: Text(genero),
                          selected: isSelected,
                          onSelected: (selected) {
                            setState(() {
                              if (selected) {
                                _generosSelecionados.add(genero);
                              } else {
                                _generosSelecionados.remove(genero);
                              }
                            });
                          },
                          selectedColor: const Color(0xFFA9DBF4),
                          checkmarkColor: Colors.black,
                          labelStyle: TextStyle(
                            color: isSelected
                                ? Colors.black
                                : appTema.textColor,
                            fontWeight: isSelected
                                ? FontWeight.bold
                                : FontWeight.normal,
                          ),
                        );
                      }).toList(),
                    ),

                    if (_generosSelecionados.isEmpty)
                      Padding(
                        padding: const EdgeInsets.only(top: 8),
                        child: Text(
                          'Selecione pelo menos um gÃªnero',
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.red.shade300,
                          ),
                        ),
                      ),

                    const SizedBox(height: 32),

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // BOTÃƒO: ADICIONAR
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton.icon(
                        onPressed: _adicionarVideo,
                        icon: const Icon(Icons.add, size: 24),
                        label: const Text(
                          'Adicionar VÃ­deo',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 4,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGETS AUXILIARES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Widget _buildLabel(String texto, AppTema appTema) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Text(
        texto,
        style: TextStyle(
          fontSize: 16,
          fontWeight: FontWeight.bold,
          color: appTema.textColor,
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AÃ‡Ã•ES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Future<void> _adicionarVideo() async {
    // Validar formulÃ¡rio
    if (!_formKey.currentState!.validate()) {
      return;
    }

    // Validar gÃªneros
    if (_generosSelecionados.isEmpty) {
      _mostrarMensagem('Selecione pelo menos um gÃªnero', erro: true);
      return;
    }

    setState(() => _isLoading = true);

    try {
      // Adicionar vÃ­deo ao Firestore
      final videoId = await _videoService.adicionarVideo(
        titulo: _tituloController.text.trim(),
        descricao: _descricaoController.text.trim(),
        youtubeUrl: _youtubeUrlController.text.trim(),
        generos: _generosSelecionados,
      );

      if (videoId != null) {
        if (!mounted) return;
        _mostrarMensagem('VÃ­deo adicionado com sucesso!');

        // Aguarda um pouco para o usuÃ¡rio ver a mensagem
        await Future.delayed(const Duration(seconds: 1));

        if (!mounted) return;
        context.pop();
      } else {
        _mostrarMensagem('Erro ao adicionar vÃ­deo', erro: true);
      }
    } catch (e) {
      _mostrarMensagem('Erro: $e', erro: true);
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _mostrarMensagem(String mensagem, {bool erro = false}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(mensagem),
        backgroundColor: erro ? Colors.red.shade400 : Colors.green.shade400,
        duration: const Duration(seconds: 3),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\admin_editar_video_screen.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'video_model_youtube.dart';

class AdminEditarVideoScreen extends StatefulWidget {
  final VideoModelYoutube video;

  const AdminEditarVideoScreen({super.key, required this.video});

  @override
  State<AdminEditarVideoScreen> createState() => _AdminEditarVideoScreenState();
}

class _AdminEditarVideoScreenState extends State<AdminEditarVideoScreen> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _tituloController;
  late TextEditingController _descricaoController;
  late List<String> _generosSelecionados;
  bool _isLoading = false;

  final List<String> _generosDisponiveis = [
    'AÃ§Ã£o',
    'ComÃ©dia',
    'Drama',
    'Terror',
    'FicÃ§Ã£o CientÃ­fica',
    'Romance',
    'AnimaÃ§Ã£o',
    'DocumentÃ¡rio',
  ];

  @override
  void initState() {
    super.initState();
    _tituloController = TextEditingController(text: widget.video.titulo);
    _descricaoController = TextEditingController(text: widget.video.descricao);
    _generosSelecionados = List.from(widget.video.generos);
  }

  Future<void> _salvarAlteracoes() async {
    if (!_formKey.currentState!.validate()) return;

    if (_generosSelecionados.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('âš ï¸ Selecione pelo menos um gÃªnero!'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      await FirebaseFirestore.instance
          .collection('videos_youtube')
          .doc(widget.video.id)
          .update({
            'titulo': _tituloController.text.trim(),
            'descricao': _descricaoController.text.trim(),
            'generos': _generosSelecionados,
          });

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('âœ… VÃ­deo atualizado com sucesso!'),
            backgroundColor: Colors.green,
          ),
        );
        Navigator.of(context).pop();
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('âŒ Erro ao salvar alteraÃ§Ãµes: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      backgroundColor: appTema.backgroundColor,
      appBar: AppBar(
        title: const Text(
          'âœï¸ Editar VÃ­deo',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
        backgroundColor: appTema.corSecundaria,
        foregroundColor: Colors.white,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // PREVIEW DO VÃDEO
              Card(
                color: appTema.isDarkMode ? Colors.grey[850] : Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  children: [
                    ClipRRect(
                      borderRadius: const BorderRadius.vertical(
                        top: Radius.circular(12),
                      ),
                      child: Image.network(
                        widget.video.thumbnailUrl,
                        width: double.infinity,
                        height: 200,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: double.infinity,
                            height: 200,
                            color: Colors.grey[700],
                            child: const Icon(
                              Icons.broken_image,
                              size: 50,
                              color: Colors.white54,
                            ),
                          );
                        },
                      ),
                    ),
                    Padding(
                      padding: const EdgeInsets.all(12.0),
                      child: Row(
                        children: [
                          const Icon(Icons.link, size: 16),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              'ID: ${widget.video.youtubeId}',
                              style: TextStyle(
                                fontSize: 12,
                                color: appTema.textColor.withValues(alpha: 0.6),
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // CAMPO TÃTULO
              Text(
                'TÃ­tulo',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),
              const SizedBox(height: 8),
              TextFormField(
                controller: _tituloController,
                style: TextStyle(color: appTema.textColor),
                maxLength: 100,
                decoration: InputDecoration(
                  hintText: 'Digite o tÃ­tulo do vÃ­deo',
                  hintStyle: TextStyle(
                    color: appTema.textColor.withValues(alpha: 0.5),
                  ),
                  filled: true,
                  fillColor: appTema.isDarkMode
                      ? Colors.grey[800]
                      : Colors.grey[200],
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide.none,
                  ),
                  counterStyle: TextStyle(
                    color: appTema.textColor.withValues(alpha: 0.6),
                  ),
                ),
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return 'O tÃ­tulo Ã© obrigatÃ³rio';
                  }
                  if (value.trim().length < 3) {
                    return 'O tÃ­tulo deve ter pelo menos 3 caracteres';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 16),

              // CAMPO DESCRIÃ‡ÃƒO
              Text(
                'DescriÃ§Ã£o',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),
              const SizedBox(height: 8),
              TextFormField(
                controller: _descricaoController,
                style: TextStyle(color: appTema.textColor),
                maxLines: 4,
                maxLength: 500,
                decoration: InputDecoration(
                  hintText: 'Digite uma descriÃ§Ã£o clara e acessÃ­vel',
                  hintStyle: TextStyle(
                    color: appTema.textColor.withValues(alpha: 0.5),
                  ),
                  filled: true,
                  fillColor: appTema.isDarkMode
                      ? Colors.grey[800]
                      : Colors.grey[200],
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide.none,
                  ),
                  counterStyle: TextStyle(
                    color: appTema.textColor.withValues(alpha: 0.6),
                  ),
                ),
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return 'A descriÃ§Ã£o Ã© obrigatÃ³ria';
                  }
                  if (value.trim().length < 10) {
                    return 'A descriÃ§Ã£o deve ter pelo menos 10 caracteres';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 24),

              // SELEÃ‡ÃƒO DE GÃŠNEROS
              Text(
                'GÃªneros',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 12,
                runSpacing: 12,
                children: _generosDisponiveis.map((genero) {
                  final isSelected = _generosSelecionados.contains(genero);
                  return FilterChip(
                    label: Text(
                      genero,
                      style: TextStyle(
                        color: isSelected ? Colors.white : appTema.textColor,
                        fontWeight: isSelected
                            ? FontWeight.bold
                            : FontWeight.normal,
                      ),
                    ),
                    selected: isSelected,
                    onSelected: (selected) {
                      setState(() {
                        if (selected) {
                          _generosSelecionados.add(genero);
                        } else {
                          _generosSelecionados.remove(genero);
                        }
                      });
                    },
                    backgroundColor: appTema.isDarkMode
                        ? Colors.grey[800]
                        : Colors.grey[200],
                    selectedColor: appTema.corSecundaria,
                    checkmarkColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(20),
                      side: BorderSide(
                        color: isSelected
                            ? appTema.corSecundaria
                            : appTema.textColor.withValues(alpha: 0.3),
                        width: 1.5,
                      ),
                    ),
                  );
                }).toList(),
              ),

              const SizedBox(height: 32),

              // BOTÃƒO SALVAR
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _salvarAlteracoes,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: appTema.corSecundaria,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                  ),
                  child: _isLoading
                      ? const CircularProgressIndicator(
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Colors.white,
                          ),
                        )
                      : const Text(
                          'ðŸ’¾ Salvar AlteraÃ§Ãµes',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),

              const SizedBox(height: 16),

              // BOTÃƒO CANCELAR
              SizedBox(
                width: double.infinity,
                height: 56,
                child: OutlinedButton(
                  onPressed: _isLoading
                      ? null
                      : () => Navigator.of(context).pop(),
                  style: OutlinedButton.styleFrom(
                    foregroundColor: appTema.corSecundaria,
                    side: BorderSide(color: appTema.corSecundaria, width: 2),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Text(
                    'Cancelar',
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _tituloController.dispose();
    _descricaoController.dispose();
    super.dispose();
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\admin_gerenciar_videos_screen.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:provider/provider.dart';
import 'package:go_router/go_router.dart';
import 'app_tema.dart';
import 'video_model_youtube.dart';
import 'admin_editar_video_screen.dart';

class AdminGerenciarVideosScreen extends StatefulWidget {
  const AdminGerenciarVideosScreen({super.key});

  @override
  State<AdminGerenciarVideosScreen> createState() =>
      _AdminGerenciarVideosScreenState();
}

class _AdminGerenciarVideosScreenState
    extends State<AdminGerenciarVideosScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';
  String? _generoFiltro;
  bool _mostrarApenasInativos = false;

  final List<String> _generos = [
    'Todos',
    'AÃ§Ã£o',
    'ComÃ©dia',
    'Drama',
    'Terror',
    'FicÃ§Ã£o CientÃ­fica',
    'Romance',
    'AnimaÃ§Ã£o',
    'DocumentÃ¡rio',
  ];

  @override
  void initState() {
    super.initState();
    _verificarPermissaoAdmin();
  }

  Future<void> _verificarPermissaoAdmin() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) {
      if (mounted) {
        context.go('/login');
        return;
      }
    }

    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user!.uid)
          .get();

      final tipoUsuario = userDoc.data()?['tipoUsuario'] ?? 'usuario';

      if (tipoUsuario != 'admin') {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('âŒ Acesso negado! Apenas admins podem acessar.'),
              backgroundColor: Colors.red,
            ),
          );
          context.go('/catalogo');
        }
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Erro ao verificar permissÃµes: $e'),
            backgroundColor: Colors.red,
          ),
        );
        context.go('/catalogo');
      }
    }
  }

  Stream<QuerySnapshot> _getVideosStream() {
    Query query = FirebaseFirestore.instance.collection('videos_youtube');

    // Filtro por gÃªnero
    if (_generoFiltro != null && _generoFiltro != 'Todos') {
      query = query.where('generos', arrayContains: _generoFiltro);
    }

    // Filtro por status (ativo/inativo)
    if (_mostrarApenasInativos) {
      query = query.where('ativo', isEqualTo: false);
    }

    // Ordenar por data de upload
    query = query.orderBy('dataUpload', descending: true);

    return query.snapshots();
  }

  List<VideoModelYoutube> _filtrarPorBusca(List<VideoModelYoutube> videos) {
    if (_searchQuery.isEmpty) return videos;

    return videos.where((video) {
      final tituloMatch = video.titulo.toLowerCase().contains(
        _searchQuery.toLowerCase(),
      );
      final descricaoMatch = video.descricao.toLowerCase().contains(
        _searchQuery.toLowerCase(),
      );
      return tituloMatch || descricaoMatch;
    }).toList();
  }

  Future<void> _toggleStatusVideo(VideoModelYoutube video) async {
    try {
      await FirebaseFirestore.instance
          .collection('videos_youtube')
          .doc(video.id)
          .update({'ativo': !video.ativo});

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              video.ativo
                  ? 'âœ… VÃ­deo desativado com sucesso!'
                  : 'âœ… VÃ­deo ativado com sucesso!',
            ),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('âŒ Erro ao alterar status: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _confirmarExclusao(VideoModelYoutube video) async {
    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('âš ï¸ Confirmar ExclusÃ£o'),
        content: Text(
          'Tem certeza que deseja excluir o vÃ­deo "${video.titulo}"?\n\n'
          'Esta aÃ§Ã£o Ã© irreversÃ­vel!',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: const Text('Cancelar'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.of(context).pop(true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Excluir'),
          ),
        ],
      ),
    );

    if (confirmar == true) {
      await _excluirVideo(video);
    }
  }

  Future<void> _excluirVideo(VideoModelYoutube video) async {
    try {
      await FirebaseFirestore.instance
          .collection('videos_youtube')
          .doc(video.id)
          .delete();

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('âœ… VÃ­deo excluÃ­do com sucesso!'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('âŒ Erro ao excluir vÃ­deo: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  void _navegarParaEdicao(VideoModelYoutube video) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => AdminEditarVideoScreen(video: video),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      backgroundColor: appTema.backgroundColor,
      appBar: AppBar(
        title: const Text(
          'ðŸŽ¬ Gerenciar VÃ­deos',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
        backgroundColor: appTema.corSecundaria,
        foregroundColor: Colors.white,
        actions: [
          IconButton(
            icon: const Icon(Icons.add_circle),
            tooltip: 'Adicionar VÃ­deo',
            onPressed: () => context.push('/admin/adicionar-video'),
          ),
        ],
      ),
      body: Column(
        children: [
          // ðŸ” BARRA DE BUSCA
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: TextField(
              controller: _searchController,
              style: TextStyle(color: appTema.textColor),
              decoration: InputDecoration(
                hintText: 'Buscar por tÃ­tulo ou descriÃ§Ã£o...',
                hintStyle: TextStyle(
                  color: appTema.textColor.withValues(alpha: 0.6),
                ),
                prefixIcon: Icon(Icons.search, color: appTema.corSecundaria),
                suffixIcon: _searchQuery.isNotEmpty
                    ? IconButton(
                        icon: const Icon(Icons.clear),
                        onPressed: () {
                          setState(() {
                            _searchController.clear();
                            _searchQuery = '';
                          });
                        },
                      )
                    : null,
                filled: true,
                fillColor: appTema.isDarkMode
                    ? Colors.grey[800]
                    : Colors.grey[200],
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(30),
                  borderSide: BorderSide.none,
                ),
              ),
              onChanged: (value) {
                setState(() => _searchQuery = value);
              },
            ),
          ),

          // ðŸŽ¯ FILTROS
          SingleChildScrollView(
            scrollDirection: Axis.horizontal,
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: Row(
              children: [
                // Filtro de GÃªnero
                DropdownButton<String>(
                  value: _generoFiltro ?? 'Todos',
                  dropdownColor: appTema.isDarkMode
                      ? Colors.grey[800]
                      : Colors.grey[200],
                  style: TextStyle(color: appTema.textColor),
                  items: _generos.map((genero) {
                    return DropdownMenuItem(value: genero, child: Text(genero));
                  }).toList(),
                  onChanged: (value) {
                    setState(() {
                      _generoFiltro = value == 'Todos' ? null : value;
                    });
                  },
                ),

                const SizedBox(width: 16),

                // Filtro de Status (Inativos)
                FilterChip(
                  label: Text(
                    'Apenas Inativos',
                    style: TextStyle(color: appTema.textColor),
                  ),
                  selected: _mostrarApenasInativos,
                  onSelected: (selected) {
                    setState(() => _mostrarApenasInativos = selected);
                  },
                  backgroundColor: appTema.isDarkMode
                      ? Colors.grey[800]
                      : Colors.grey[200],
                  selectedColor: Colors.orange.withValues(alpha: 0.3),
                ),
              ],
            ),
          ),

          const SizedBox(height: 16),

          // ðŸ“‹ LISTA DE VÃDEOS
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: _getVideosStream(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(child: CircularProgressIndicator());
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Text(
                      'âŒ Erro ao carregar vÃ­deos:\n${snapshot.error}',
                      style: TextStyle(color: appTema.textColor),
                      textAlign: TextAlign.center,
                    ),
                  );
                }

                if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.video_library_outlined,
                          size: 100,
                          color: appTema.textColor.withValues(alpha: 0.3),
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Nenhum vÃ­deo encontrado',
                          style: TextStyle(
                            fontSize: 18,
                            color: appTema.textColor.withValues(alpha: 0.6),
                          ),
                        ),
                      ],
                    ),
                  );
                }

                // Converter documentos em VideoModelYoutube
                List<VideoModelYoutube> videos = snapshot.data!.docs
                    .map((doc) => VideoModelYoutube.fromFirestore(doc))
                    .toList();

                // Aplicar filtro de busca
                videos = _filtrarPorBusca(videos);

                if (videos.isEmpty) {
                  return Center(
                    child: Text(
                      'ðŸ” Nenhum resultado encontrado para "$_searchQuery"',
                      style: TextStyle(
                        fontSize: 16,
                        color: appTema.textColor.withValues(alpha: 0.6),
                      ),
                    ),
                  );
                }

                return ListView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  itemCount: videos.length,
                  itemBuilder: (context, index) {
                    final video = videos[index];
                    return _buildVideoCard(video, appTema);
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildVideoCard(VideoModelYoutube video, AppTema appTema) {
    return Card(
      margin: const EdgeInsets.only(bottom: 16),
      color: appTema.isDarkMode ? Colors.grey[850] : Colors.white,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // THUMBNAIL
          Stack(
            children: [
              ClipRRect(
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(12),
                ),
                child: Image.network(
                  video.thumbnailUrl,
                  width: double.infinity,
                  height: 200,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      width: double.infinity,
                      height: 200,
                      color: Colors.grey[700],
                      child: const Icon(
                        Icons.broken_image,
                        size: 50,
                        color: Colors.white54,
                      ),
                    );
                  },
                ),
              ),

              // Badge de Status
              Positioned(
                top: 8,
                right: 8,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: BoxDecoration(
                    color: video.ativo ? Colors.green : Colors.red,
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Text(
                    video.ativo ? 'âœ“ ATIVO' : 'âœ— INATIVO',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  ),
                ),
              ),
            ],
          ),

          // INFORMAÃ‡Ã•ES
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // TÃ­tulo
                Text(
                  video.titulo,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: appTema.textColor,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),

                const SizedBox(height: 8),

                // DescriÃ§Ã£o
                Text(
                  video.descricao,
                  style: TextStyle(
                    fontSize: 14,
                    color: appTema.textColor.withValues(alpha: 0.7),
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),

                const SizedBox(height: 12),

                // GÃªneros
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: video.generos.map((genero) {
                    return Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 6,
                      ),
                      decoration: BoxDecoration(
                        color: appTema.corSecundaria.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                        border: Border.all(
                          color: appTema.corSecundaria,
                          width: 1,
                        ),
                      ),
                      child: Text(
                        genero,
                        style: TextStyle(
                          color: appTema.corSecundaria,
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    );
                  }).toList(),
                ),

                const SizedBox(height: 16),

                // BOTÃ•ES DE AÃ‡ÃƒO
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [
                    // Ativar/Desativar
                    Expanded(
                      child: ElevatedButton.icon(
                        onPressed: () => _toggleStatusVideo(video),
                        icon: Icon(
                          video.ativo ? Icons.visibility_off : Icons.visibility,
                          size: 18,
                        ),
                        label: Text(
                          video.ativo ? 'Desativar' : 'Ativar',
                          style: const TextStyle(fontSize: 12),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: video.ativo
                              ? Colors.orange
                              : Colors.green,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 10),
                        ),
                      ),
                    ),

                    const SizedBox(width: 8),

                    // Editar
                    Expanded(
                      child: ElevatedButton.icon(
                        onPressed: () => _navegarParaEdicao(video),
                        icon: const Icon(Icons.edit, size: 18),
                        label: const Text(
                          'Editar',
                          style: TextStyle(fontSize: 12),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.blue,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 10),
                        ),
                      ),
                    ),

                    const SizedBox(width: 8),

                    // Excluir
                    Expanded(
                      child: ElevatedButton.icon(
                        onPressed: () => _confirmarExclusao(video),
                        icon: const Icon(Icons.delete, size: 18),
                        label: const Text(
                          'Excluir',
                          style: TextStyle(fontSize: 12),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.red,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 10),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\admin_listar_videos_screen.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';
import 'video_service_youtube.dart';
import 'video_model_youtube.dart';

class AdminListarVideosScreen extends StatefulWidget {
  const AdminListarVideosScreen({super.key});

  @override
  State<AdminListarVideosScreen> createState() =>
      _AdminListarVideosScreenState();
}

class _AdminListarVideosScreenState extends State<AdminListarVideosScreen> {
  final VideoServiceYoutube _videoService = VideoServiceYoutube();
  List<VideoModelYoutube> _todosVideos = [];
  List<VideoModelYoutube> _videosFiltrados = [];
  bool _isLoading = true;
  String _filtroAtual = 'Todos'; // Todos, Ativos, Inativos
  final TextEditingController _buscaController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _carregarVideos();
  }

  @override
  void dispose() {
    _buscaController.dispose();
    super.dispose();
  }

  Future<void> _carregarVideos() async {
    setState(() => _isLoading = true);

    try {
      // Busca TODOS os vÃ­deos (ativos e inativos) para admin gerenciar
      final videos = await _videoService.buscarTodosVideos();

      setState(() {
        _todosVideos = videos;
        _aplicarFiltros();
        _isLoading = false;
      });

      print('ðŸ“¹ ${videos.length} vÃ­deos carregados');
    } catch (e) {
      print('âŒ Erro ao carregar vÃ­deos: $e');
      setState(() => _isLoading = false);
    }
  }

  void _aplicarFiltros() {
    List<VideoModelYoutube> resultado = List.from(_todosVideos);

    // Filtro por status
    if (_filtroAtual == 'Ativos') {
      resultado = resultado.where((v) => v.ativo).toList();
    } else if (_filtroAtual == 'Inativos') {
      resultado = resultado.where((v) => !v.ativo).toList();
    }

    // Filtro por busca
    final busca = _buscaController.text.toLowerCase();
    if (busca.isNotEmpty) {
      resultado = resultado.where((v) {
        return v.titulo.toLowerCase().contains(busca) ||
            v.descricao.toLowerCase().contains(busca) ||
            v.generos.any((g) => g.toLowerCase().contains(busca));
      }).toList();
    }

    setState(() {
      _videosFiltrados = resultado;
    });
  }

  Future<void> _toggleStatusVideo(VideoModelYoutube video) async {
    final novoStatus = !video.ativo;

    try {
      final sucesso = await _videoService.atualizarVideo(
        videoId: video.id,
        ativo: novoStatus,
      );

      if (sucesso) {
        _mostrarMensagem(
          novoStatus ? 'VÃ­deo ativado!' : 'VÃ­deo desativado!',
          sucesso: true,
        );
        _carregarVideos(); // Recarrega a lista
      } else {
        _mostrarMensagem('Erro ao alterar status', sucesso: false);
      }
    } catch (e) {
      _mostrarMensagem('Erro: $e', sucesso: false);
    }
  }

  Future<void> _confirmarExclusao(VideoModelYoutube video) async {
    final appTema = Provider.of<AppTema>(context, listen: false);

    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
          side: BorderSide(color: Colors.red.withValues(alpha: 0.5), width: 2),
        ),
        title: Row(
          children: [
            const Icon(
              Icons.warning_amber_rounded,
              color: Colors.red,
              size: 28,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                'Excluir VÃ­deo',
                style: TextStyle(color: appTema.textColor),
              ),
            ),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Tem certeza que deseja excluir:',
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
            const SizedBox(height: 12),
            Text(
              '"${video.titulo}"',
              style: TextStyle(
                color: appTema.textColor,
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
            const SizedBox(height: 12),
            Text(
              'Esta aÃ§Ã£o nÃ£o pode ser desfeita!',
              style: TextStyle(
                color: Colors.red[300],
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              'Cancelar',
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: const Text('Excluir'),
          ),
        ],
      ),
    );

    if (confirmar == true) {
      await _excluirVideo(video);
    }
  }

  Future<void> _excluirVideo(VideoModelYoutube video) async {
    try {
      final sucesso = await _videoService.excluirVideo(video.id);

      if (sucesso) {
        _mostrarMensagem('VÃ­deo excluÃ­do com sucesso!', sucesso: true);
        _carregarVideos(); // Recarrega a lista
      } else {
        _mostrarMensagem('Erro ao excluir vÃ­deo', sucesso: false);
      }
    } catch (e) {
      _mostrarMensagem('Erro: $e', sucesso: false);
    }
  }

  void _mostrarMensagem(String mensagem, {required bool sucesso}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(mensagem),
        backgroundColor: sucesso ? Colors.green : Colors.red,
        duration: const Duration(seconds: 2),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      backgroundColor: appTema.backgroundColor,
      appBar: AppBar(
        backgroundColor: const Color(0xFFA9DBF4),
        foregroundColor: Colors.black,
        title: const Text(
          'Gerenciar VÃ­deos',
          style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, size: 28),
          onPressed: () => context.pop(),
        ),
        actions: const [
          Padding(
            padding: EdgeInsets.only(right: 16.0),
            child: ThemeToggleButton(),
          ),
        ],
      ),
      body: _isLoading
          ? const Center(
              child: CircularProgressIndicator(color: Color(0xFFA9DBF4)),
            )
          : Column(
              children: [
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // HEADER: BUSCA E FILTROS
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: appTema.isDarkMode
                        ? Colors.grey[900]
                        : Colors.grey[100],
                    border: Border(
                      bottom: BorderSide(
                        color: appTema.isDarkMode
                            ? Colors.white24
                            : Colors.black12,
                      ),
                    ),
                  ),
                  child: Column(
                    children: [
                      // Campo de busca
                      TextField(
                        controller: _buscaController,
                        onChanged: (_) => _aplicarFiltros(),
                        style: TextStyle(color: appTema.textColor),
                        decoration: InputDecoration(
                          hintText: 'Buscar por tÃ­tulo, descriÃ§Ã£o ou gÃªnero...',
                          hintStyle: TextStyle(
                            color: appTema.textSecondaryColor,
                          ),
                          prefixIcon: Icon(
                            Icons.search,
                            color: appTema.textSecondaryColor,
                          ),
                          suffixIcon: _buscaController.text.isNotEmpty
                              ? IconButton(
                                  icon: Icon(
                                    Icons.clear,
                                    color: appTema.textSecondaryColor,
                                  ),
                                  onPressed: () {
                                    _buscaController.clear();
                                    _aplicarFiltros();
                                  },
                                )
                              : null,
                          filled: true,
                          fillColor: appTema.isDarkMode
                              ? Colors.grey[800]
                              : Colors.white,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12),
                            borderSide: BorderSide.none,
                          ),
                        ),
                      ),

                      const SizedBox(height: 12),

                      // Filtros de status
                      Row(
                        children: [
                          Expanded(child: _buildFiltroChip('Todos', appTema)),
                          const SizedBox(width: 8),
                          Expanded(child: _buildFiltroChip('Ativos', appTema)),
                          const SizedBox(width: 8),
                          Expanded(
                            child: _buildFiltroChip('Inativos', appTema),
                          ),
                        ],
                      ),

                      const SizedBox(height: 12),

                      // Contador e botÃ£o adicionar
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            '${_videosFiltrados.length} vÃ­deo(s)',
                            style: TextStyle(
                              color: appTema.textSecondaryColor,
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          ElevatedButton.icon(
                            onPressed: () async {
                              await context.push('/admin-add-video');
                              _carregarVideos(); // Recarrega apÃ³s adicionar
                            },
                            icon: const Icon(Icons.add, size: 20),
                            label: const Text('Novo VÃ­deo'),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: const Color(0xFFA9DBF4),
                              foregroundColor: Colors.black,
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 10,
                              ),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // LISTA DE VÃDEOS
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Expanded(
                  child: _videosFiltrados.isEmpty
                      ? _buildEstadoVazio(appTema)
                      : RefreshIndicator(
                          onRefresh: _carregarVideos,
                          color: const Color(0xFFA9DBF4),
                          child: ListView.builder(
                            padding: const EdgeInsets.all(16),
                            itemCount: _videosFiltrados.length,
                            itemBuilder: (context, index) {
                              final video = _videosFiltrados[index];
                              return _buildVideoCard(video, appTema);
                            },
                          ),
                        ),
                ),
              ],
            ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGETS AUXILIARES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Widget _buildFiltroChip(String filtro, AppTema appTema) {
    final isSelected = _filtroAtual == filtro;

    return GestureDetector(
      onTap: () {
        setState(() {
          _filtroAtual = filtro;
          _aplicarFiltros();
        });
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 8),
        decoration: BoxDecoration(
          color: isSelected
              ? const Color(0xFFA9DBF4)
              : (appTema.isDarkMode ? Colors.grey[800] : Colors.white),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: isSelected
                ? const Color(0xFFA9DBF4)
                : (appTema.isDarkMode ? Colors.white24 : Colors.black12),
            width: isSelected ? 2 : 1,
          ),
        ),
        child: Text(
          filtro,
          textAlign: TextAlign.center,
          style: TextStyle(
            color: isSelected ? Colors.black : appTema.textColor,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
            fontSize: 14,
          ),
        ),
      ),
    );
  }

  Widget _buildEstadoVazio(AppTema appTema) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.video_library_outlined,
            size: 80,
            color: appTema.textSecondaryColor,
          ),
          const SizedBox(height: 16),
          Text(
            'Nenhum vÃ­deo encontrado',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: appTema.textColor,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            _buscaController.text.isNotEmpty
                ? 'Tente uma busca diferente'
                : 'Adicione vÃ­deos para comeÃ§ar',
            style: TextStyle(fontSize: 16, color: appTema.textSecondaryColor),
          ),
          const SizedBox(height: 24),
          ElevatedButton.icon(
            onPressed: () async {
              await context.push('/admin-add-video');
              _carregarVideos();
            },
            icon: const Icon(Icons.add),
            label: const Text('Adicionar Primeiro VÃ­deo'),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFA9DBF4),
              foregroundColor: Colors.black,
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildVideoCard(VideoModelYoutube video, AppTema appTema) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: appTema.isDarkMode
            ? Colors.grey[900]?.withValues(alpha: 0.5)
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: video.ativo
              ? (appTema.isDarkMode ? Colors.white24 : Colors.black12)
              : Colors.orange.withValues(alpha: 0.5),
          width: video.ativo ? 1 : 2,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Thumbnail
          ClipRRect(
            borderRadius: const BorderRadius.only(
              topLeft: Radius.circular(12),
              topRight: Radius.circular(12),
            ),
            child: Stack(
              children: [
                Image.network(
                  video.thumbnailUrl,
                  width: double.infinity,
                  height: 180,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      width: double.infinity,
                      height: 180,
                      color: Colors.grey.shade800,
                      child: const Icon(
                        Icons.video_library,
                        size: 60,
                        color: Colors.white54,
                      ),
                    );
                  },
                ),
                // Badge de status
                if (!video.ativo)
                  Positioned(
                    top: 12,
                    right: 12,
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 6,
                      ),
                      decoration: BoxDecoration(
                        color: Colors.orange,
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: const Text(
                        'INATIVO',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
              ],
            ),
          ),

          // InformaÃ§Ãµes
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // TÃ­tulo
                Text(
                  video.titulo,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: appTema.textColor,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),

                const SizedBox(height: 8),

                // DescriÃ§Ã£o
                Text(
                  video.descricao,
                  style: TextStyle(
                    fontSize: 14,
                    color: appTema.textSecondaryColor,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),

                const SizedBox(height: 12),

                // GÃªneros
                Wrap(
                  spacing: 6,
                  runSpacing: 6,
                  children: video.generos.map((genero) {
                    return Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 10,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: const Color(0xFFA9DBF4).withValues(alpha: 0.3),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: const Color(0xFFA9DBF4),
                          width: 1,
                        ),
                      ),
                      child: Text(
                        genero,
                        style: TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                          color: appTema.textColor,
                        ),
                      ),
                    );
                  }).toList(),
                ),

                const SizedBox(height: 16),

                // BotÃµes de aÃ§Ã£o
                Row(
                  children: [
                    // BotÃ£o Ativar/Desativar
                    Expanded(
                      child: OutlinedButton.icon(
                        onPressed: () => _toggleStatusVideo(video),
                        icon: Icon(
                          video.ativo ? Icons.visibility_off : Icons.visibility,
                          size: 18,
                        ),
                        label: Text(
                          video.ativo ? 'Desativar' : 'Ativar',
                          style: const TextStyle(fontSize: 14),
                        ),
                        style: OutlinedButton.styleFrom(
                          foregroundColor: video.ativo
                              ? Colors.orange
                              : Colors.green,
                          side: BorderSide(
                            color: video.ativo ? Colors.orange : Colors.green,
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 10),
                        ),
                      ),
                    ),

                    const SizedBox(width: 8),

                    // BotÃ£o Excluir
                    Expanded(
                      child: OutlinedButton.icon(
                        onPressed: () => _confirmarExclusao(video),
                        icon: const Icon(Icons.delete_outline, size: 18),
                        label: const Text(
                          'Excluir',
                          style: TextStyle(fontSize: 14),
                        ),
                        style: OutlinedButton.styleFrom(
                          foregroundColor: Colors.red,
                          side: const BorderSide(color: Colors.red),
                          padding: const EdgeInsets.symmetric(vertical: 10),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\apelido.dart
// ========================================
import 'widgets/theme_toggle_button.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';

class ApelidoScreen extends StatefulWidget {
  final String selectedAvatar;
  const ApelidoScreen({super.key, required this.selectedAvatar});

  @override
  State<ApelidoScreen> createState() => _ApelidoScreenState();
}

class _ApelidoScreenState extends State<ApelidoScreen> {
  final TextEditingController _apelidoController = TextEditingController();
  bool _isLoading = false;

  @override
  void dispose() {
    _apelidoController.dispose();
    super.dispose();
  }

  Future<void> _salvarApelido() async {
    final apelido = _apelidoController.text.trim();

    if (apelido.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Por favor, insira um apelido')),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;

      if (user != null) {
        await FirebaseFirestore.instance.collection('users').doc(user.uid).set({
          'uid': user.uid,
          'email': user.email,
          'apelido': apelido,
          'avatar': widget.selectedAvatar,
          'createdAt': FieldValue.serverTimestamp(),
        }, SetOptions(merge: true));

        print("Dados salvos no Firestore com sucesso!");

        if (!mounted) return;
        // O usuÃ¡rio que acabou de se cadastrar Ã© SEMPRE perfil pai
        context.push(
          '/criapin',
          extra: {
            'apelido': _apelidoController.text.trim(),
            'avatar': widget.selectedAvatar,
          },
        );
      }
    } catch (e) {
      print("Erro ao salvar dados: $e");
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Erro ao salvar: ${e.toString()}'),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Column(
              children: [
                // AppBar
                Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… CORRIGIDO
                  ],
                ),

                const Spacer(),

                // Avatar escolhido
                CircleAvatar(
                  radius: 60,
                  backgroundImage: AssetImage(widget.selectedAvatar),
                ),
                const SizedBox(height: 30),

                Text(
                  "Digite seu apelido",
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: appTema.textColor,
                  ),
                ),
                const SizedBox(height: 20),

                // Campo de apelido
                SizedBox(
                  width: 300,
                  child: TextField(
                    controller: _apelidoController,
                    textAlign: TextAlign.center,
                    style: TextStyle(color: appTema.textColor, fontSize: 18),
                    decoration: InputDecoration(
                      hintText: "Seu apelido",
                      hintStyle: TextStyle(
                        color: appTema.textColor.withValues(alpha: 0.5),
                      ),
                      filled: true,
                      fillColor: appTema.isDarkMode
                          ? Colors.white.withValues(alpha: 0.1)
                          : Colors.white.withValues(alpha: 0.8),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                    ),
                  ),
                ),

                const Spacer(),

                // BotÃµes
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : () => context.pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey[300],
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("Voltar"),
                      ),
                    ),
                    const SizedBox(width: 20),
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _salvarApelido,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  color: Colors.black,
                                  strokeWidth: 2.5,
                                ),
                              )
                            : const Text("Prosseguir"),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\apelido_filho.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';

class ApelidoFilhoScreen extends StatefulWidget {
  final String selectedAvatar;
  const ApelidoFilhoScreen({super.key, required this.selectedAvatar});

  @override
  State<ApelidoFilhoScreen> createState() => _ApelidoFilhoScreenState();
}

class _ApelidoFilhoScreenState extends State<ApelidoFilhoScreen> {
  final TextEditingController _apelidoController = TextEditingController();

  @override
  void dispose() {
    _apelidoController.dispose();
    super.dispose();
  }

  void _navegarParaPreferencias() {
    final apelido = _apelidoController.text.trim();

    if (apelido.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Por favor, insira um apelido'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Navega para a tela de preferÃªncias passando os dados
    context.push(
      '/preferencias-filho',
      extra: {
        'apelido': apelido,
        'avatar': widget.selectedAvatar,
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Column(
              children: [
                // AppBar
                Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Row(
                    children: [
                      Image.asset("assets/logo.png", height: 40),
                      const Spacer(),
                      const ThemeToggleButton(showLogo: false),
                      IconButton(
                        onPressed: () => context.pop(),
                        icon: Icon(
                          Icons.close,
                          color: appTema.textColor,
                          size: 28,
                        ),
                      ),
                    ],
                  ),
                ),

                const Spacer(),

                // Avatar escolhido
                CircleAvatar(
                  radius: 60,
                  backgroundImage: AssetImage(widget.selectedAvatar),
                ),
                const SizedBox(height: 30),

                Text(
                  "Digite o apelido",
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: appTema.textColor,
                  ),
                ),
                const SizedBox(height: 20),

                // Campo de apelido
                SizedBox(
                  width: 300,
                  child: TextField(
                    controller: _apelidoController,
                    textAlign: TextAlign.center,
                    style: TextStyle(color: appTema.textColor, fontSize: 18),
                    decoration: InputDecoration(
                      hintText: "Apelido do familiar",
                      hintStyle: TextStyle(
                        color: appTema.textColor.withValues(alpha: 0.5),
                      ),
                      filled: true,
                      fillColor: appTema.isDarkMode
                          ? Colors.white.withValues(alpha: 0.1)
                          : Colors.white.withValues(alpha: 0.8),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                    ),
                  ),
                ),

                const Spacer(),

                // BotÃµes
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: () => context.pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey[300],
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("Voltar"),
                      ),
                    ),
                    const SizedBox(width: 20),
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _navegarParaPreferencias,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("PrÃ³ximo"),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\app_tema.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class AppTema extends ChangeNotifier {
  bool _isDarkMode = false;

  bool get isDarkMode => _isDarkMode;

  String get backgroundImage => _isDarkMode
      ? 'assets/night_background.png'
      : 'assets/morning_background.png';

  Color get textColor => _isDarkMode ? Colors.white : Colors.black;

  Color get textSecondaryColor => _isDarkMode ? Colors.white70 : Colors.black54;

  Color get backgroundColor => _isDarkMode ? Colors.black : Colors.white;

  // Adicionando a propriedade corSecundaria que estava faltando
  Color get corSecundaria => _isDarkMode
      ? const Color(0xFF1E88E5) // Azul para tema escuro
      : const Color(0xFF1976D2); // Azul mais escuro para tema claro

  // Carregar preferÃªncia salva do SharedPreferences
  Future<void> loadTheme() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final savedTheme = prefs.getBool('isDarkMode');

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸŽ¨ CARREGANDO TEMA");
      print("   SharedPreferences: $savedTheme");

      if (savedTheme != null) {
        _isDarkMode = savedTheme;
        print(
          "   âœ… Tema carregado do SharedPreferences: ${_isDarkMode ? 'Escuro' : 'Claro'}",
        );
      } else {
        print("   âš ï¸ Nenhum tema no SharedPreferences");
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      notifyListeners();
    } catch (e) {
      print("âŒ ERRO ao carregar tema: $e");
    }
  }

  // Carregar tema do Firestore (chamado apÃ³s login)
  Future<void> loadThemeFromFirestore() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        print(
          "âš ï¸ UsuÃ¡rio nÃ£o autenticado, nÃ£o Ã© possÃ­vel carregar tema do Firestore",
        );
        return;
      }

      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .get();

      if (userDoc.exists) {
        final temaFirestore = userDoc.data()?['temaDark'] as bool?;

        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        print("ðŸŽ¨ CARREGANDO TEMA DO FIRESTORE");
        print("   Firestore: $temaFirestore");

        if (temaFirestore != null) {
          _isDarkMode = temaFirestore;

          // Salva no SharedPreferences tambÃ©m para sincronizar
          final prefs = await SharedPreferences.getInstance();
          await prefs.setBool('isDarkMode', _isDarkMode);

          print("   âœ… Tema sincronizado: ${_isDarkMode ? 'Escuro' : 'Claro'}");
          notifyListeners();
        } else {
          print("   âš ï¸ Nenhuma preferÃªncia de tema no Firestore");
        }

        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      } else {
        print("   âš ï¸ Documento do usuÃ¡rio nÃ£o encontrado no Firestore");
      }
    } catch (e) {
      print("âŒ ERRO ao carregar tema do Firestore: $e");
    }
  }

  // Alternar e salvar (SharedPreferences + Firestore)
  Future<void> toggleTheme() async {
    try {
      _isDarkMode = !_isDarkMode;

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸŽ¨ ALTERNANDO TEMA");
      print("   Novo tema: ${_isDarkMode ? 'Escuro' : 'Claro'}");

      // Salva no SharedPreferences
      final prefs = await SharedPreferences.getInstance();
      final resultLocal = await prefs.setBool('isDarkMode', _isDarkMode);
      print("   âœ… Salvo no SharedPreferences: $resultLocal");

      // Salva no Firestore se estiver logado
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        await FirebaseFirestore.instance.collection('users').doc(user.uid).set({
          'temaDark': _isDarkMode,
        }, SetOptions(merge: true));
        print("   âœ… Salvo no Firestore");
      } else {
        print("   âš ï¸ UsuÃ¡rio nÃ£o logado, salvou apenas localmente");
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      notifyListeners();
    } catch (e) {
      print("âŒ ERRO ao alternar tema: $e");
      // Mesmo com erro, notifica para atualizar a UI
      notifyListeners();
    }
  }

  // Definir e salvar
  Future<void> setDarkMode(bool value) async {
    try {
      _isDarkMode = value;

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸŽ¨ DEFININDO TEMA");
      print("   Valor: ${value ? 'Escuro' : 'Claro'}");

      // Salva no SharedPreferences
      final prefs = await SharedPreferences.getInstance();
      await prefs.setBool('isDarkMode', _isDarkMode);
      print("   âœ… Salvo no SharedPreferences");

      // Salva no Firestore se estiver logado
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        await FirebaseFirestore.instance.collection('users').doc(user.uid).set({
          'temaDark': _isDarkMode,
        }, SetOptions(merge: true));
        print("   âœ… Salvo no Firestore");
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      notifyListeners();
    } catch (e) {
      print("âŒ ERRO ao definir tema: $e");
      notifyListeners();
    }
  }

  // Limpar tema (Ãºtil para testes/debug)
  Future<void> clearTheme() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove('isDarkMode');
      _isDarkMode = false;

      print("ðŸ—‘ï¸ Tema limpo do SharedPreferences");

      // Remove do Firestore tambÃ©m se estiver logado
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .update({'temaDark': FieldValue.delete()});
        print("ðŸ—‘ï¸ Tema removido do Firestore");
      }

      notifyListeners();
    } catch (e) {
      print("âŒ ERRO ao limpar tema: $e");
    }
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\avatar.dart
// ========================================
import 'widgets/theme_toggle_button.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';

class AvatarScreen extends StatefulWidget {
  const AvatarScreen({super.key});

  @override
  State<AvatarScreen> createState() => _AvatarScreenState();
}

class _AvatarScreenState extends State<AvatarScreen>
    with SingleTickerProviderStateMixin {
  String? _selectedAvatar;
  late AnimationController _controller;
  late Animation<double> _animation;

  final List<String> avatars = [
    "assets/avatar1.png",
    "assets/avatar2.png",
    "assets/avatar3.png",
    "assets/avatar4.png",
    "assets/avatar5.png",
    "assets/avatar6.png",
    "assets/avatar7.png",
    "assets/avatar8.png",
  ];

  @override
  void initState() {
    super.initState();
    _selectedAvatar = avatars[0];

    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 1),
    )..repeat(reverse: true);

    _animation = Tween<double>(
      begin: 0,
      end: 20,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… CORRIGIDO
                  ],
                ),
              ),

              const SizedBox(height: 20),

              Text(
                "Escolha seu avatar",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),

              const SizedBox(height: 30),

              // Grid de avatares
              Expanded(
                child: GridView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 40),
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 20,
                    mainAxisSpacing: 20,
                  ),
                  itemCount: avatars.length,
                  itemBuilder: (context, index) {
                    final avatar = avatars[index];
                    final isSelected = _selectedAvatar == avatar;

                    return GestureDetector(
                      onTap: () {
                        setState(() {
                          _selectedAvatar = avatar;
                        });
                      },
                      child: AnimatedBuilder(
                        animation: _animation,
                        builder: (context, child) {
                          double offset = isSelected ? -_animation.value : 0;
                          return Transform.translate(
                            offset: Offset(0, offset),
                            child: Container(
                              padding: isSelected
                                  ? const EdgeInsets.all(4)
                                  : null,
                              decoration: isSelected
                                  ? BoxDecoration(
                                      shape: BoxShape.circle,
                                      border: Border.all(
                                        color: const Color(0xFFA9DBF4),
                                        width: 4,
                                      ),
                                    )
                                  : null,
                              child: ClipOval(
                                child: Image.asset(avatar, fit: BoxFit.cover),
                              ),
                            ),
                          );
                        },
                      ),
                    );
                  },
                ),
              ),

              // BotÃ£o PrÃ³ximo
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: SizedBox(
                  width: 200,
                  height: 50,
                  child: ElevatedButton(
                    onPressed: () {
                      context.push('/apelido', extra: _selectedAvatar);
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFA9DBF4),
                      foregroundColor: Colors.black,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      "PrÃ³ximo",
                      style: TextStyle(fontSize: 18),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\avatar_filho.dart
// ========================================
import 'widgets/theme_toggle_button.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';

class AvatarFilhoScreen extends StatefulWidget {
  const AvatarFilhoScreen({super.key});

  @override
  State<AvatarFilhoScreen> createState() => _AvatarFilhoScreenState();
}

class _AvatarFilhoScreenState extends State<AvatarFilhoScreen>
    with SingleTickerProviderStateMixin {
  String? _selectedAvatar;
  late AnimationController _controller;
  late Animation<double> _animation;

  final List<String> avatars = [
    "assets/avatar1.png",
    "assets/avatar2.png",
    "assets/avatar3.png",
    "assets/avatar4.png",
    "assets/avatar5.png",
    "assets/avatar6.png",
    "assets/avatar7.png",
    "assets/avatar8.png",
  ];

  @override
  void initState() {
    super.initState();
    _selectedAvatar = avatars[0];

    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 1),
    )..repeat(reverse: true);

    _animation = Tween<double>(
      begin: 0,
      end: 20,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 20),

              Text(
                "Escolha o avatar",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),

              const SizedBox(height: 30),

              // Grid de avatares
              Expanded(
                child: GridView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 40),
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 20,
                    mainAxisSpacing: 20,
                  ),
                  itemCount: avatars.length,
                  itemBuilder: (context, index) {
                    final avatar = avatars[index];
                    final isSelected = _selectedAvatar == avatar;

                    return GestureDetector(
                      onTap: () {
                        setState(() {
                          _selectedAvatar = avatar;
                        });
                      },
                      child: AnimatedBuilder(
                        animation: _animation,
                        builder: (context, child) {
                          double offset = isSelected ? -_animation.value : 0;
                          return Transform.translate(
                            offset: Offset(0, offset),
                            child: Container(
                              padding: isSelected
                                  ? const EdgeInsets.all(4)
                                  : null,
                              decoration: isSelected
                                  ? BoxDecoration(
                                      shape: BoxShape.circle,
                                      border: Border.all(
                                        color: const Color(0xFFA9DBF4),
                                        width: 4,
                                      ),
                                    )
                                  : null,
                              child: ClipOval(
                                child: Image.asset(avatar, fit: BoxFit.cover),
                              ),
                            ),
                          );
                        },
                      ),
                    );
                  },
                ),
              ),

              // BotÃµes
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: () => context.pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey[300],
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("Voltar"),
                      ),
                    ),
                    const SizedBox(width: 20),
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: () {
                          context.push(
                            '/apelido-filho',
                            extra: _selectedAvatar,
                          );
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("PrÃ³ximo"),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\cadastro.dart
// ========================================
import 'widgets/theme_toggle_button.dart';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';

class CadastroScreen extends StatefulWidget {
  const CadastroScreen({super.key});

  @override
  State<CadastroScreen> createState() => _CadastroScreenState();
}

class _CadastroScreenState extends State<CadastroScreen> {
  final _formKey = GlobalKey<FormState>();

  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _senhaController = TextEditingController();
  final TextEditingController _confirmarSenhaController =
      TextEditingController();

  bool _obscurePassword = true;
  bool _obscureConfirmPassword = true;
  bool _isLoading = false;

  @override
  void dispose() {
    _emailController.dispose();
    _senhaController.dispose();
    _confirmarSenhaController.dispose();
    super.dispose();
  }

  Future<void> _cadastrar() async {
    if (_formKey.currentState!.validate()) {
      setState(() => _isLoading = true);
      try {
        UserCredential userCredential = await FirebaseAuth.instance
            .createUserWithEmailAndPassword(
              email: _emailController.text.trim(),
              password: _senhaController.text.trim(),
            );

        print(
          "Cadastro realizado com sucesso! UsuÃ¡rio: ${userCredential.user?.email}",
        );

        if (!mounted) return;
        context.go('/avatar');
      } on FirebaseAuthException catch (e) {
        String mensagem;
        if (e.code == 'weak-password') {
          mensagem = 'A senha Ã© muito fraca. Use pelo menos 6 caracteres.';
        } else if (e.code == 'email-already-in-use') {
          mensagem = 'Este e-mail jÃ¡ estÃ¡ cadastrado.';
        } else if (e.code == 'invalid-email') {
          mensagem = 'E-mail invÃ¡lido.';
        } else {
          mensagem = 'Erro ao cadastrar: ${e.message}';
        }

        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(mensagem),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      } catch (e) {
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Erro inesperado: ${e.toString()}'),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      } finally {
        if (mounted) {
          setState(() => _isLoading = false);
        }
      }
    }
  }

  String? _validarEmail(String? valor) {
    if (valor == null || valor.trim().isEmpty) {
      return "E-mail Ã© obrigatÃ³rio";
    }
    final emailRegex = RegExp(r"^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$");
    if (!emailRegex.hasMatch(valor.trim())) {
      return "E-mail invÃ¡lido";
    }
    return null;
  }

  String? _validarSenha(String? valor) {
    if (valor == null || valor.trim().isEmpty) {
      return "Senha Ã© obrigatÃ³ria";
    }
    if (valor.length < 6) {
      return "Senha deve ter pelo menos 6 caracteres";
    }
    return null;
  }

  String? _validarConfirmarSenha(String? valor) {
    if (valor == null || valor.trim().isEmpty) {
      return "ConfirmaÃ§Ã£o de senha Ã© obrigatÃ³ria";
    }
    if (valor != _senhaController.text) {
      return "As senhas nÃ£o coincidem";
    }
    return null;
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… CORRIGIDO
                  ],
                ),
              ),

              Expanded(
                child: Center(
                  child: SingleChildScrollView(
                    child: Form(
                      key: _formKey,
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Image.asset("assets/logo.png", width: 200),
                          const SizedBox(height: 16),
                          Text(
                            "Crie sua conta",
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: appTema.textColor,
                            ),
                          ),
                          const SizedBox(height: 30),

                          // Campo E-mail
                          _buildTextField(
                            controller: _emailController,
                            hint: "E-mail",
                            validator: _validarEmail,
                          ),
                          const SizedBox(height: 16),

                          // Campo Senha
                          _buildTextField(
                            controller: _senhaController,
                            hint: "Senha",
                            obscure: _obscurePassword,
                            suffixIcon: IconButton(
                              icon: Icon(
                                _obscurePassword
                                    ? Icons.visibility_off
                                    : Icons.visibility,
                              ),
                              onPressed: () {
                                setState(() {
                                  _obscurePassword = !_obscurePassword;
                                });
                              },
                            ),
                            validator: _validarSenha,
                          ),
                          const SizedBox(height: 16),

                          // Campo Confirmar Senha
                          _buildTextField(
                            controller: _confirmarSenhaController,
                            hint: "Confirmar Senha",
                            obscure: _obscureConfirmPassword,
                            suffixIcon: IconButton(
                              icon: Icon(
                                _obscureConfirmPassword
                                    ? Icons.visibility_off
                                    : Icons.visibility,
                              ),
                              onPressed: () {
                                setState(() {
                                  _obscureConfirmPassword =
                                      !_obscureConfirmPassword;
                                });
                              },
                            ),
                            validator: _validarConfirmarSenha,
                          ),
                          const SizedBox(height: 30),

                          // BotÃ£o Cadastrar
                          SizedBox(
                            width: 200,
                            height: 50,
                            child: ElevatedButton(
                              onPressed: _isLoading ? null : _cadastrar,
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFFA9DBF4),
                                foregroundColor: Colors.black,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 4,
                                shadowColor: Colors.black.withValues(
                                  alpha: 77 / 255,
                                ),
                              ),
                              child: _isLoading
                                  ? const SizedBox(
                                      width: 24,
                                      height: 24,
                                      child: CircularProgressIndicator(
                                        color: Colors.black,
                                        strokeWidth: 2.5,
                                      ),
                                    )
                                  : const Text(
                                      "Cadastrar",
                                      style: TextStyle(fontSize: 18),
                                    ),
                            ),
                          ),

                          const SizedBox(height: 16),

                          // BotÃ£o Voltar
                          SizedBox(
                            width: 200,
                            height: 50,
                            child: ElevatedButton(
                              onPressed: _isLoading
                                  ? null
                                  : () {
                                      context.go('/options');
                                    },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFFA9DBF4),
                                foregroundColor: Colors.black,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 4,
                                shadowColor: Colors.black.withValues(
                                  alpha: 77 / 255,
                                ),
                              ),
                              child: const Text(
                                "Voltar",
                                style: TextStyle(fontSize: 18),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? Function(String?)? validator,
    bool obscure = false,
    Widget? suffixIcon,
  }) {
    return SizedBox(
      width: 300,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
          child: TextFormField(
            controller: controller,
            obscureText: obscure,
            validator: validator,
            decoration: InputDecoration(
              filled: true,
              fillColor: Colors.white.withValues(alpha: 80 / 255),
              hintText: hint,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
              suffixIcon: suffixIcon,
            ),
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\catalogo.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';

class CatalogoScreen extends StatefulWidget {
  const CatalogoScreen({super.key});

  @override
  State<CatalogoScreen> createState() => _CatalogoScreenState();
}

class _CatalogoScreenState extends State<CatalogoScreen> {
  bool _isLoading = true;
  List<String> _generosVisiveis = [];

  @override
  void initState() {
    super.initState();
    _carregarDadosUsuario();
  }

  Future<void> _carregarDadosUsuario() async {
    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );
      final appTema = Provider.of<AppTema>(context, listen: false);

      print("ðŸ”µ Carregando dados do usuÃ¡rio...");
      print("   perfilAtivoApelido: ${perfilProvider.perfilAtivoApelido}");

      if (user != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final data = userDoc.data();

          await appTema.loadThemeFromFirestore();

          if (perfilProvider.perfilAtivoApelido != null) {
            print(
              "âœ… Usando perfil ativo: ${perfilProvider.perfilAtivoApelido}",
            );

            // Carregar preferÃªncias baseado no tipo de perfil
            if (perfilProvider.isPerfilPai) {
              // Perfil pai vÃª todos os gÃªneros
              _generosVisiveis = [
                'AÃ§Ã£o',
                'ComÃ©dia',
                'Drama',
                'Terror',
                'FicÃ§Ã£o CientÃ­fica',
                'Romance',
                'AnimaÃ§Ã£o',
                'DocumentÃ¡rio',
              ];
            } else {
              // Perfil filho vÃª apenas os gÃªneros das preferÃªncias
              final perfisFilhos =
                  data?['perfisFilhos'] as List<dynamic>? ?? [];

              final perfilFilhoAtual = perfisFilhos.firstWhere(
                (perfil) =>
                    perfil['apelido'] == perfilProvider.perfilAtivoApelido,
                orElse: () => null,
              );

              if (perfilFilhoAtual != null) {
                // âœ… PADRONIZADO: usa 'interesses'
                final interesses =
                    perfilFilhoAtual['interesses'] as List<dynamic>? ?? [];
                _generosVisiveis = List<String>.from(interesses);
              }
            }
          }
        }
      }

      setState(() => _isLoading = false);
    } catch (e) {
      print("âŒ Erro ao carregar dados: $e");
      setState(() => _isLoading = false);
    }
  }

  void _mostrarMenuPerfil() {
    final appTema = Provider.of<AppTema>(context, listen: false);
    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);
    final userName = perfilProvider.perfilAtivoApelido ?? 'UsuÃ¡rio';
    final userAvatar = perfilProvider.perfilAtivoAvatar ?? 'assets/avatar1.png';

    showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.5),
      builder: (BuildContext context) {
        return Dialog(
          alignment: Alignment.topRight,
          insetPadding: const EdgeInsets.only(top: 70, right: 20),
          backgroundColor: Colors.transparent,
          child: Container(
            width: 280,
            decoration: BoxDecoration(
              color: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: appTema.isDarkMode
                        ? Colors.grey[850]
                        : Colors.grey[100],
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(12),
                      topRight: Radius.circular(12),
                    ),
                  ),
                  child: Row(
                    children: [
                      CircleAvatar(
                        radius: 28,
                        backgroundImage: AssetImage(userAvatar),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              userName,
                              style: TextStyle(
                                color: appTema.textColor,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              perfilProvider.isPerfilPai
                                  ? 'Perfil Principal'
                                  : 'Perfil Filho',
                              style: TextStyle(
                                color: appTema.textSecondaryColor,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),

                _buildMenuItem(
                  icon: Icons.account_circle_outlined,
                  label: 'Mudar Avatar',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/mudar-avatar');
                  },
                ),
                _buildMenuItem(
                  icon: Icons.people_outline,
                  label: 'Mudar Perfil',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/mudar-perfil');
                  },
                ),
                _buildMenuItem(
                  icon: Icons.person_add_outlined,
                  label: 'Adicionar Familiar',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/adicionar-perfis');
                  },
                ),
                _buildMenuItem(
                  icon: Icons.settings_outlined,
                  label: 'ConfiguraÃ§Ãµes',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/perfil-configs');
                  },
                ),

                const Divider(height: 1),

                _buildMenuItem(
                  icon: Icons.logout,
                  label: 'Sair',
                  isDestructive: true,
                  isDarkMode: appTema.isDarkMode,
                  onTap: () async {
                    Navigator.pop(context);
                    _fazerLogout();
                  },
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildMenuItem({
    required IconData icon,
    required String label,
    required bool isDarkMode,
    required VoidCallback onTap,
    bool isDestructive = false,
  }) {
    final color = isDestructive
        ? Colors.red
        : (isDarkMode ? Colors.white : Colors.black);

    return InkWell(
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        child: Row(
          children: [
            Icon(icon, color: color, size: 22),
            const SizedBox(width: 14),
            Text(
              label,
              style: TextStyle(
                color: color,
                fontSize: 15,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _fazerLogout() async {
    final appTema = Provider.of<AppTema>(context, listen: false);
    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);

    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
        title: Text('Sair', style: TextStyle(color: appTema.textColor)),
        content: Text(
          'Deseja realmente sair da sua conta?',
          style: TextStyle(color: appTema.textSecondaryColor),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: Text(
              'Cancelar',
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
          ),
          TextButton(
            onPressed: () => Navigator.of(context).pop(true),
            child: const Text('Sair', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    if (confirm == true) {
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸšª FAZENDO LOGOUT");
      print("   Tema atual: ${appTema.isDarkMode ? 'Escuro' : 'Claro'}");

      await FirebaseAuth.instance.signOut();
      await perfilProvider.clearPerfilAtivo();

      print("   Tema apÃ³s logout: ${appTema.isDarkMode ? 'Escuro' : 'Claro'}");
      print("   (Tema NÃƒO deve mudar no logout)");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (mounted) context.go('/options');
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);
    final perfilProvider = Provider.of<PerfilProvider>(context);
    final userName = perfilProvider.perfilAtivoApelido ?? 'UsuÃ¡rio';
    final userAvatar = perfilProvider.perfilAtivoAvatar ?? 'assets/avatar1.png';

    if (_isLoading) {
      return Scaffold(
        backgroundColor: appTema.backgroundColor,
        body: const Center(
          child: CircularProgressIndicator(color: Color(0xFFA9DBF4)),
        ),
      );
    }

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // APPBAR - SETA VOLTAR (SÃ“ PARA PAI), TEMA E AVATAR
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    // Seta de voltar (APENAS para perfil pai)
                    if (perfilProvider.isPerfilPai)
                      IconButton(
                        icon: const Icon(Icons.arrow_back, size: 28),
                        color: appTema.textColor,
                        onPressed: () => context.go('/gerenciamento-pais'),
                      ),
                    const Spacer(),
                    const ThemeToggleButton(),
                    const SizedBox(width: 8),
                    GestureDetector(
                      onTap: _mostrarMenuPerfil,
                      child: CircleAvatar(
                        radius: 20,
                        backgroundImage: AssetImage(userAvatar),
                      ),
                    ),
                  ],
                ),
              ),

              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // SAUDAÃ‡ÃƒO
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20,
                  vertical: 16,
                ),
                child: Align(
                  alignment: Alignment.centerLeft,
                  child: Text(
                    'OlÃ¡, $userName!',
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),

              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // GRADE DE GÃŠNEROS
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: GridView.count(
                    crossAxisCount: 2,
                    mainAxisSpacing: 16,
                    crossAxisSpacing: 16,
                    childAspectRatio: 1.1,
                    children: [
                      if (_generosVisiveis.contains('AÃ§Ã£o'))
                        _buildGeneroCard(
                          emoji: 'ðŸ’¥',
                          genero: 'AÃ§Ã£o',
                          cor: Colors.red,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('ComÃ©dia'))
                        _buildGeneroCard(
                          emoji: 'ðŸ˜‚',
                          genero: 'ComÃ©dia',
                          cor: Colors.yellow,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('Drama'))
                        _buildGeneroCard(
                          emoji: 'ðŸŽ­',
                          genero: 'Drama',
                          cor: Colors.purple,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('Terror'))
                        _buildGeneroCard(
                          emoji: 'ðŸ‘»',
                          genero: 'Terror',
                          cor: Colors.black,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('FicÃ§Ã£o CientÃ­fica'))
                        _buildGeneroCard(
                          emoji: 'ðŸš€',
                          genero: 'FicÃ§Ã£o CientÃ­fica',
                          cor: Colors.blue,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('Romance'))
                        _buildGeneroCard(
                          emoji: 'ðŸ’•',
                          genero: 'Romance',
                          cor: Colors.pink,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('AnimaÃ§Ã£o'))
                        _buildGeneroCard(
                          emoji: 'ðŸŽ¨',
                          genero: 'AnimaÃ§Ã£o',
                          cor: Colors.green,
                          appTema: appTema,
                        ),
                      if (_generosVisiveis.contains('DocumentÃ¡rio'))
                        _buildGeneroCard(
                          emoji: 'ðŸ“š',
                          genero: 'DocumentÃ¡rio',
                          cor: Colors.brown,
                          appTema: appTema,
                        ),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGET: CARD DE GÃŠNERO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Widget _buildGeneroCard({
    required String emoji,
    required String genero,
    required Color cor,
    required AppTema appTema,
  }) {
    return GestureDetector(
      onTap: () {
        context.push('/videos/$genero');
      },
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: appTema.isDarkMode
                ? [
                    Colors.white.withValues(alpha: 0.18),
                    Colors.white.withValues(alpha: 0.12),
                  ]
                : [
                    Colors.black.withValues(alpha: 0.12),
                    Colors.black.withValues(alpha: 0.08),
                  ],
          ),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: appTema.isDarkMode
                ? Colors.white.withValues(alpha: 0.25)
                : Colors.black.withValues(alpha: 0.18),
            width: 1.5,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.15),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(emoji, style: const TextStyle(fontSize: 50)),
            const SizedBox(height: 12),
            Text(
              genero,
              textAlign: TextAlign.center,
              style: TextStyle(
                color: appTema.textColor,
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\criapin.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';
import 'services/pin_service.dart';

class CriaPinScreen extends StatefulWidget {
  final String apelido;
  final String avatar;

  const CriaPinScreen({super.key, required this.apelido, required this.avatar});

  @override
  State<CriaPinScreen> createState() => _CriaPinScreenState();
}

class _CriaPinScreenState extends State<CriaPinScreen> {
  final TextEditingController _pinController = TextEditingController();
  final TextEditingController _confirmPinController = TextEditingController();
  bool _isLoading = false;
  bool _isPinVisible = false;
  bool _isConfirmPinVisible = false;

  @override
  void dispose() {
    _pinController.dispose();
    _confirmPinController.dispose();
    super.dispose();
  }

  Future<void> _salvarPin() async {
    final pin = _pinController.text.trim();
    final confirmPin = _confirmPinController.text.trim();

    // ValidaÃ§Ãµes
    if (pin.isEmpty || confirmPin.isEmpty) {
      _mostrarErro('Por favor, preencha os dois campos');
      return;
    }

    if (pin.length != 4) {
      _mostrarErro('O PIN deve ter exatamente 4 dÃ­gitos');
      return;
    }

    if (pin != confirmPin) {
      _mostrarErro('Os PINs nÃ£o coincidem. Tente novamente.');
      return;
    }

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        throw Exception('UsuÃ¡rio nÃ£o autenticado');
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸ” CRIANDO PIN DE SEGURANÃ‡A");
      print("   UsuÃ¡rio: ${user.uid}");
      print("   Apelido: ${widget.apelido}");
      print("   Avatar: ${widget.avatar}");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      // âœ… NOVO: Usa o PinService para hash seguro
      final pinService = PinService();
      final sucesso = await pinService.criarPinPerfilPai(pin);

      if (!sucesso) {
        throw Exception('Falha ao criar PIN');
      }

      // Salva o perfil pai (sem o PIN, que jÃ¡ foi salvo pelo PinService)
      await FirebaseFirestore.instance.collection('users').doc(user.uid).set({
        'email': user.email,
        'apelido': widget.apelido,
        'avatar': widget.avatar,
        'perfisFilhos': [],
        'criadoEm': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));

      print("   âœ… Perfil pai e PIN salvos no Firestore");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (!mounted) return;

      // Navega para a tela de gerenciamento de pais
      context.go('/gerenciamento-pais');
    } catch (e) {
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print('âŒ ERRO AO SALVAR PIN: $e');
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (!mounted) return;

      _mostrarErro('Erro ao criar PIN: ${e.toString()}');
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _mostrarErro(String mensagem) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(mensagem),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(24.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  // Header
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Image.asset("assets/logo.png", height: 40),
                      const ThemeToggleButton(showLogo: false),
                    ],
                  ),

                  const SizedBox(height: 40),

                  // Avatar
                  CircleAvatar(
                    radius: 60,
                    backgroundImage: AssetImage(widget.avatar),
                  ),

                  const SizedBox(height: 16),

                  // Apelido
                  Text(
                    widget.apelido,
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: appTema.textColor,
                    ),
                  ),

                  const SizedBox(height: 40),

                  // TÃ­tulo
                  Text(
                    "Crie seu PIN de seguranÃ§a",
                    style: TextStyle(
                      fontSize: 22,
                      fontWeight: FontWeight.bold,
                      color: appTema.textColor,
                    ),
                    textAlign: TextAlign.center,
                  ),

                  const SizedBox(height: 12),

                  // DescriÃ§Ã£o
                  Text(
                    "O PIN protegerÃ¡ suas configuraÃ§Ãµes e\ncontroles parentais",
                    style: TextStyle(
                      fontSize: 16,
                      color: appTema.textColor.withValues(alpha: 0.8),
                    ),
                    textAlign: TextAlign.center,
                  ),

                  const SizedBox(height: 40),

                  // Campo PIN
                  TextField(
                    controller: _pinController,
                    keyboardType: TextInputType.number,
                    obscureText: !_isPinVisible,
                    maxLength: 4,
                    inputFormatters: [FilteringTextInputFormatter.digitsOnly],
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 18,
                      letterSpacing: 8,
                    ),
                    textAlign: TextAlign.center,
                    decoration: InputDecoration(
                      labelText: "Digite seu PIN (4 dÃ­gitos)",
                      labelStyle: TextStyle(color: appTema.textColor),
                      counterText: "",
                      filled: true,
                      fillColor: Colors.white.withValues(alpha: 0.1),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: const BorderSide(
                          color: Color(0xFFA9DBF4),
                          width: 2,
                        ),
                      ),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _isPinVisible
                              ? Icons.visibility
                              : Icons.visibility_off,
                          color: appTema.textColor.withValues(alpha: 0.6),
                        ),
                        onPressed: () {
                          setState(() {
                            _isPinVisible = !_isPinVisible;
                          });
                        },
                      ),
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Campo Confirmar PIN
                  TextField(
                    controller: _confirmPinController,
                    keyboardType: TextInputType.number,
                    obscureText: !_isConfirmPinVisible,
                    maxLength: 4,
                    inputFormatters: [FilteringTextInputFormatter.digitsOnly],
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 18,
                      letterSpacing: 8,
                    ),
                    textAlign: TextAlign.center,
                    decoration: InputDecoration(
                      labelText: "Confirme seu PIN",
                      labelStyle: TextStyle(color: appTema.textColor),
                      counterText: "",
                      filled: true,
                      fillColor: Colors.white.withValues(alpha: 0.1),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: const BorderSide(
                          color: Color(0xFFA9DBF4),
                          width: 2,
                        ),
                      ),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _isConfirmPinVisible
                              ? Icons.visibility
                              : Icons.visibility_off,
                          color: appTema.textColor.withValues(alpha: 0.6),
                        ),
                        onPressed: () {
                          setState(() {
                            _isConfirmPinVisible = !_isConfirmPinVisible;
                          });
                        },
                      ),
                    ),
                  ),

                  const SizedBox(height: 40),

                  // Dica de seguranÃ§a
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.amber.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: Colors.amber.withValues(alpha: 0.5),
                        width: 1,
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.info_outline,
                          color: Colors.amber[700],
                          size: 24,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            "Escolha um PIN que vocÃª consiga lembrar, mas que seja difÃ­cil de adivinhar",
                            style: TextStyle(
                              color: appTema.textColor,
                              fontSize: 14,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 40),

                  // BotÃ£o Criar PIN
                  SizedBox(
                    width: double.infinity,
                    height: 56,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _salvarPin,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFFA9DBF4),
                        foregroundColor: Colors.black,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 24,
                              height: 24,
                              child: CircularProgressIndicator(
                                color: Colors.black,
                                strokeWidth: 2.5,
                              ),
                            )
                          : const Text(
                              "Criar PIN e Continuar",
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\editar_perfil_filho.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';

class EditarPerfilFilhoScreen extends StatefulWidget {
  final int perfilIndex; // Ãndice do perfil no array
  final Map<String, dynamic> perfilAtual; // Dados atuais do perfil

  const EditarPerfilFilhoScreen({
    super.key,
    required this.perfilIndex,
    required this.perfilAtual,
  });

  @override
  State<EditarPerfilFilhoScreen> createState() =>
      _EditarPerfilFilhoScreenState();
}

class _EditarPerfilFilhoScreenState extends State<EditarPerfilFilhoScreen> {
  final TextEditingController _apelidoController = TextEditingController();
  bool _isLoading = false;
  final Map<String, bool> _interessesSelecionados = {};

  // Lista de interesses disponÃ­veis
  final Map<String, Map<String, dynamic>> _todosInteresses = {
    'AÃ§Ã£o': {'emoji': 'ðŸ’¥', 'cor': Colors.red},
    'ComÃ©dia': {'emoji': 'ðŸ˜‚', 'cor': Colors.orange},
    'Drama': {'emoji': 'ðŸŽ­', 'cor': Colors.purple},
    'Terror': {'emoji': 'ðŸ‘»', 'cor': Colors.grey},
    'FicÃ§Ã£o CientÃ­fica': {'emoji': 'ðŸš€', 'cor': Colors.blue},
    'Romance': {'emoji': 'ðŸ’•', 'cor': Colors.pink},
    'AnimaÃ§Ã£o': {'emoji': 'ðŸŽ¨', 'cor': Colors.green},
    'DocumentÃ¡rio': {'emoji': 'ðŸ“š', 'cor': Colors.brown},
  };

  @override
  void initState() {
    super.initState();

    // Inicializa com dados atuais
    _apelidoController.text = widget.perfilAtual['apelido'] ?? '';

    // Inicializa interesses
    final interessesAtuais =
        widget.perfilAtual['interesses'] as List<dynamic>? ?? [];
    for (var interesse in _todosInteresses.keys) {
      _interessesSelecionados[interesse] = interessesAtuais.contains(interesse);
    }
  }

  @override
  void dispose() {
    _apelidoController.dispose();
    super.dispose();
  }

  Future<void> _salvarAlteracoes() async {
    final apelido = _apelidoController.text.trim();

    // ValidaÃ§Ãµes
    if (apelido.isEmpty) {
      _mostrarErro('Por favor, insira um apelido');
      return;
    }

    final interessesSelecionados = _interessesSelecionados.entries
        .where((entry) => entry.value == true)
        .map((entry) => entry.key)
        .toList();

    if (interessesSelecionados.isEmpty) {
      _mostrarErro('Selecione pelo menos um interesse');
      return;
    }

    // âœ… CORREÃ‡ÃƒO: Confirmar se o usuÃ¡rio realmente quer salvar
    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) {
        final appTema = Provider.of<AppTema>(context, listen: false);
        return AlertDialog(
          backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Row(
            children: [
              const Icon(
                Icons.check_circle_outline,
                color: Color(0xFFA9DBF4),
                size: 28,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  'Salvar AlteraÃ§Ãµes?',
                  style: TextStyle(color: appTema.textColor),
                ),
              ),
            ],
          ),
          content: Text(
            'Deseja realmente salvar as alteraÃ§Ãµes feitas no perfil?',
            style: TextStyle(color: appTema.textSecondaryColor),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context, false),
              child: Text(
                'Cancelar',
                style: TextStyle(color: appTema.textSecondaryColor),
              ),
            ),
            ElevatedButton(
              onPressed: () => Navigator.pop(context, true),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFA9DBF4),
                foregroundColor: Colors.black,
              ),
              child: const Text('Salvar'),
            ),
          ],
        );
      },
    );

    if (confirmar != true) return;

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        throw Exception('UsuÃ¡rio nÃ£o autenticado');
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸ’¾ ATUALIZANDO PERFIL FILHO");
      print("   Ãndice: ${widget.perfilIndex}");
      print("   Novo Apelido: $apelido");
      print("   Novos Interesses: $interessesSelecionados");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      // Busca o documento do usuÃ¡rio
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .get();

      if (!userDoc.exists) {
        throw Exception('Documento do usuÃ¡rio nÃ£o encontrado');
      }

      // Pega o array de perfis filhos
      List<dynamic> perfisFilhos = userDoc.data()?['perfisFilhos'] ?? [];

      // âœ… VALIDAÃ‡ÃƒO: Verifica se jÃ¡ existe outro perfil com esse apelido
      final apelidoOriginal = widget.perfilAtual['apelido'];
      if (apelido != apelidoOriginal) {
        final apelidoJaExiste = perfisFilhos.any(
          (p) => p['apelido'] == apelido,
        );

        if (apelidoJaExiste) {
          if (!mounted) return;
          _mostrarErro(
            'JÃ¡ existe um perfil com o apelido "$apelido". Escolha outro nome.',
          );
          setState(() => _isLoading = false);
          return;
        }
      }

      // âœ… CORREÃ‡ÃƒO: ValidaÃ§Ã£o mais robusta do Ã­ndice
      if (perfisFilhos.isEmpty) {
        throw Exception('Nenhum perfil filho encontrado');
      }

      if (widget.perfilIndex < 0 || widget.perfilIndex >= perfisFilhos.length) {
        throw Exception(
          'Ãndice do perfil invÃ¡lido (${widget.perfilIndex}/${perfisFilhos.length})',
        );
      }

      // âœ… CORREÃ‡ÃƒO: Verifica se o apelido original ainda existe no Ã­ndice correto
      final perfilNoIndice = perfisFilhos[widget.perfilIndex];
      if (perfilNoIndice['apelido'] != widget.perfilAtual['apelido']) {
        // O perfil mudou de posiÃ§Ã£o, tenta encontrar pelo apelido original
        final indexCorreto = perfisFilhos.indexWhere(
          (p) => p['apelido'] == widget.perfilAtual['apelido'],
        );

        if (indexCorreto == -1) {
          throw Exception(
            'Perfil nÃ£o encontrado. A lista pode ter sido modificada.',
          );
        }

        print(
          "âš ï¸ Perfil mudou de posiÃ§Ã£o. Usando Ã­ndice correto: $indexCorreto",
        );

        // Atualiza usando o Ã­ndice correto (mantÃ©m o avatar original)
        perfisFilhos[indexCorreto] = {
          'apelido': apelido,
          'avatar':
              perfisFilhos[indexCorreto]['avatar'], // MantÃ©m o avatar original
          'interesses': interessesSelecionados,
          'criadoEm': perfisFilhos[indexCorreto]['criadoEm'] ?? Timestamp.now(),
          'atualizadoEm': Timestamp.now(),
        };
      } else {
        // Tudo certo, atualiza normalmente (mantÃ©m o avatar original)
        perfisFilhos[widget.perfilIndex] = {
          'apelido': apelido,
          'avatar': widget.perfilAtual['avatar'], // MantÃ©m o avatar original
          'interesses': interessesSelecionados,
          'criadoEm':
              perfisFilhos[widget.perfilIndex]['criadoEm'] ?? Timestamp.now(),
          'atualizadoEm': Timestamp.now(),
        };
      }

      // Salva no Firestore
      await FirebaseFirestore.instance.collection('users').doc(user.uid).update(
        {'perfisFilhos': perfisFilhos},
      );

      print("   âœ… Perfil atualizado com sucesso!");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (!mounted) return;

      // âœ… CORREÃ‡ÃƒO: Atualiza provider de forma mais robusta
      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );

      final apelidoAntigo = widget.perfilAtual['apelido'];
      final perfilEstaAtivo =
          perfilProvider.perfilAtivoApelido == apelidoAntigo;

      print("ðŸ” Verificando se precisa atualizar provider:");
      print("   Apelido antigo: $apelidoAntigo");
      print("   Apelido novo: $apelido");
      print("   Perfil ativo: ${perfilProvider.perfilAtivoApelido}");
      print("   EstÃ¡ ativo?: $perfilEstaAtivo");

      if (perfilEstaAtivo) {
        print("ðŸ”„ Perfil editado estÃ¡ ativo - Atualizando provider...");

        await perfilProvider.setPerfilAtivo(
          apelido: apelido,
          avatar: widget.perfilAtual['avatar'], // MantÃ©m o avatar original
          isPai: false,
        );

        print("âœ… Provider atualizado com sucesso!");

        if (!mounted) return;

        // Mensagem diferenciada para perfil ativo
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(
              'Perfil atualizado e ativo! As mudanÃ§as jÃ¡ estÃ£o visÃ­veis.',
            ),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 3),
          ),
        );
      } else {
        print(
          "â„¹ï¸ Perfil editado nÃ£o estÃ¡ ativo - NÃ£o precisa atualizar provider",
        );

        if (!mounted) return;

        // Mensagem padrÃ£o
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Perfil atualizado com sucesso!'),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 2),
          ),
        );
      }

      // Volta para a tela anterior
      context.pop(true); // true = sucesso
    } catch (e) {
      print("âŒ ERRO ao atualizar perfil: $e");
      if (!mounted) return;

      _mostrarErro('Erro ao salvar: ${e.toString()}');
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _mostrarErro(String mensagem) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(mensagem),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false),
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              // ConteÃºdo
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.center,
                    children: [
                      // TÃ­tulo
                      Text(
                        'Editar Perfil',
                        style: TextStyle(
                          color: appTema.textColor,
                          fontSize: 28,
                          fontWeight: FontWeight.bold,
                        ),
                      ),

                      const SizedBox(height: 8),

                      Text(
                        'Personalize o perfil do familiar',
                        style: TextStyle(
                          color: appTema.textSecondaryColor,
                          fontSize: 14,
                        ),
                      ),

                      const SizedBox(height: 40),

                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      // AVATAR FIXO (nÃ£o editÃ¡vel)
                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      CircleAvatar(
                        radius: 60,
                        backgroundImage: AssetImage(
                          widget.perfilAtual['avatar'],
                        ),
                      ),

                      const SizedBox(height: 40),

                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      // SEÃ‡ÃƒO: APELIDO
                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      _buildSecaoTitulo('Apelido', appTema),

                      const SizedBox(height: 16),

                      TextField(
                        controller: _apelidoController,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          color: appTema.textColor,
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                        ),
                        decoration: InputDecoration(
                          hintText: "Digite o apelido",
                          hintStyle: TextStyle(
                            color: appTema.textColor.withValues(alpha: 0.5),
                          ),
                          filled: true,
                          fillColor: appTema.isDarkMode
                              ? Colors.white.withValues(alpha: 0.1)
                              : Colors.white.withValues(alpha: 0.8),
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12),
                            borderSide: BorderSide.none,
                          ),
                          focusedBorder: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12),
                            borderSide: const BorderSide(
                              color: Color(0xFFA9DBF4),
                              width: 2,
                            ),
                          ),
                        ),
                        maxLength: 20,
                      ),

                      const SizedBox(height: 40),

                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      // SEÃ‡ÃƒO: INTERESSES
                      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      _buildSecaoTitulo('Interesses', appTema),

                      const SizedBox(height: 16),

                      // BotÃ£o Selecionar Todas
                      SizedBox(
                        width: double.infinity,
                        child: OutlinedButton.icon(
                          onPressed: _toggleSelecaoTodas,
                          icon: Icon(
                            _algumInteresseSelecionado
                                ? Icons.deselect
                                : Icons.select_all,
                            color: const Color(0xFFA9DBF4),
                          ),
                          label: Text(
                            _algumInteresseSelecionado
                                ? 'Desmarcar Todas'
                                : 'Selecionar Todas',
                            style: const TextStyle(
                              color: Color(0xFFA9DBF4),
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          style: OutlinedButton.styleFrom(
                            side: const BorderSide(
                              color: Color(0xFFA9DBF4),
                              width: 2,
                            ),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                        ),
                      ),

                      const SizedBox(height: 16),

                      // Lista de interesses
                      ..._todosInteresses.entries.map((entry) {
                        final interesse = entry.key;
                        final dados = entry.value;
                        final isSelected =
                            _interessesSelecionados[interesse] ?? false;

                        return Padding(
                          padding: const EdgeInsets.only(bottom: 12.0),
                          child: _buildInteresseCheckbox(
                            interesse: interesse,
                            emoji: dados['emoji'],
                            cor: dados['cor'],
                            isSelected: isSelected,
                            appTema: appTema,
                          ),
                        );
                      }),
                    ],
                  ),
                ),
              ),

              // BotÃµes
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : () => context.pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey[300],
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("Cancelar"),
                      ),
                    ),
                    const SizedBox(width: 20),
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _salvarAlteracoes,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  color: Colors.black,
                                  strokeWidth: 2.5,
                                ),
                              )
                            : const Text("Salvar"),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGETS AUXILIARES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Widget _buildSecaoTitulo(String titulo, AppTema appTema) {
    return Text(
      titulo,
      style: TextStyle(
        color: appTema.textColor,
        fontSize: 20,
        fontWeight: FontWeight.bold,
      ),
    );
  }

  Widget _buildInteresseCheckbox({
    required String interesse,
    required String emoji,
    required Color cor,
    required bool isSelected,
    required AppTema appTema,
  }) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _interessesSelecionados[interesse] = !isSelected;
        });
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isSelected
              ? (appTema.isDarkMode
                    ? const Color(0xFFA9DBF4).withValues(alpha: 0.2)
                    : const Color(0xFFA9DBF4).withValues(alpha: 0.3))
              : (appTema.isDarkMode
                    ? Colors.grey[800]?.withValues(alpha: 0.5)
                    : Colors.white.withValues(alpha: 0.7)),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? const Color(0xFFA9DBF4)
                : (appTema.isDarkMode ? Colors.white24 : Colors.black12),
            width: isSelected ? 3 : 1,
          ),
        ),
        child: Row(
          children: [
            Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: cor.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Center(
                child: Text(emoji, style: const TextStyle(fontSize: 32)),
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Text(
                interesse,
                style: TextStyle(
                  color: appTema.textColor,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: isSelected
                    ? const Color(0xFFA9DBF4)
                    : Colors.transparent,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: isSelected
                      ? const Color(0xFFA9DBF4)
                      : appTema.textSecondaryColor,
                  width: 2,
                ),
              ),
              child: isSelected
                  ? const Icon(Icons.check, color: Colors.black, size: 20)
                  : null,
            ),
          ],
        ),
      ),
    );
  }

  bool get _algumInteresseSelecionado =>
      _interessesSelecionados.values.any((v) => v == true);

  void _toggleSelecaoTodas() {
    setState(() {
      final novoValor = !_algumInteresseSelecionado;
      for (var interesse in _interessesSelecionados.keys) {
        _interessesSelecionados[interesse] = novoValor;
      }
    });
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\firebase_options.dart
// ========================================
// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
///
/// Example:
/// ```dart
/// import 'firebase_options.dart';
/// // ...
/// await Firebase.initializeApp(
///   options: DefaultFirebaseOptions.currentPlatform,
/// );
/// ```
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyB2a-wfdUm1Ebj2YejsI8PMVm9oq1ryaBo',
    appId: '1:846678971915:web:522c995592bcb457b4190e',
    messagingSenderId: '846678971915',
    projectId: 'bluflix-tg',
    authDomain: 'bluflix-tg.firebaseapp.com',
    storageBucket: 'bluflix-tg.firebasestorage.app',
    measurementId: 'G-ZZLEKQX879',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyCtAccdNaGd1KFs1ptgfqYt3tVLCLmvPVw',
    appId: '1:846678971915:android:dd3925f1bb6e571fb4190e',
    messagingSenderId: '846678971915',
    projectId: 'bluflix-tg',
    storageBucket: 'bluflix-tg.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyAZJNOuSlaxiJu5N_42QAYlhj1URs1aH3U',
    appId: '1:846678971915:ios:55ab5220641a87e2b4190e',
    messagingSenderId: '846678971915',
    projectId: 'bluflix-tg',
    storageBucket: 'bluflix-tg.firebasestorage.app',
    iosClientId: '846678971915-em7sm5na57d66eraapke1g9vt2odpmq9.apps.googleusercontent.com',
    iosBundleId: 'com.example.bluflix',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyAZJNOuSlaxiJu5N_42QAYlhj1URs1aH3U',
    appId: '1:846678971915:ios:55ab5220641a87e2b4190e',
    messagingSenderId: '846678971915',
    projectId: 'bluflix-tg',
    storageBucket: 'bluflix-tg.firebasestorage.app',
    iosClientId: '846678971915-em7sm5na57d66eraapke1g9vt2odpmq9.apps.googleusercontent.com',
    iosBundleId: 'com.example.bluflix',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyB2a-wfdUm1Ebj2YejsI8PMVm9oq1ryaBo',
    appId: '1:846678971915:web:53edbcd009bd4b8ab4190e',
    messagingSenderId: '846678971915',
    projectId: 'bluflix-tg',
    authDomain: 'bluflix-tg.firebaseapp.com',
    storageBucket: 'bluflix-tg.firebasestorage.app',
    measurementId: 'G-3YE61WVLYM',
  );
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\gerenciamento_pais.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';
import 'pin_verification.dart';

class GerenciamentoPaisScreen extends StatefulWidget {
  const GerenciamentoPaisScreen({super.key});

  @override
  State<GerenciamentoPaisScreen> createState() =>
      _GerenciamentoPaisScreenState();
}

class _GerenciamentoPaisScreenState extends State<GerenciamentoPaisScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  List<Map<String, dynamic>> _perfisFilhos = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _carregarPerfisFilhos();
  }

  // âœ… CORRIGIDO: LÃª do array perfisFilhos
  Future<void> _carregarPerfisFilhos() async {
    setState(() => _isLoading = true);

    try {
      final user = _auth.currentUser;
      if (user == null) {
        print('âŒ UsuÃ¡rio nÃ£o autenticado');
        setState(() => _isLoading = false);
        return;
      }

      print('ðŸ” Buscando perfis filhos para userId: ${user.uid}');

      // âœ… LÃª do documento do usuÃ¡rio (array)
      final userDoc = await _firestore.collection('users').doc(user.uid).get();

      if (!userDoc.exists) {
        print('âŒ Documento do usuÃ¡rio nÃ£o encontrado');
        setState(() => _isLoading = false);
        return;
      }

      final data = userDoc.data();
      final perfisFilhos = data?['perfisFilhos'] as List<dynamic>? ?? [];

      print('ðŸ“Š Total de perfis filhos encontrados: ${perfisFilhos.length}');

      setState(() {
        _perfisFilhos = perfisFilhos
            .map((perfil) => Map<String, dynamic>.from(perfil))
            .toList();
        _isLoading = false;
      });

      print('âœ… Perfis filhos carregados: ${_perfisFilhos.length}');
    } catch (e) {
      print('âŒ Erro ao carregar perfis filhos: $e');
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);
    final perfilProvider = Provider.of<PerfilProvider>(context);
    final userName = perfilProvider.perfilAtivoApelido ?? 'UsuÃ¡rio';
    final userAvatar = perfilProvider.perfilAtivoAvatar ?? 'assets/avatar1.png';

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: _isLoading
              ? const Center(
                  child: CircularProgressIndicator(color: Color(0xFFA9DBF4)),
                )
              : Column(
                  children: [
                    // AppBar
                    Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          const Spacer(),
                          const ThemeToggleButton(),
                          const SizedBox(width: 8),
                          GestureDetector(
                            onTap: _mostrarMenuPerfil,
                            child: CircleAvatar(
                              radius: 20,
                              backgroundImage: AssetImage(userAvatar),
                            ),
                          ),
                        ],
                      ),
                    ),

                    // Avatar e SaudaÃ§Ã£o
                    Padding(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 16,
                      ),
                      child: Row(
                        children: [
                          CircleAvatar(
                            radius: 30,
                            backgroundImage: AssetImage(userAvatar),
                          ),
                          const SizedBox(width: 16),
                          Text(
                            'OlÃ¡, $userName!',
                            style: TextStyle(
                              color: appTema.textColor,
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 20),

                    // TÃ­tulo
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: Align(
                        alignment: Alignment.centerLeft,
                        child: Text(
                          'Gerenciar Perfis Filhos',
                          style: TextStyle(
                            color: appTema.textColor,
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 16),

                    // Grade de perfis
                    Expanded(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 20),
                        child: _perfisFilhos.isEmpty
                            ? Center(
                                child: Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Icon(
                                      Icons.family_restroom,
                                      size: 80,
                                      color: appTema.textSecondaryColor,
                                    ),
                                    const SizedBox(height: 16),
                                    Text(
                                      'Nenhum perfil filho criado',
                                      style: TextStyle(
                                        fontSize: 18,
                                        fontWeight: FontWeight.bold,
                                        color: appTema.textColor,
                                      ),
                                    ),
                                    const SizedBox(height: 8),
                                    Text(
                                      'Toque no botÃ£o abaixo para adicionar',
                                      style: TextStyle(
                                        fontSize: 14,
                                        color: appTema.textSecondaryColor,
                                      ),
                                    ),
                                  ],
                                ),
                              )
                            : GridView.builder(
                                gridDelegate:
                                    const SliverGridDelegateWithFixedCrossAxisCount(
                                      crossAxisCount: 2,
                                      crossAxisSpacing: 16,
                                      mainAxisSpacing: 16,
                                      childAspectRatio: 0.85,
                                    ),
                                itemCount: _perfisFilhos.length + 1,
                                itemBuilder: (context, index) {
                                  if (index == _perfisFilhos.length) {
                                    return _buildCardAdicionarFamiliar(appTema);
                                  }

                                  final perfil = _perfisFilhos[index];
                                  return _buildCardPerfilFilho(
                                    perfil,
                                    appTema,
                                    index,
                                  );
                                },
                              ),
                      ),
                    ),

                    // BotÃ£o Ver CatÃ¡logo
                    Padding(
                      padding: const EdgeInsets.all(20),
                      child: SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton.icon(
                          onPressed: () => context.go('/catalogo'),
                          icon: const Icon(Icons.video_library, size: 24),
                          label: const Text(
                            'Ver CatÃ¡logo Completo',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFFA9DBF4),
                            foregroundColor: Colors.black,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                            elevation: 4,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGETS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Widget _buildCardAdicionarFamiliar(AppTema appTema) {
    return GestureDetector(
      onTap: () async {
        await context.push('/adicionar-perfis');
        if (!mounted) return;
        _carregarPerfisFilhos();
      },
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: appTema.isDarkMode
                ? [
                    Colors.white.withValues(alpha: 0.15),
                    Colors.white.withValues(alpha: 0.08),
                  ]
                : [
                    Colors.black.withValues(alpha: 0.08),
                    Colors.black.withValues(alpha: 0.05),
                  ],
          ),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: appTema.isDarkMode
                ? Colors.white.withValues(alpha: 0.3)
                : Colors.black.withValues(alpha: 0.15),
            width: 2,
            style: BorderStyle.solid,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.add_circle_outline, size: 60, color: appTema.textColor),
            const SizedBox(height: 12),
            Text(
              'Adicionar\nFamiliar',
              textAlign: TextAlign.center,
              style: TextStyle(
                color: appTema.textColor,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCardPerfilFilho(
    Map<String, dynamic> perfil,
    AppTema appTema,
    int index,
  ) {
    final apelido = perfil['apelido'] ?? 'Perfil';
    final avatar = perfil['avatar'] ?? 'assets/avatar1.png';

    return GestureDetector(
      onTap: () => _selecionarPerfilFilho(perfil),
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: appTema.isDarkMode
                ? [
                    Colors.white.withValues(alpha: 0.15),
                    Colors.white.withValues(alpha: 0.08),
                  ]
                : [
                    Colors.black.withValues(alpha: 0.08),
                    Colors.black.withValues(alpha: 0.05),
                  ],
          ),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: appTema.isDarkMode
                ? Colors.white.withValues(alpha: 0.25)
                : Colors.black.withValues(alpha: 0.15),
            width: 1.5,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            CircleAvatar(radius: 40, backgroundImage: AssetImage(avatar)),
            const SizedBox(height: 12),
            Text(
              apelido,
              textAlign: TextAlign.center,
              style: TextStyle(
                color: appTema.textColor,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 16),
            ElevatedButton(
              onPressed: () => _mostrarOpcoesEdicao(perfil, index),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFA9DBF4),
                foregroundColor: Colors.black,
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 8,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(20),
                ),
              ),
              child: const Text(
                'Editar',
                style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMenuItem({
    required IconData icon,
    required String label,
    required bool isDarkMode,
    required VoidCallback onTap,
    bool isDestructive = false,
  }) {
    final color = isDestructive
        ? Colors.red
        : (isDarkMode ? Colors.white : Colors.black);

    return InkWell(
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        child: Row(
          children: [
            Icon(icon, color: color, size: 22),
            const SizedBox(width: 14),
            Text(
              label,
              style: TextStyle(
                color: color,
                fontSize: 15,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AÃ‡Ã•ES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  void _mostrarMenuPerfil() {
    final appTema = Provider.of<AppTema>(context, listen: false);
    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);
    final userName = perfilProvider.perfilAtivoApelido ?? 'UsuÃ¡rio';
    final userAvatar = perfilProvider.perfilAtivoAvatar ?? 'assets/avatar1.png';

    showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.5),
      builder: (BuildContext context) {
        return Dialog(
          alignment: Alignment.topRight,
          insetPadding: const EdgeInsets.only(top: 70, right: 20),
          backgroundColor: Colors.transparent,
          child: Container(
            width: 280,
            decoration: BoxDecoration(
              color: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: appTema.isDarkMode
                        ? Colors.grey[850]
                        : Colors.grey[100],
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(12),
                      topRight: Radius.circular(12),
                    ),
                  ),
                  child: Row(
                    children: [
                      CircleAvatar(
                        radius: 28,
                        backgroundImage: AssetImage(userAvatar),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              userName,
                              style: TextStyle(
                                color: appTema.textColor,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              'Perfil Principal',
                              style: TextStyle(
                                color: appTema.textSecondaryColor,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),

                _buildMenuItem(
                  icon: Icons.account_circle_outlined,
                  label: 'Mudar Avatar',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/mudar-avatar');
                  },
                ),
                _buildMenuItem(
                  icon: Icons.people_outline,
                  label: 'Mudar Perfil',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/mudar-perfil');
                  },
                ),
                _buildMenuItem(
                  icon: Icons.person_add_outlined,
                  label: 'Adicionar Familiar',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () async {
                    Navigator.pop(context);
                    await context.push('/adicionar-perfis');
                    if (!mounted) return;
                    _carregarPerfisFilhos();
                  },
                ),
                _buildMenuItem(
                  icon: Icons.settings_outlined,
                  label: 'ConfiguraÃ§Ãµes',
                  isDarkMode: appTema.isDarkMode,
                  onTap: () {
                    Navigator.pop(context);
                    context.push('/perfil-configs');
                  },
                ),

                const Divider(height: 1),

                _buildMenuItem(
                  icon: Icons.logout,
                  label: 'Sair',
                  isDestructive: true,
                  isDarkMode: appTema.isDarkMode,
                  onTap: () async {
                    Navigator.pop(context);
                    _realizarLogout();
                  },
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  void _mostrarOpcoesEdicao(Map<String, dynamic> perfil, int index) {
    final appTema = Provider.of<AppTema>(context, listen: false);

    showModalBottomSheet(
      context: context,
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (modalContext) => Padding(
        padding: const EdgeInsets.symmetric(vertical: 20),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildMenuItem(
              icon: Icons.edit,
              label: 'Editar Perfil',
              isDarkMode: appTema.isDarkMode,
              onTap: () async {
                // âœ… Captura o navigator antes de operaÃ§Ãµes assÃ­ncronas
                final navigator = Navigator.of(modalContext);
                final scaffoldMessenger = ScaffoldMessenger.of(context);
                final router = GoRouter.of(context);

                navigator.pop();

                // âœ… CORREÃ‡ÃƒO: Recarrega dados antes de editar
                await _carregarPerfisFilhos();

                if (!mounted) return;

                // âœ… Verifica se o Ã­ndice ainda Ã© vÃ¡lido apÃ³s reload
                if (index >= _perfisFilhos.length) {
                  scaffoldMessenger.showSnackBar(
                    const SnackBar(
                      content: Text(
                        'Perfil nÃ£o encontrado. A lista foi atualizada.',
                      ),
                      backgroundColor: Colors.orange,
                    ),
                  );
                  return;
                }

                // âœ… SOLICITA PIN ANTES DE EDITAR
                if (!mounted) return;
                final pinVerificado = await VerificarPinDialog.verificar(
                  context,
                );
                if (!pinVerificado || !mounted) return;

                // âœ… NAVEGA PARA TELA DE EDIÃ‡ÃƒO com dados atualizados
                final resultado = await router.push(
                  '/editar-perfil-filho',
                  extra: {
                    'perfilIndex': index,
                    'perfilAtual':
                        _perfisFilhos[index], // Usa dados atualizados
                  },
                );

                // âœ… Se editou com sucesso, recarrega e atualiza provider se necessÃ¡rio
                if (resultado == true && mounted) {
                  await _carregarPerfisFilhos();

                  if (!mounted) return;

                  // âœ… CORREÃ‡ÃƒO: Atualiza provider se o perfil editado estiver ativo
                  final perfilProvider = Provider.of<PerfilProvider>(
                    context,
                    listen: false,
                  );

                  if (!perfilProvider.isPerfilPai &&
                      index < _perfisFilhos.length) {
                    final perfilEditado = _perfisFilhos[index];

                    // Se o perfil ativo foi editado, atualiza o provider
                    if (perfilProvider.perfilAtivoApelido ==
                        perfil['apelido']) {
                      await perfilProvider.setPerfilAtivo(
                        apelido: perfilEditado['apelido'],
                        avatar: perfilEditado['avatar'],
                        isPai: false,
                      );

                      if (!mounted) return;

                      scaffoldMessenger.showSnackBar(
                        const SnackBar(
                          content: Text(
                            'Perfil atualizado! As alteraÃ§Ãµes jÃ¡ estÃ£o ativas.',
                          ),
                          backgroundColor: Colors.green,
                        ),
                      );
                    }
                  }
                }
              },
            ),
            _buildMenuItem(
              icon: Icons.delete,
              label: 'Excluir Perfil',
              isDarkMode: appTema.isDarkMode,
              onTap: () {
                Navigator.of(modalContext).pop();
                _confirmarExclusao(index);
              },
              isDestructive: true,
            ),
          ],
        ),
      ),
    );
  }

  // âœ… CORRIGIDO: Seleciona perfil do array
  Future<void> _selecionarPerfilFilho(Map<String, dynamic> perfil) async {
    print("ðŸ”µ _selecionarPerfilFilho chamado");
    print("   Perfil selecionado: ${perfil['apelido']}");

    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);

    final apelido = perfil['apelido'] ?? 'UsuÃ¡rio';
    final avatar = perfil['avatar'] ?? 'assets/avatar1.png';

    print("   Apelido: $apelido");
    print("   Avatar: $avatar");

    // ðŸ”’ Solicita PIN do perfil PAI para trocar
    if (!mounted) return;

    final pinVerificado = await VerificarPinDialog.verificar(context);

    if (!mounted) return;

    if (!pinVerificado) {
      print("âŒ PIN nÃ£o verificado - cancelando troca de perfil");
      return;
    }

    print("âœ… PIN verificado - permitindo troca para perfil filho");

    await perfilProvider.setPerfilAtivo(
      apelido: apelido,
      avatar: avatar,
      isPai: false,
    );

    print("âœ… Perfil salvo");

    if (!mounted) return;

    context.go('/catalogo');
  }

  // âœ… CORRIGIDO: Exclui do array
  Future<void> _confirmarExclusao(int index) async {
    final appTema = Provider.of<AppTema>(context, listen: false);
    final perfil = _perfisFilhos[index];
    final apelido = perfil['apelido'] ?? 'este perfil';

    // Solicita PIN
    if (!mounted) return;
    final pinVerificado = await VerificarPinDialog.verificar(context);
    if (!pinVerificado) return;

    if (!mounted) return;

    // ConfirmaÃ§Ã£o
    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
        title: Row(
          children: [
            const Icon(
              Icons.warning_amber_rounded,
              color: Colors.orange,
              size: 28,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                'Excluir Perfil',
                style: TextStyle(color: appTema.textColor),
              ),
            ),
          ],
        ),
        content: Text(
          'Deseja realmente excluir o perfil "$apelido"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.',
          style: TextStyle(color: appTema.textSecondaryColor),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              'Cancelar',
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: const Text('Excluir'),
          ),
        ],
      ),
    );

    if (confirmar == true) {
      await _excluirPerfilFilho(index);
    }
  }

  // âœ… CORRIGIDO: Remove do array
  Future<void> _excluirPerfilFilho(int index) async {
    try {
      final user = _auth.currentUser;
      if (user == null) {
        _mostrarMensagem('UsuÃ¡rio nÃ£o autenticado');
        return;
      }

      final perfilExcluido = _perfisFilhos[index];
      final apelidoExcluido = perfilExcluido['apelido'];

      // Remove do array local
      _perfisFilhos.removeAt(index);

      // Atualiza no Firestore
      await _firestore.collection('users').doc(user.uid).update({
        'perfisFilhos': _perfisFilhos,
      });

      print("âœ… Perfil excluÃ­do com sucesso!");

      if (!mounted) return;

      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );

      // Se excluiu o perfil ativo, volta para o perfil pai
      if (perfilProvider.perfilAtivoApelido == apelidoExcluido) {
        final userDoc = await _firestore
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final data = userDoc.data();
          await perfilProvider.setPerfilAtivo(
            apelido: data?['apelido'] ?? 'UsuÃ¡rio',
            avatar: data?['avatar'] ?? 'assets/avatar1.png',
            isPai: true,
          );

          if (!mounted) return;

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text(
                'Perfil excluÃ­do! Voltando para o perfil principal.',
              ),
              backgroundColor: Colors.orange,
              duration: Duration(seconds: 3),
            ),
          );
        }
      } else {
        if (!mounted) return;

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Perfil "$apelidoExcluido" excluÃ­do com sucesso!'),
            backgroundColor: Colors.green,
            duration: const Duration(seconds: 2),
          ),
        );
      }

      if (mounted) {
        setState(() {});
      }
    } catch (e) {
      print("âŒ Erro ao excluir perfil: $e");
      if (!mounted) return;

      _mostrarMensagem('Erro ao excluir: ${e.toString()}');
    }
  }

  Future<void> _realizarLogout() async {
    try {
      await _auth.signOut();
      if (!mounted) return;
      context.go('/login');
    } catch (e) {
      _mostrarMensagem('Erro ao sair: $e');
    }
  }

  void _mostrarMensagem(String mensagem) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(mensagem), duration: const Duration(seconds: 3)),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\lista_videos_screen_youtube.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';
import 'video_model_youtube.dart';
import 'video_service_youtube.dart';

class ListaVideosYoutubeScreen extends StatefulWidget {
  final String genero;

  const ListaVideosYoutubeScreen({super.key, required this.genero});

  @override
  State<ListaVideosYoutubeScreen> createState() =>
      _ListaVideosYoutubeScreenState();
}

class _ListaVideosYoutubeScreenState extends State<ListaVideosYoutubeScreen> {
  final VideoServiceYoutube _videoService = VideoServiceYoutube();
  List<VideoModelYoutube> _videos = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _carregarVideos();
  }

  Future<void> _carregarVideos() async {
    setState(() => _isLoading = true);

    try {
      final videos = await _videoService.buscarVideosPorGenero(widget.genero);

      setState(() {
        _videos = videos;
        _isLoading = false;
      });
    } catch (e) {
      print('âŒ Erro ao carregar vÃ­deos: $e');
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      backgroundColor: appTema.backgroundColor,
      appBar: AppBar(
        backgroundColor: const Color(0xFFA9DBF4),
        foregroundColor: Colors.black,
        title: Text(
          widget.genero,
          style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, size: 28),
          onPressed: () => context.pop(),
        ),
        actions: const [
          Padding(
            padding: EdgeInsets.only(right: 16.0),
            child: ThemeToggleButton(),
          ),
        ],
      ),
      body: _isLoading
          ? const Center(
              child: CircularProgressIndicator(color: Color(0xFFA9DBF4)),
            )
          : _videos.isEmpty
          ? _buildEmptyState(appTema)
          : _buildListaVideos(appTema),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGET: ESTADO VAZIO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Widget _buildEmptyState(AppTema appTema) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.video_library_outlined,
            size: 80,
            color: appTema.textSecondaryColor,
          ),
          const SizedBox(height: 16),
          Text(
            'Nenhum vÃ­deo encontrado',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: appTema.textColor,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Ainda nÃ£o hÃ¡ vÃ­deos neste gÃªnero',
            style: TextStyle(fontSize: 16, color: appTema.textSecondaryColor),
          ),
        ],
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGET: LISTA DE VÃDEOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Widget _buildListaVideos(AppTema appTema) {
    return RefreshIndicator(
      onRefresh: _carregarVideos,
      color: const Color(0xFFA9DBF4),
      child: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: _videos.length,
        itemBuilder: (context, index) {
          final video = _videos[index];
          return _buildVideoCard(video, appTema);
        },
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WIDGET: CARD DE VÃDEO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Widget _buildVideoCard(VideoModelYoutube video, AppTema appTema) {
    return GestureDetector(
      onTap: () => _abrirPlayer(video),
      child: Container(
        margin: const EdgeInsets.only(bottom: 16),
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.white.withValues(alpha: 0.1)
              : Colors.black.withValues(alpha: 0.05),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: appTema.isDarkMode
                ? Colors.white.withValues(alpha: 0.2)
                : Colors.black.withValues(alpha: 0.1),
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Thumbnail do YouTube
            ClipRRect(
              borderRadius: const BorderRadius.only(
                topLeft: Radius.circular(16),
                topRight: Radius.circular(16),
              ),
              child: Stack(
                children: [
                  // Imagem da thumbnail
                  Image.network(
                    video.thumbnailUrl,
                    width: double.infinity,
                    height: 200,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        width: double.infinity,
                        height: 200,
                        color: Colors.grey.shade800,
                        child: const Icon(
                          Icons.video_library,
                          size: 60,
                          color: Colors.white54,
                        ),
                      );
                    },
                  ),
                  // Ãcone de play
                  Positioned.fill(
                    child: Container(
                      color: Colors.black.withValues(alpha: 0.3),
                      child: const Icon(
                        Icons.play_circle_outline,
                        size: 60,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // InformaÃ§Ãµes do vÃ­deo
            Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // TÃ­tulo
                  Text(
                    video.titulo,
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: appTema.textColor,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),

                  const SizedBox(height: 8),

                  // DescriÃ§Ã£o
                  if (video.descricao.isNotEmpty)
                    Text(
                      video.descricao,
                      style: TextStyle(
                        fontSize: 14,
                        color: appTema.textSecondaryColor,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),

                  const SizedBox(height: 12),

                  // GÃªneros
                  Wrap(
                    spacing: 8,
                    children: video.generos.map((genero) {
                      return Chip(
                        label: Text(
                          genero,
                          style: const TextStyle(fontSize: 12),
                        ),
                        backgroundColor: const Color(0xFFA9DBF4),
                        padding: const EdgeInsets.symmetric(horizontal: 8),
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                      );
                    }).toList(),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AÃ‡ÃƒO: ABRIR PLAYER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  void _abrirPlayer(VideoModelYoutube video) {
    // Registra visualizaÃ§Ã£o
    final user = FirebaseAuth.instance.currentUser;
    if (user != null) {
      _videoService.registrarVisualizacao(video.id, user.uid);
    }

    // Navega para o player
    context.push('/player', extra: video);
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\login.dart
// ========================================
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();

  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _senhaController = TextEditingController();

  bool _obscurePassword = true;
  bool _isLoading = false;

  @override
  void dispose() {
    _emailController.dispose();
    _senhaController.dispose();
    super.dispose();
  }

  Future<void> _login() async {
    if (_formKey.currentState!.validate()) {
      setState(() => _isLoading = true);
      try {
        UserCredential userCredential = await FirebaseAuth.instance
            .signInWithEmailAndPassword(
              email: _emailController.text.trim(),
              password: _senhaController.text.trim(),
            );

        print(
          "Login realizado com sucesso! UsuÃ¡rio: ${userCredential.user?.email}",
        );

        if (!mounted) return;

        // âœ… DEBUG: Verifica tema apÃ³s login
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        print("âœ… LOGIN BEM-SUCEDIDO");

        final appTema = Provider.of<AppTema>(context, listen: false);
        print(
          "   Tema ANTES de carregar do Firestore: ${appTema.isDarkMode ? 'Escuro' : 'Claro'}",
        );

        // âœ… CARREGA TEMA DO FIRESTORE IMEDIATAMENTE
        await appTema.loadThemeFromFirestore();

        print(
          "   Tema DEPOIS de carregar do Firestore: ${appTema.isDarkMode ? 'Escuro' : 'Claro'}",
        );

        final prefs = await SharedPreferences.getInstance();
        final temaNoStorage = prefs.getBool('isDarkMode');
        print("   Tema no SharedPreferences: $temaNoStorage");
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        final user = userCredential.user;
        if (user != null) {
          final userDoc = await FirebaseFirestore.instance
              .collection('users')
              .doc(user.uid)
              .get();

          if (!mounted) return;

          if (!userDoc.exists) {
            await FirebaseFirestore.instance
                .collection('users')
                .doc(user.uid)
                .set({
                  'uid': user.uid,
                  'email': user.email,
                  'apelido': null,
                  'avatar': null,
                  'createdAt': FieldValue.serverTimestamp(),
                });

            if (!mounted) return;
            print("Documento nÃ£o existia. Redirecionando para /avatar");
            context.go('/avatar');
            return;
          }

          final userData = userDoc.data();

          if (userData?['apelido'] == null || userData?['avatar'] == null) {
            print("Perfil incompleto. Redirecionando para /avatar");
            context.go('/avatar');
          } else {
            print("Perfil completo! Verificando Ãºltimo perfil ativo...");

            // âœ… NOVA LÃ“GICA: Carrega o Ãºltimo perfil ativo e redireciona
            final perfilProvider = Provider.of<PerfilProvider>(
              context,
              listen: false,
            );

            // Se nÃ£o tem perfil ativo salvo, usa o perfil pai como padrÃ£o
            if (perfilProvider.perfilAtivoApelido == null) {
              print(
                "âš ï¸ Nenhum perfil ativo salvo. Usando perfil pai como padrÃ£o",
              );
              await perfilProvider.setPerfilAtivo(
                apelido: userData?['apelido'] ?? 'UsuÃ¡rio',
                avatar: userData?['avatar'] ?? 'assets/avatar1.png',
                isPai: true,
              );
            }

            if (!mounted) return;

            // Redireciona baseado no tipo de perfil
            if (perfilProvider.isPerfilPai) {
              print("ðŸ‘¨ Perfil PAI - Redirecionando para /gerenciamento-pais");
              context.go('/gerenciamento-pais');
            } else {
              print("ðŸ‘¶ Perfil FILHO - Redirecionando para /catalogo");
              context.go('/catalogo');
            }
          }
        }
      } on FirebaseAuthException catch (e) {
        String mensagem;
        if (e.code == 'user-not-found') {
          mensagem = 'Nenhum usuÃ¡rio encontrado com esse email.';
        } else if (e.code == 'wrong-password') {
          mensagem = 'Senha incorreta.';
        } else if (e.code == 'invalid-credential') {
          mensagem = 'Credenciais invÃ¡lidas. Verifique email e senha.';
        } else if (e.code == 'invalid-email') {
          mensagem = 'E-mail invÃ¡lido.';
        } else if (e.code == 'user-disabled') {
          mensagem = 'Esta conta foi desabilitada.';
        } else if (e.code == 'too-many-requests') {
          mensagem = 'Muitas tentativas. Tente novamente mais tarde.';
        } else {
          mensagem = 'Erro ao fazer login: ${e.message}';
        }

        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(mensagem),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      } catch (e) {
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Erro inesperado: ${e.toString()}'),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      } finally {
        if (mounted) {
          setState(() => _isLoading = false);
        }
      }
    }
  }

  String? _validarEmail(String? valor) {
    if (valor == null || valor.trim().isEmpty) {
      return "E-mail Ã© obrigatÃ³rio";
    }
    final emailRegex = RegExp(r"^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$");
    if (!emailRegex.hasMatch(valor.trim())) {
      return "E-mail invÃ¡lido";
    }
    return null;
  }

  String? _validarSenha(String? valor) {
    if (valor == null || valor.trim().isEmpty) {
      return "Senha Ã© obrigatÃ³ria";
    }
    return null;
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar - apenas botÃ£o de tema
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                  ],
                ),
              ),

              Expanded(
                child: Center(
                  child: SingleChildScrollView(
                    child: Form(
                      key: _formKey,
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Image.asset("assets/logo.png", width: 200),
                          const SizedBox(height: 16),
                          Text(
                            "FaÃ§a login na sua conta",
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: appTema.textColor,
                            ),
                          ),
                          const SizedBox(height: 30),

                          // Campo E-mail
                          _buildTextField(
                            controller: _emailController,
                            hint: "E-mail",
                            validator: _validarEmail,
                          ),
                          const SizedBox(height: 16),

                          // Campo Senha
                          _buildTextField(
                            controller: _senhaController,
                            hint: "Senha",
                            obscure: _obscurePassword,
                            suffixIcon: IconButton(
                              icon: Icon(
                                _obscurePassword
                                    ? Icons.visibility_off
                                    : Icons.visibility,
                              ),
                              onPressed: () {
                                setState(() {
                                  _obscurePassword = !_obscurePassword;
                                });
                              },
                            ),
                            validator: _validarSenha,
                          ),
                          const SizedBox(height: 30),

                          // BotÃ£o Entrar
                          SizedBox(
                            width: 200,
                            height: 50,
                            child: ElevatedButton(
                              onPressed: _isLoading ? null : _login,
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFFA9DBF4),
                                foregroundColor: Colors.black,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 4,
                                shadowColor: Colors.black.withValues(
                                  alpha: 77 / 255,
                                ),
                              ),
                              child: _isLoading
                                  ? const SizedBox(
                                      width: 24,
                                      height: 24,
                                      child: CircularProgressIndicator(
                                        color: Colors.black,
                                        strokeWidth: 2.5,
                                      ),
                                    )
                                  : const Text(
                                      "Entrar",
                                      style: TextStyle(fontSize: 18),
                                    ),
                            ),
                          ),

                          const SizedBox(height: 16),

                          // BotÃ£o Voltar
                          SizedBox(
                            width: 200,
                            height: 50,
                            child: ElevatedButton(
                              onPressed: _isLoading
                                  ? null
                                  : () {
                                      context.go('/options');
                                    },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFFA9DBF4),
                                foregroundColor: Colors.black,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 4,
                                shadowColor: Colors.black.withValues(
                                  alpha: 77 / 255,
                                ),
                              ),
                              child: const Text(
                                "Voltar",
                                style: TextStyle(fontSize: 18),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? Function(String?)? validator,
    bool obscure = false,
    Widget? suffixIcon,
  }) {
    return SizedBox(
      width: 300,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
          child: TextFormField(
            controller: controller,
            obscureText: obscure,
            validator: validator,
            decoration: InputDecoration(
              filled: true,
              fillColor: Colors.white.withValues(alpha: 80 / 255),
              hintText: hint,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
              suffixIcon: suffixIcon,
            ),
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\main.dart
// ========================================
import 'package:bluflix/admin_gerenciar_videos_screen.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:provider/provider.dart';
import 'firebase_options.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'mudar_avatar.dart';
import 'splash.dart';
import 'options.dart';
import 'login.dart';
import 'cadastro.dart';
import 'avatar.dart';
import 'apelido.dart';
import 'catalogo.dart';
import 'adicionar_perfis.dart';
import 'avatar_filho.dart';
import 'apelido_filho.dart';
import 'mudar_perfil.dart';
import 'gerenciamento_pais.dart';
import 'perfil_configs.dart';
import 'perfilpai_configs.dart';
import 'seguranca_config.dart';
import 'tema_config.dart';
import 'criapin.dart';
import 'preferencias_filho.dart';
import 'video_model_youtube.dart';
import 'lista_videos_screen_youtube.dart';
import 'video_player_youtube_screen.dart';
import 'admin_add_video_screen.dart';
import 'admin_listar_videos_screen.dart';
import 'editar_perfil_filho.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  print("Firebase inicializado com sucesso!");
  runApp(const BluFlixApp());
}

class BluFlixApp extends StatelessWidget {
  const BluFlixApp({super.key});

  @override
  Widget build(BuildContext context) {
    final router = GoRouter(
      initialLocation: '/splash',
      routes: [
        GoRoute(
          path: '/splash',
          builder: (context, state) => const SplashScreen(),
        ),
        GoRoute(
          path: '/options',
          builder: (context, state) => const OptionsScreen(),
        ),
        GoRoute(
          path: '/login',
          builder: (context, state) => const LoginScreen(),
        ),
        GoRoute(
          path: '/preferencias-filho',
          builder: (context, state) {
            final extra = state.extra as Map<String, String>;
            return PreferenciasFilhoScreen(
              apelido: extra['apelido']!,
              avatar: extra['avatar']!,
            );
          },
        ),
        GoRoute(
          path: '/cadastro',
          builder: (context, state) => const CadastroScreen(),
        ),
        GoRoute(
          path: '/criapin',
          builder: (context, state) {
            final extra = state.extra as Map<String, String>;
            return CriaPinScreen(
              apelido: extra['apelido']!,
              avatar: extra['avatar']!,
            );
          },
        ),
        GoRoute(
          path: '/avatar',
          builder: (context, state) => const AvatarScreen(),
        ),
        GoRoute(
          path: '/apelido',
          builder: (context, state) {
            final avatar = state.extra as String?;
            return ApelidoScreen(
              selectedAvatar: avatar ?? 'assets/avatar1.png',
            );
          },
        ),
        GoRoute(
          path: '/catalogo',
          builder: (context, state) => const CatalogoScreen(),
        ),
        GoRoute(
          path: '/adicionar-perfis',
          builder: (context, state) => const AdicionarPerfisScreen(),
        ),
        GoRoute(
          path: '/avatar-filho',
          builder: (context, state) => const AvatarFilhoScreen(),
        ),
        GoRoute(
          path: '/apelido-filho',
          builder: (context, state) {
            final avatar = state.extra as String?;
            return ApelidoFilhoScreen(
              selectedAvatar: avatar ?? 'assets/avatar_crianca1.png',
            );
          },
        ),
        GoRoute(
          path: '/mudar-perfil',
          builder: (context, state) => const MudarPerfilScreen(),
        ),
        GoRoute(
          path: '/gerenciamento-pais',
          builder: (context, state) => const GerenciamentoPaisScreen(),
        ),
        GoRoute(
          path: '/perfil-configs',
          builder: (context, state) => const PerfilConfigsScreen(),
        ),
        GoRoute(
          path: '/perfilpai-configs',
          builder: (context, state) => const PerfilPaiConfigsScreen(),
        ),
        GoRoute(
          path: '/mudar-avatar',
          builder: (context, state) => const MudarAvatarScreen(),
        ),
        GoRoute(
          path: '/seguranca-config',
          builder: (context, state) => const SegurancaConfigScreen(),
        ),
        // Lista de vÃ­deos por gÃªnero (versÃ£o YouTube)
        GoRoute(
          path: '/videos/:genero',
          builder: (context, state) {
            final genero = state.pathParameters['genero']!;
            return ListaVideosYoutubeScreen(genero: genero); // âœ… Nova versÃ£o
          },
        ),
        // Editar perfil filho
        GoRoute(
          path: '/editar-perfil-filho',
          builder: (context, state) {
            final extra = state.extra as Map<String, dynamic>;
            return EditarPerfilFilhoScreen(
              perfilIndex: extra['perfilIndex'] as int,
              perfilAtual: extra['perfilAtual'] as Map<String, dynamic>,
            );
          },
        ),

        // Player do YouTube
        GoRoute(
          path: '/player',
          builder: (context, state) {
            final video = state.extra as VideoModelYoutube; // âœ… Modelo YouTube
            return VideoPlayerYoutubeScreen(video: video); // âœ… Player YouTube
          },
        ),
        // ðŸŽ¬ ROTAS ADMIN - Gerenciamento de VÃ­deos
        GoRoute(
          path: '/admin/gerenciar-videos',
          name: 'admin-gerenciar-videos',
          builder: (context, state) => const AdminGerenciarVideosScreen(),
        ),

        GoRoute(
          path: '/admin/adicionar-video',
          name: 'admin-adicionar-video',
          builder: (context, state) => const AdminAddVideoScreen(),
        ),

        // Adicionar vÃ­deo (admin) - apenas cola o link
        GoRoute(
          path: '/admin-add-video',
          builder: (context, state) => const AdminAddVideoScreen(),
        ),
        // Gerenciar vÃ­deos (admin) - listar e gerenciar
        GoRoute(
          path: '/admin-videos',
          builder: (context, state) => const AdminListarVideosScreen(),
        ),
        GoRoute(
          path: '/tema-config',
          builder: (context, state) => const TemaConfigScreen(),
        ),
      ],
    );

    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AppTema()),
        ChangeNotifierProvider(create: (_) => PerfilProvider()),
      ],
      child: Consumer<AppTema>(
        builder: (context, appTema, _) {
          return MaterialApp.router(
            title: 'BluFlix',
            debugShowCheckedModeBanner: false,
            theme: ThemeData(
              brightness: appTema.isDarkMode
                  ? Brightness.dark
                  : Brightness.light,
              scaffoldBackgroundColor: appTema.backgroundColor,
              textTheme: TextTheme(
                bodyLarge: TextStyle(color: appTema.textColor),
                bodyMedium: TextStyle(color: appTema.textColor),
              ),
            ),
            routerConfig: router,
          );
        },
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\mudar_avatar.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';

class MudarAvatarScreen extends StatefulWidget {
  const MudarAvatarScreen({super.key});

  @override
  State<MudarAvatarScreen> createState() => _MudarAvatarScreenState();
}

class _MudarAvatarScreenState extends State<MudarAvatarScreen>
    with SingleTickerProviderStateMixin {
  String? _selectedAvatar;
  bool _isLoading = false;
  late AnimationController _controller;
  late Animation<double> _animation;

  final List<String> avatars = [
    "assets/avatar1.png",
    "assets/avatar2.png",
    "assets/avatar3.png",
    "assets/avatar4.png",
    "assets/avatar5.png",
    "assets/avatar6.png",
    "assets/avatar7.png",
    "assets/avatar8.png",
  ];

  @override
  void initState() {
    super.initState();

    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);
    
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("ðŸŽ¨ MUDAR AVATAR - INIT STATE");
    print("   Perfil Ativo: ${perfilProvider.perfilAtivoApelido}");
    print("   Avatar Atual: ${perfilProvider.perfilAtivoAvatar}");
    print("   Ã‰ Pai?: ${perfilProvider.isPerfilPai}");
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    _selectedAvatar = perfilProvider.perfilAtivoAvatar ?? avatars[0];

    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 1),
    )..repeat(reverse: true);

    _animation = Tween<double>(
      begin: 0,
      end: 20,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  Future<void> _salvarAvatar() async {
    if (_selectedAvatar == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Por favor, selecione um avatar'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        throw Exception('UsuÃ¡rio nÃ£o autenticado');
      }

      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );

      if (perfilProvider.perfilAtivoApelido == null) {
        throw Exception('Nenhum perfil ativo encontrado');
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸ’¾ SALVANDO AVATAR");
      print("   Avatar selecionado: $_selectedAvatar");
      print("   Perfil: ${perfilProvider.perfilAtivoApelido}");
      print("   Ã‰ Pai?: ${perfilProvider.isPerfilPai}");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (perfilProvider.isPerfilPai) {
        print("   â†’ Salvando avatar do PERFIL PAI");
        
        await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .update({'avatar': _selectedAvatar});

        print("   âœ… Avatar salvo no Firestore");

        await perfilProvider.setPerfilAtivo(
          apelido: perfilProvider.perfilAtivoApelido!,
          avatar: _selectedAvatar!,
          isPai: true,
        );

        print("   âœ… Provider atualizado");
      } else {
        print("   â†’ Salvando avatar do PERFIL FILHO");
        
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (!userDoc.exists) {
          throw Exception('Documento do usuÃ¡rio nÃ£o encontrado');
        }

        final data = userDoc.data();
        List<dynamic> perfisFilhos = data?['perfisFilhos'] ?? [];

        print("   â†’ Total de perfis filhos: ${perfisFilhos.length}");

        bool perfilEncontrado = false;
        for (int i = 0; i < perfisFilhos.length; i++) {
          if (perfisFilhos[i]['apelido'] == perfilProvider.perfilAtivoApelido) {
            perfisFilhos[i]['avatar'] = _selectedAvatar;
            perfilEncontrado = true;
            print("   âœ… Perfil filho encontrado no Ã­ndice $i");
            break;
          }
        }

        if (!perfilEncontrado) {
          throw Exception('Perfil filho nÃ£o encontrado na lista');
        }

        await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .update({'perfisFilhos': perfisFilhos});

        print("   âœ… Avatar salvo no Firestore");

        await perfilProvider.setPerfilAtivo(
          apelido: perfilProvider.perfilAtivoApelido!,
          avatar: _selectedAvatar!,
          isPai: false,
        );

        print("   âœ… Provider atualizado");
      }

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (!mounted) return;

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Avatar atualizado com sucesso!'),
          backgroundColor: Colors.green,
          duration: Duration(seconds: 2),
        ),
      );

      context.pop();
    } catch (e) {
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print('âŒ ERRO AO SALVAR AVATAR: $e');
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      
      if (!mounted) return;

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Erro ao atualizar: ${e.toString()}'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false),
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 20),

              Text(
                "Escolha seu novo avatar",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: appTema.textColor,
                ),
              ),

              const SizedBox(height: 30),

              Expanded(
                child: GridView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 40),
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 20,
                    mainAxisSpacing: 20,
                  ),
                  itemCount: avatars.length,
                  itemBuilder: (context, index) {
                    final avatar = avatars[index];
                    final isSelected = _selectedAvatar == avatar;

                    return GestureDetector(
                      onTap: () {
                        setState(() {
                          _selectedAvatar = avatar;
                        });
                      },
                      child: AnimatedBuilder(
                        animation: _animation,
                        builder: (context, child) {
                          double offset = isSelected ? -_animation.value : 0;
                          return Transform.translate(
                            offset: Offset(0, offset),
                            child: Container(
                              padding: isSelected
                                  ? const EdgeInsets.all(4)
                                  : null,
                              decoration: isSelected
                                  ? BoxDecoration(
                                      shape: BoxShape.circle,
                                      border: Border.all(
                                        color: const Color(0xFFA9DBF4),
                                        width: 4,
                                      ),
                                    )
                                  : null,
                              child: ClipOval(
                                child: Image.asset(avatar, fit: BoxFit.cover),
                              ),
                            ),
                          );
                        },
                      ),
                    );
                  },
                ),
              ),

              Padding(
                padding: const EdgeInsets.all(20.0),
                child: SizedBox(
                  width: double.infinity,
                  height: 50,
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _salvarAvatar,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFA9DBF4),
                      foregroundColor: Colors.black,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: _isLoading
                        ? const SizedBox(
                            width: 24,
                            height: 24,
                            child: CircularProgressIndicator(
                              color: Colors.black,
                              strokeWidth: 2.5,
                            ),
                          )
                        : const Text(
                            "Salvar Avatar",
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\mudar_perfil.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';
import 'pin_verification.dart';

class MudarPerfilScreen extends StatefulWidget {
  const MudarPerfilScreen({super.key});

  @override
  State<MudarPerfilScreen> createState() => _MudarPerfilScreenState();
}

class _MudarPerfilScreenState extends State<MudarPerfilScreen> {
  bool _isLoading = true;
  Map<String, dynamic>? _perfilPai;
  List<Map<String, dynamic>> _perfisFilhos = [];

  @override
  void initState() {
    super.initState();
    _carregarPerfis();
  }

  Future<void> _carregarPerfis() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final data = userDoc.data();

          if (mounted) {
            setState(() {
              _perfilPai = {
                'apelido': data?['apelido'] ?? 'UsuÃ¡rio',
                'avatar': data?['avatar'] ?? 'assets/avatar1.png',
                'tipo': 'pai',
              };

              final perfis = data?['perfisFilhos'] as List<dynamic>? ?? [];
              _perfisFilhos = perfis
                  .map((p) => Map<String, dynamic>.from(p))
                  .toList();
              _isLoading = false;
            });
          }
        }
      }
    } catch (e) {
      print('Erro ao carregar perfis: $e');
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  Future<void> _selecionarPerfil(Map<String, dynamic> perfil) async {
    print("ðŸ”µ _selecionarPerfil chamado");
    print("   Perfil selecionado: ${perfil['apelido']}");

    final perfilProvider = Provider.of<PerfilProvider>(context, listen: false);

    final apelido = perfil['apelido'] ?? 'UsuÃ¡rio';
    final avatar = perfil['avatar'] ?? 'assets/avatar1.png';
    final isPai = perfil['tipo'] == 'pai';

    print("   Apelido: $apelido");
    print("   Avatar: $avatar");
    print("   IsPai: $isPai");

    // ðŸ”’ PROTEÃ‡ÃƒO: Se estÃ¡ em perfil filho e quer ir para perfil pai, pede PIN
    if (!perfilProvider.isPerfilPai && isPai) {
      print("ðŸ”’ Tentando voltar para perfil pai - solicitando PIN");

      if (!mounted) return;

      final pinVerificado = await VerificarPinDialog.verificar(context);

      if (!mounted) return;

      if (!pinVerificado) {
        print("âŒ PIN nÃ£o verificado - cancelando troca de perfil");
        return;
      }

      print("âœ… PIN verificado - permitindo troca para perfil pai");
    }

    // Salva o perfil ativo
    await perfilProvider.setPerfilAtivo(
      apelido: apelido,
      avatar: avatar,
      isPai: isPai,
    );

    print("âœ… Perfil salvo");

    if (!mounted) return;

    // âœ… Navega baseado no tipo de perfil
    print("ðŸ“ Navegando para tela apropriada...");
    if (isPai) {
      context.go('/gerenciamento-pais'); // ðŸ‘¨ Perfil pai
    } else {
      context.go('/catalogo'); // ðŸ‘¶ Perfil filho
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    if (_isLoading) {
      return Scaffold(
        backgroundColor: appTema.backgroundColor,
        body: Center(
          child: CircularProgressIndicator(color: const Color(0xFFA9DBF4)),
        ),
      );
    }

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              // TÃ­tulo
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Text(
                  'Quem estÃ¡ assistindo?',
                  style: TextStyle(
                    color: appTema.textColor,
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),

              const SizedBox(height: 20),

              // Lista de perfis
              Expanded(
                child: SingleChildScrollView(
                  child: Column(
                    children: [
                      // Perfil Pai
                      if (_perfilPai != null) ...[
                        _buildPerfilCard(_perfilPai!, appTema, isPai: true),
                        const SizedBox(height: 20),
                      ],

                      // Perfis Filhos
                      if (_perfisFilhos.isNotEmpty) ...[
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 40.0),
                          child: Text(
                            'Perfis Familiares',
                            style: TextStyle(
                              color: appTema.textSecondaryColor,
                              fontSize: 18,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                        const SizedBox(height: 16),
                        ...(_perfisFilhos.map(
                          (perfil) => Padding(
                            padding: const EdgeInsets.only(bottom: 16.0),
                            child: _buildPerfilCard(perfil, appTema),
                          ),
                        )),
                      ],

                      // Mensagem se nÃ£o houver perfis filhos
                      if (_perfisFilhos.isEmpty)
                        Padding(
                          padding: const EdgeInsets.all(40.0),
                          child: Column(
                            children: [
                              Icon(
                                Icons.family_restroom,
                                size: 80,
                                color: appTema.textColor.withValues(alpha: 0.3),
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'Nenhum perfil familiar criado',
                                textAlign: TextAlign.center,
                                style: TextStyle(
                                  color: appTema.textSecondaryColor,
                                  fontSize: 16,
                                ),
                              ),
                              const SizedBox(height: 24),
                              ElevatedButton.icon(
                                onPressed: () {
                                  context.push('/adicionar-perfis');
                                },
                                icon: const Icon(
                                  Icons.add,
                                  color: Colors.black,
                                ),
                                label: const Text(
                                  'Adicionar Familiar',
                                  style: TextStyle(color: Colors.black),
                                ),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: const Color(0xFFA9DBF4),
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 24,
                                    vertical: 12,
                                  ),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                    ],
                  ),
                ),
              ),

              // BotÃ£o Voltar
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: SizedBox(
                  width: 200,
                  height: 50,
                  child: ElevatedButton(
                    onPressed: () => context.pop(),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFA9DBF4),
                      foregroundColor: Colors.black,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text('Voltar', style: TextStyle(fontSize: 16)),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPerfilCard(
    Map<String, dynamic> perfil,
    AppTema appTema, {
    bool isPai = false,
  }) {
    return GestureDetector(
      onTap: () => _selecionarPerfil(perfil),
      child: Container(
        width: 300,
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.5)
              : Colors.white.withValues(alpha: 0.7),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
            width: 2,
          ),
        ),
        child: Row(
          children: [
            // Avatar
            Stack(
              children: [
                CircleAvatar(
                  radius: 40,
                  backgroundImage: AssetImage(
                    perfil['avatar'] ?? 'assets/avatar1.png',
                  ),
                ),
                if (isPai)
                  Positioned(
                    bottom: 0,
                    right: 0,
                    child: Container(
                      padding: const EdgeInsets.all(4),
                      decoration: BoxDecoration(
                        color: const Color(0xFFA9DBF4),
                        shape: BoxShape.circle,
                        border: Border.all(color: Colors.white, width: 2),
                      ),
                      child: const Icon(
                        Icons.star,
                        size: 16,
                        color: Colors.black,
                      ),
                    ),
                  ),
              ],
            ),
            const SizedBox(width: 20),
            // Nome e tipo
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    perfil['apelido'] ?? 'Sem nome',
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    isPai ? 'Perfil Principal' : 'Perfil Filho',
                    style: TextStyle(
                      color: appTema.textSecondaryColor,
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
            ),
            // Ãcone de seta
            Icon(
              Icons.arrow_forward_ios,
              color: appTema.textSecondaryColor,
              size: 20,
            ),
          ],
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\options.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';

class OptionsScreen extends StatelessWidget {
  const OptionsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(
              appTema.isDarkMode
                  ? "assets/night_background.png"
                  : "assets/morning_background.png",
            ),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // BotÃ£o de tema no canto superior direito
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                  ],
                ),
              ),

              const Spacer(),

              // Logo BluFlix
              Image.asset("assets/logo.png", height: 100),

              const SizedBox(height: 60),

              // BotÃ£o Entrar
              SizedBox(
                width: 200,
                height: 50,
                child: ElevatedButton(
                  onPressed: () {
                    context.push('/login');
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFA9DBF4), // Azul claro
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                    shadowColor: Colors.black.withValues(alpha: 77 / 255),
                  ),
                  child: const Text(
                    "Entrar",
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                ),
              ),

              const SizedBox(height: 20),

              // BotÃ£o Cadastrar
              SizedBox(
                width: 200,
                height: 50,
                child: ElevatedButton(
                  onPressed: () {
                    context.push('/cadastro');
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFA9DBF4), // Azul claro
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                    shadowColor: Colors.black.withValues(alpha: 77 / 255),
                  ),
                  child: const Text(
                    "Cadastrar",
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                ),
              ),

              const Spacer(),
            ],
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\perfilpai_configs.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';

class PerfilPaiConfigsScreen extends StatefulWidget {
  const PerfilPaiConfigsScreen({super.key});

  @override
  State<PerfilPaiConfigsScreen> createState() => _PerfilPaiConfigsScreenState();
}

class _PerfilPaiConfigsScreenState extends State<PerfilPaiConfigsScreen> {
  bool _isLoading = true;
  String _apelido = '';
  String _email = '';

  @override
  void initState() {
    super.initState();
    _carregarDados();
  }

  Future<void> _carregarDados() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (mounted) {
          setState(() {
            _apelido = userDoc.data()?['apelido'] ?? 'UsuÃ¡rio';
            _email = user.email ?? '';
            _isLoading = false;
          });
        }
      }
    } catch (e) {
      print('Erro ao carregar dados: $e');
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  Future<void> _alterarSenha() async {
    final senhaAtualController = TextEditingController();
    final novaSenhaController = TextEditingController();
    final confirmarSenhaController = TextEditingController();

    final resultado = await showDialog<bool>(
      context: context,
      builder: (dialogContext) => _AlterarSenhaDialog(
        senhaAtualController: senhaAtualController,
        novaSenhaController: novaSenhaController,
        confirmarSenhaController: confirmarSenhaController,
      ),
    );

    if (resultado == true && mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Senha alterada com sucesso!'),
          backgroundColor: Colors.green,
        ),
      );
    }
  }

  Future<void> _alterarApelido() async {
    final apelidoController = TextEditingController(text: _apelido);

    final novoApelido = await showDialog<String>(
      context: context,
      builder: (dialogContext) =>
          _AlterarApelidoDialog(apelidoController: apelidoController),
    );

    if (novoApelido != null && novoApelido.isNotEmpty && mounted) {
      setState(() {
        _apelido = novoApelido;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Apelido alterado com sucesso!'),
          backgroundColor: Colors.green,
        ),
      );
    }
  }

  Future<void> _excluirConta() async {
    final confirmar = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (dialogContext) => _ConfirmarExclusaoDialog(),
    );

    if (confirmar == true && mounted) {
      // Solicita senha para confirmaÃ§Ã£o final
      final senhaController = TextEditingController();

      final senhaConfirmada = await showDialog<bool>(
        context: context,
        barrierDismissible: false,
        builder: (dialogContext) => _ConfirmarSenhaDialog(
          senhaController: senhaController,
          email: _email,
        ),
      );

      if (senhaConfirmada == true && mounted) {
        // Exclui a conta
        setState(() => _isLoading = true);

        try {
          final user = FirebaseAuth.instance.currentUser;
          if (user != null) {
            // Exclui documento do Firestore
            await FirebaseFirestore.instance
                .collection('users')
                .doc(user.uid)
                .delete();

            // Exclui conta do Firebase Auth
            await user.delete();

            if (mounted) {
              // Navega para options.dart
              context.go('/options');

              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(
                  content: Text('Conta excluÃ­da com sucesso'),
                  backgroundColor: Colors.green,
                ),
              );
            }
          }
        } catch (e) {
          if (mounted) {
            setState(() => _isLoading = false);
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Erro ao excluir conta: $e'),
                backgroundColor: Colors.red,
              ),
            );
          }
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    if (_isLoading) {
      return Scaffold(
        backgroundColor: appTema.backgroundColor,
        body: Center(
          child: CircularProgressIndicator(color: const Color(0xFFA9DBF4)),
        ),
      );
    }

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20.0),
                  child: Column(
                    children: [
                      // Card de informaÃ§Ãµes
                      Container(
                        padding: const EdgeInsets.all(20),
                        decoration: BoxDecoration(
                          color: appTema.isDarkMode
                              ? Colors.grey[800]?.withValues(alpha: 0.5)
                              : Colors.white.withValues(alpha: 0.7),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: appTema.isDarkMode
                                ? Colors.white24
                                : Colors.black12,
                            width: 2,
                          ),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Apelido',
                              style: TextStyle(
                                color: appTema.textSecondaryColor,
                                fontSize: 14,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _apelido,
                              style: TextStyle(
                                color: appTema.textColor,
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 16),
                            Text(
                              'E-mail',
                              style: TextStyle(
                                color: appTema.textSecondaryColor,
                                fontSize: 14,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _email,
                              style: TextStyle(
                                color: appTema.textColor,
                                fontSize: 16,
                              ),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 24),

                      // OpÃ§Ãµes
                      _buildOpcaoCard(
                        appTema: appTema,
                        icone: Icons.edit,
                        titulo: 'Alterar Apelido',
                        subtitulo: 'Mude seu apelido de exibiÃ§Ã£o',
                        onTap: _alterarApelido,
                      ),

                      const SizedBox(height: 16),

                      _buildOpcaoCard(
                        appTema: appTema,
                        icone: Icons.lock_outline,
                        titulo: 'Alterar Senha',
                        subtitulo: 'Mude a senha da sua conta',
                        onTap: _alterarSenha,
                      ),

                      const SizedBox(height: 32),

                      // Zona de perigo
                      Container(
                        padding: const EdgeInsets.all(20),
                        decoration: BoxDecoration(
                          color: Colors.red.withValues(alpha: 0.1),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: Colors.red.withValues(alpha: 0.3),
                            width: 2,
                          ),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.warning_amber_rounded,
                                  color: Colors.red[700],
                                  size: 24,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  'Zona de Perigo',
                                  style: TextStyle(
                                    color: Colors.red[700],
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),
                            SizedBox(
                              width: double.infinity,
                              child: ElevatedButton.icon(
                                onPressed: _excluirConta,
                                icon: const Icon(
                                  Icons.delete_forever,
                                  color: Colors.white,
                                ),
                                label: const Text(
                                  'Excluir Conta',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.red[700],
                                  padding: const EdgeInsets.symmetric(
                                    vertical: 16,
                                  ),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildOpcaoCard({
    required AppTema appTema,
    required IconData icone,
    required String titulo,
    required String subtitulo,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.5)
              : Colors.white.withValues(alpha: 0.7),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
            width: 2,
          ),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: const Color(0xFFA9DBF4).withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icone, color: const Color(0xFFA9DBF4), size: 28),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    titulo,
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    subtitulo,
                    style: TextStyle(
                      color: appTema.textSecondaryColor,
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              Icons.arrow_forward_ios,
              color: appTema.textSecondaryColor,
              size: 20,
            ),
          ],
        ),
      ),
    );
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIÃLOGO: ALTERAR SENHA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class _AlterarSenhaDialog extends StatefulWidget {
  final TextEditingController senhaAtualController;
  final TextEditingController novaSenhaController;
  final TextEditingController confirmarSenhaController;

  const _AlterarSenhaDialog({
    required this.senhaAtualController,
    required this.novaSenhaController,
    required this.confirmarSenhaController,
  });

  @override
  State<_AlterarSenhaDialog> createState() => _AlterarSenhaDialogState();
}

class _AlterarSenhaDialogState extends State<_AlterarSenhaDialog> {
  bool _isLoading = false;
  String? _errorMessage;
  bool _obscureSenhaAtual = true;
  bool _obscureNovaSenha = true;
  bool _obscureConfirmarSenha = true;

  Future<void> _alterarSenha() async {
    final senhaAtual = widget.senhaAtualController.text.trim();
    final novaSenha = widget.novaSenhaController.text.trim();
    final confirmarSenha = widget.confirmarSenhaController.text.trim();

    if (senhaAtual.isEmpty || novaSenha.isEmpty || confirmarSenha.isEmpty) {
      setState(() {
        _errorMessage = 'Preencha todos os campos';
      });
      return;
    }

    if (novaSenha.length < 6) {
      setState(() {
        _errorMessage = 'A nova senha deve ter no mÃ­nimo 6 caracteres';
      });
      return;
    }

    if (novaSenha != confirmarSenha) {
      setState(() {
        _errorMessage = 'As senhas nÃ£o coincidem';
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null && user.email != null) {
        // Reautentica o usuÃ¡rio
        final credential = EmailAuthProvider.credential(
          email: user.email!,
          password: senhaAtual,
        );

        await user.reauthenticateWithCredential(credential);

        // Atualiza a senha
        await user.updatePassword(novaSenha);

        if (!mounted) return;
        Navigator.of(context).pop(true);
      }
    } on FirebaseAuthException catch (e) {
      if (!mounted) return;

      String mensagem;
      if (e.code == 'wrong-password') {
        mensagem = 'Senha atual incorreta';
      } else if (e.code == 'weak-password') {
        mensagem = 'Senha muito fraca';
      } else {
        mensagem = 'Erro ao alterar senha: ${e.message}';
      }

      setState(() {
        _errorMessage = mensagem;
        _isLoading = false;
      });
    } catch (e) {
      if (!mounted) return;

      setState(() {
        _errorMessage = 'Erro inesperado: $e';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(
          color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
          width: 1,
        ),
      ),
      title: Text(
        'Alterar Senha',
        style: TextStyle(
          color: appTema.textColor,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildPasswordField(
              appTema: appTema,
              controller: widget.senhaAtualController,
              label: 'Senha Atual',
              obscure: _obscureSenhaAtual,
              onToggle: () =>
                  setState(() => _obscureSenhaAtual = !_obscureSenhaAtual),
            ),
            const SizedBox(height: 16),
            _buildPasswordField(
              appTema: appTema,
              controller: widget.novaSenhaController,
              label: 'Nova Senha',
              obscure: _obscureNovaSenha,
              onToggle: () =>
                  setState(() => _obscureNovaSenha = !_obscureNovaSenha),
            ),
            const SizedBox(height: 16),
            _buildPasswordField(
              appTema: appTema,
              controller: widget.confirmarSenhaController,
              label: 'Confirmar Nova Senha',
              obscure: _obscureConfirmarSenha,
              onToggle: () => setState(
                () => _obscureConfirmarSenha = !_obscureConfirmarSenha,
              ),
            ),
            if (_errorMessage != null) ...[
              const SizedBox(height: 16),
              Text(
                _errorMessage!,
                style: const TextStyle(color: Colors.red, fontSize: 14),
                textAlign: TextAlign.center,
              ),
            ],
            if (_isLoading) ...[
              const SizedBox(height: 16),
              const CircularProgressIndicator(color: Color(0xFFA9DBF4)),
            ],
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: _isLoading ? null : () => Navigator.of(context).pop(false),
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
          ),
          child: const Text('Cancelar'),
        ),
        ElevatedButton(
          onPressed: _isLoading ? null : _alterarSenha,
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFFA9DBF4),
            foregroundColor: Colors.black,
          ),
          child: const Text('Alterar'),
        ),
      ],
    );
  }

  Widget _buildPasswordField({
    required AppTema appTema,
    required TextEditingController controller,
    required String label,
    required bool obscure,
    required VoidCallback onToggle,
  }) {
    return TextField(
      controller: controller,
      obscureText: obscure,
      style: TextStyle(color: appTema.textColor),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: appTema.textSecondaryColor),
        filled: true,
        fillColor: appTema.isDarkMode ? Colors.grey[800] : Colors.grey[100],
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        suffixIcon: IconButton(
          icon: Icon(
            obscure ? Icons.visibility_off : Icons.visibility,
            color: appTema.textSecondaryColor,
          ),
          onPressed: onToggle,
        ),
      ),
    );
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIÃLOGO: ALTERAR APELIDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class _AlterarApelidoDialog extends StatefulWidget {
  final TextEditingController apelidoController;

  const _AlterarApelidoDialog({required this.apelidoController});

  @override
  State<_AlterarApelidoDialog> createState() => _AlterarApelidoDialogState();
}

class _AlterarApelidoDialogState extends State<_AlterarApelidoDialog> {
  bool _isLoading = false;

  Future<void> _salvarApelido() async {
    final novoApelido = widget.apelidoController.text.trim();

    if (novoApelido.isEmpty) {
      return;
    }

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .update({'apelido': novoApelido});

        if (!mounted) return;
        Navigator.of(context).pop(novoApelido);
      }
    } catch (e) {
      if (!mounted) return;

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Erro ao alterar apelido: $e'),
          backgroundColor: Colors.red,
        ),
      );

      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(
          color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
          width: 1,
        ),
      ),
      title: Text(
        'Alterar Apelido',
        style: TextStyle(
          color: appTema.textColor,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: widget.apelidoController,
            autofocus: true,
            style: TextStyle(color: appTema.textColor),
            decoration: InputDecoration(
              labelText: 'Novo Apelido',
              labelStyle: TextStyle(color: appTema.textSecondaryColor),
              filled: true,
              fillColor: appTema.isDarkMode
                  ? Colors.grey[800]
                  : Colors.grey[100],
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
            ),
          ),
          if (_isLoading) ...[
            const SizedBox(height: 16),
            const CircularProgressIndicator(color: Color(0xFFA9DBF4)),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: _isLoading ? null : () => Navigator.of(context).pop(null),
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
          ),
          child: const Text('Cancelar'),
        ),
        ElevatedButton(
          onPressed: _isLoading ? null : _salvarApelido,
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFFA9DBF4),
            foregroundColor: Colors.black,
          ),
          child: const Text('Salvar'),
        ),
      ],
    );
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIÃLOGO: CONFIRMAR EXCLUSÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class _ConfirmarExclusaoDialog extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(color: Colors.red.withValues(alpha: 0.5), width: 2),
      ),
      title: Row(
        children: [
          Icon(Icons.warning_amber_rounded, color: Colors.red[700], size: 32),
          const SizedBox(width: 12),
          Text(
            'Excluir Conta',
            style: TextStyle(
              color: Colors.red[700],
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Esta aÃ§Ã£o Ã© IRREVERSÃVEL!',
            style: TextStyle(
              color: appTema.textColor,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          Text(
            'Ao excluir sua conta:',
            style: TextStyle(color: appTema.textColor, fontSize: 14),
          ),
          const SizedBox(height: 8),
          Text(
            'â€¢ Todos os seus dados serÃ£o perdidos\n'
            'â€¢ Todos os perfis familiares serÃ£o excluÃ­dos\n'
            'â€¢ NÃ£o serÃ¡ possÃ­vel recuperar a conta',
            style: TextStyle(
              color: appTema.textSecondaryColor,
              fontSize: 14,
              height: 1.5,
            ),
          ),
          const SizedBox(height: 16),
          Text(
            'VocÃª tem certeza?',
            style: TextStyle(
              color: appTema.textColor,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(false),
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
          ),
          child: const Text('Cancelar'),
        ),
        ElevatedButton(
          onPressed: () => Navigator.of(context).pop(true),
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.red[700],
            foregroundColor: Colors.white,
          ),
          child: const Text('Sim, estou ciente'),
        ),
      ],
    );
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIÃLOGO: CONFIRMAR SENHA PARA EXCLUSÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class _ConfirmarSenhaDialog extends StatefulWidget {
  final TextEditingController senhaController;
  final String email;

  const _ConfirmarSenhaDialog({
    required this.senhaController,
    required this.email,
  });

  @override
  State<_ConfirmarSenhaDialog> createState() => _ConfirmarSenhaDialogState();
}

class _ConfirmarSenhaDialogState extends State<_ConfirmarSenhaDialog> {
  bool _isLoading = false;
  String? _errorMessage;
  bool _obscureSenha = true;

  Future<void> _confirmarSenha() async {
    final senha = widget.senhaController.text.trim();

    if (senha.isEmpty) {
      setState(() {
        _errorMessage = 'Digite sua senha';
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user != null) {
        // Reautentica o usuÃ¡rio
        final credential = EmailAuthProvider.credential(
          email: widget.email,
          password: senha,
        );

        await user.reauthenticateWithCredential(credential);

        if (!mounted) return;
        Navigator.of(context).pop(true);
      }
    } on FirebaseAuthException catch (e) {
      if (!mounted) return;

      String mensagem;
      if (e.code == 'wrong-password') {
        mensagem = 'Senha incorreta';
      } else {
        mensagem = 'Erro: ${e.message}';
      }

      setState(() {
        _errorMessage = mensagem;
        _isLoading = false;
      });
    } catch (e) {
      if (!mounted) return;

      setState(() {
        _errorMessage = 'Erro inesperado: $e';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(color: Colors.red.withValues(alpha: 0.5), width: 2),
      ),
      title: Text(
        'Digite sua senha',
        style: TextStyle(
          color: appTema.textColor,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            'Para confirmar a exclusÃ£o da conta, digite sua senha:',
            style: TextStyle(color: appTema.textSecondaryColor, fontSize: 14),
          ),
          const SizedBox(height: 16),
          TextField(
            controller: widget.senhaController,
            obscureText: _obscureSenha,
            autofocus: true,
            style: TextStyle(color: appTema.textColor),
            decoration: InputDecoration(
              labelText: 'Senha',
              labelStyle: TextStyle(color: appTema.textSecondaryColor),
              filled: true,
              fillColor: appTema.isDarkMode
                  ? Colors.grey[800]
                  : Colors.grey[100],
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
              suffixIcon: IconButton(
                icon: Icon(
                  _obscureSenha ? Icons.visibility_off : Icons.visibility,
                  color: appTema.textSecondaryColor,
                ),
                onPressed: () => setState(() => _obscureSenha = !_obscureSenha),
              ),
            ),
          ),
          if (_errorMessage != null) ...[
            const SizedBox(height: 16),
            Text(
              _errorMessage!,
              style: const TextStyle(color: Colors.red, fontSize: 14),
              textAlign: TextAlign.center,
            ),
          ],
          if (_isLoading) ...[
            const SizedBox(height: 16),
            const CircularProgressIndicator(color: Colors.red),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: _isLoading ? null : () => Navigator.of(context).pop(false),
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
          ),
          child: const Text('Cancelar'),
        ),
        ElevatedButton(
          onPressed: _isLoading ? null : _confirmarSenha,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.red[700],
            foregroundColor: Colors.white,
          ),
          child: const Text('Confirmar ExclusÃ£o'),
        ),
      ],
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\perfil_configs.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'app_tema.dart';
import 'perfil_provider.dart';
import 'widgets/theme_toggle_button.dart';

class PerfilConfigsScreen extends StatelessWidget {
  const PerfilConfigsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);
    final perfilProvider = Provider.of<PerfilProvider>(context);
    final user = FirebaseAuth.instance.currentUser;

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… CORRIGIDO
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              // TÃ­tulo
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Text(
                  'ConfiguraÃ§Ãµes',
                  style: TextStyle(
                    color: appTema.textColor,
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),

              // Lista de configuraÃ§Ãµes
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  children: [
                    _buildConfigCard(
                      context: context,
                      icon: Icons.person_outline,
                      title: 'Perfil',
                      subtitle: user?.email ?? 'Sem e-mail',
                      appTema: appTema,
                      onTap: () {
                        // Apenas perfil pai pode acessar configuraÃ§Ãµes de perfil
                        if (perfilProvider.isPerfilPai) {
                          context.push('/perfilpai-configs');
                        } else {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text(
                                'Apenas o perfil pai pode acessar essas configuraÃ§Ãµes',
                              ),
                              backgroundColor: Colors.orange,
                              duration: Duration(seconds: 2),
                            ),
                          );
                        }
                      },
                    ),

                    const SizedBox(height: 16),

                    // Mudar Avatar
                    _buildConfigCard(
                      context: context,
                      icon: Icons.face,
                      title: 'Mudar Avatar',
                      subtitle: 'Altere seu avatar de exibiÃ§Ã£o',
                      appTema: appTema,
                      onTap: () {
                        context.push('/mudar-avatar');
                      },
                    ),

                    const SizedBox(height: 16),

                    // SeguranÃ§a - APENAS para perfil pai
                    if (perfilProvider.isPerfilPai)
                      _buildConfigCard(
                        context: context,
                        icon: Icons.lock_outline,
                        title: 'SeguranÃ§a',
                        subtitle: 'Configurar PIN de controle parental',
                        appTema: appTema,
                        onTap: () {
                          context.push('/seguranca-config');
                        },
                      ),

                    if (perfilProvider.isPerfilPai) const SizedBox(height: 16),

                    _buildConfigCard(
                      context: context,
                      icon: Icons.palette_outlined,
                      title: 'Tema',
                      subtitle: appTema.isDarkMode
                          ? 'Modo Escuro'
                          : 'Modo Claro',
                      appTema: appTema,
                      onTap: () {
                        context.push('/tema-config');
                      },
                    ),

                    const SizedBox(height: 16),

                    _buildConfigCard(
                      context: context,
                      icon: Icons.notifications_none_outlined,
                      title: 'NotificaÃ§Ãµes',
                      subtitle: 'Gerenciar notificaÃ§Ãµes',
                      appTema: appTema,
                      onTap: () {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text('Em desenvolvimento...'),
                            duration: Duration(seconds: 2),
                          ),
                        );
                      },
                    ),

                    const SizedBox(height: 16),

                    _buildConfigCard(
                      context: context,
                      icon: Icons.language_outlined,
                      title: 'Idioma',
                      subtitle: 'PortuguÃªs (Brasil)',
                      appTema: appTema,
                      onTap: () {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text('Em desenvolvimento...'),
                            duration: Duration(seconds: 2),
                          ),
                        );
                      },
                    ),

                    const SizedBox(height: 16),

                    _buildConfigCard(
                      context: context,
                      icon: Icons.help_outline,
                      title: 'Ajuda e Suporte',
                      subtitle: 'Central de ajuda',
                      appTema: appTema,
                      onTap: () {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text('Em desenvolvimento...'),
                            duration: Duration(seconds: 2),
                          ),
                        );
                      },
                    ),

                    const SizedBox(height: 16),

                    _buildConfigCard(
                      context: context,
                      icon: Icons.info_outline,
                      title: 'Sobre',
                      subtitle: 'VersÃ£o 1.0.0',
                      appTema: appTema,
                      onTap: () {
                        _mostrarSobre(context, appTema);
                      },
                    ),

                    const SizedBox(height: 32),

                    // BotÃ£o de Logout
                    Container(
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        color: appTema.isDarkMode
                            ? Colors.blue.withValues(alpha: 0.15)
                            : Colors.blue.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: appTema.isDarkMode
                              ? Colors.blue.withValues(alpha: 0.4)
                              : Colors.blue.withValues(alpha: 0.3),
                          width: 2,
                        ),
                      ),
                      child: SizedBox(
                        width: double.infinity,
                        child: ElevatedButton.icon(
                          onPressed: () async {
                            final router = GoRouter.of(context);

                            final confirmar = await showDialog<bool>(
                              context: context,
                              builder: (dialogContext) =>
                                  _ConfirmarLogoutDialog(appTema: appTema),
                            );

                            if (confirmar == true) {
                              await FirebaseAuth.instance.signOut();

                              // Usa router salvo antes da operaÃ§Ã£o assÃ­ncrona
                              router.go('/options');
                            }
                          },
                          icon: const Icon(Icons.logout, color: Colors.white),
                          label: const Text(
                            'Encerrar SessÃ£o',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: appTema.isDarkMode
                                ? Colors.blue[600]
                                : Colors.blue[800],
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildConfigCard({
    required BuildContext context,
    required IconData icon,
    required String title,
    required String subtitle,
    required AppTema appTema,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: appTema.isDarkMode
              ? Colors.grey[800]?.withValues(alpha: 0.5)
              : Colors.white.withValues(alpha: 0.7),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
            width: 1,
          ),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: const Color(0xFFA9DBF4).withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(icon, color: const Color(0xFFA9DBF4), size: 24),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      color: appTema.textColor,
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: appTema.textSecondaryColor,
                      fontSize: 13,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              Icons.arrow_forward_ios,
              color: appTema.textSecondaryColor,
              size: 16,
            ),
          ],
        ),
      ),
    );
  }

  void _mostrarSobre(BuildContext context, AppTema appTema) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
        title: Text(
          'Sobre o Bluflix',
          style: TextStyle(color: appTema.textColor),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Image.asset('assets/logo.png', width: 100),
            const SizedBox(height: 16),
            Text(
              'Bluflix v1.0.0',
              style: TextStyle(
                color: appTema.textColor,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Aplicativo de streaming desenvolvido com Flutter.',
              textAlign: TextAlign.center,
              style: TextStyle(color: appTema.textSecondaryColor),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Fechar'),
          ),
        ],
      ),
    );
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIÃLOGO: CONFIRMAR LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class _ConfirmarLogoutDialog extends StatelessWidget {
  final AppTema appTema;

  const _ConfirmarLogoutDialog({required this.appTema});

  @override
  Widget build(BuildContext context) {
    // Define cores adaptativas baseadas no tema
    final corPrimaria = appTema.isDarkMode
        ? Colors.blue[600]!
        : Colors.blue[800]!;
    final corFundo = appTema.isDarkMode
        ? Colors.blue.withValues(alpha: 0.15)
        : Colors.blue.withValues(alpha: 0.1);
    final corBorda = appTema.isDarkMode
        ? Colors.blue.withValues(alpha: 0.4)
        : Colors.blue.withValues(alpha: 0.3);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(color: corBorda, width: 2),
      ),
      title: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: corFundo,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            Icon(Icons.logout, color: corPrimaria, size: 28),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                'Sair da Conta',
                style: TextStyle(
                  color: appTema.textColor,
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ],
        ),
      ),
      content: Padding(
        padding: const EdgeInsets.only(top: 8),
        child: Text(
          'Tem certeza que deseja sair da sua conta?',
          style: TextStyle(color: appTema.textSecondaryColor, fontSize: 16),
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(false),
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
          ),
          child: const Text(
            'Cancelar',
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
          ),
        ),
        ElevatedButton(
          onPressed: () => Navigator.of(context).pop(true),
          style: ElevatedButton.styleFrom(
            backgroundColor: corPrimaria,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            elevation: 2,
          ),
          child: const Text(
            'Encerrar SessÃ£o',
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
        ),
      ],
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\perfil_provider.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

class PerfilProvider extends ChangeNotifier {
  String? _perfilAtivoApelido;
  String? _perfilAtivoAvatar;
  bool _isPerfilPai = true;

  String? get perfilAtivoApelido => _perfilAtivoApelido;
  String? get perfilAtivoAvatar => _perfilAtivoAvatar;
  bool get isPerfilPai => _isPerfilPai;

  // Carregar perfil ativo salvo
  Future<void> loadPerfilAtivo() async {
    final prefs = await SharedPreferences.getInstance();
    _perfilAtivoApelido = prefs.getString('perfilAtivoApelido');
    _perfilAtivoAvatar = prefs.getString('perfilAtivoAvatar');
    _isPerfilPai = prefs.getBool('isPerfilPai') ?? true;
    notifyListeners();
  }

  // Definir perfil ativo
  Future<void> setPerfilAtivo({
    required String apelido,
    required String avatar,
    required bool isPai,
  }) async {
    print("ðŸ”µ setPerfilAtivo chamado:");
    print("   Apelido: $apelido");
    print("   Avatar: $avatar");
    print("   IsPai: $isPai");

    _perfilAtivoApelido = apelido;
    _perfilAtivoAvatar = avatar;
    _isPerfilPai = isPai;

    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('perfilAtivoApelido', apelido);
    await prefs.setString('perfilAtivoAvatar', avatar);
    await prefs.setBool('isPerfilPai', isPai);

    print("âœ… Perfil salvo no SharedPreferences");
    notifyListeners();
  }

  // Limpar perfil ativo (usado no logout)
  Future<void> clearPerfilAtivo() async {
    print("ðŸ”µ clearPerfilAtivo chamado");

    _perfilAtivoApelido = null;
    _perfilAtivoAvatar = null;
    _isPerfilPai = true;

    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('perfilAtivoApelido');
    await prefs.remove('perfilAtivoAvatar');
    await prefs.remove('isPerfilPai');

    // âœ… NÃƒO remove 'isDarkMode' - deixa o tema salvo!

    print("âœ… Perfil limpo (tema mantido)");
    notifyListeners();
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\pin_verification.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'services/pin_service.dart';

class VerificarPinDialog {
  static Future<bool> verificar(BuildContext context) async {
    final pinController = TextEditingController();

    final resultado = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (dialogContext) =>
          _PinDialogContent(pinController: pinController),
    );

    return resultado ?? false;
  }
}

class _PinDialogContent extends StatefulWidget {
  final TextEditingController pinController;

  const _PinDialogContent({required this.pinController});

  @override
  State<_PinDialogContent> createState() => _PinDialogContentState();
}

class _PinDialogContentState extends State<_PinDialogContent> {
  bool _isLoading = false;
  String? _errorMessage;

  Future<void> _verificarPin() async {
    final pin = widget.pinController.text.trim();

    if (pin.isEmpty) {
      setState(() {
        _errorMessage = 'Digite o PIN';
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      // âœ… NOVO: Usa o PinService para verificaÃ§Ã£o segura
      final pinService = PinService();
      final pinCorreto = await pinService.verificarPinPerfilPai(pin);

      if (!mounted) return;

      if (pinCorreto) {
        // PIN correto
        Navigator.of(context).pop(true);
      } else {
        // PIN incorreto
        setState(() {
          _errorMessage = 'PIN incorreto';
          _isLoading = false;
        });
      }
    } catch (e) {
      if (!mounted) return;

      setState(() {
        _errorMessage = 'Erro ao verificar PIN';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return AlertDialog(
      backgroundColor: appTema.isDarkMode ? Colors.grey[900] : Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(
          color: appTema.isDarkMode ? Colors.white24 : Colors.black12,
          width: 1,
        ),
      ),
      title: Row(
        children: [
          Icon(Icons.lock_outline, color: const Color(0xFFA9DBF4), size: 28),
          const SizedBox(width: 12),
          Text(
            'Digite o PIN',
            style: TextStyle(
              color: appTema.textColor,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: widget.pinController,
            keyboardType: TextInputType.number,
            obscureText: true,
            maxLength: 4,
            autofocus: true,
            style: TextStyle(
              color: appTema.textColor,
              fontSize: 18,
              letterSpacing: 8,
            ),
            decoration: InputDecoration(
              hintText: 'â€¢â€¢â€¢â€¢',
              hintStyle: TextStyle(
                color: appTema.textSecondaryColor,
                letterSpacing: 8,
              ),
              errorText: _errorMessage,
              errorStyle: const TextStyle(color: Colors.red, fontSize: 14),
              counterText: '',
              filled: true,
              fillColor: appTema.isDarkMode
                  ? Colors.grey[800]
                  : Colors.grey[100],
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: const BorderSide(
                  color: Color(0xFFA9DBF4),
                  width: 2,
                ),
              ),
              errorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: const BorderSide(color: Colors.red, width: 2),
              ),
            ),
            onSubmitted: (_) => _verificarPin(),
          ),
          if (_isLoading) ...[
            const SizedBox(height: 20),
            const CircularProgressIndicator(color: Color(0xFFA9DBF4)),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: _isLoading
              ? null
              : () {
                  Navigator.of(context).pop(false);
                },
          style: TextButton.styleFrom(
            foregroundColor: appTema.isDarkMode
                ? Colors.white70
                : Colors.black54,
          ),
          child: const Text('Cancelar', style: TextStyle(fontSize: 16)),
        ),
        ElevatedButton(
          onPressed: _isLoading ? null : _verificarPin,
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFFA9DBF4),
            foregroundColor: Colors.black,
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
          ),
          child: const Text(
            'Verificar',
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    widget.pinController.dispose();
    super.dispose();
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\preferencias_filho.dart
// ========================================
import 'package:bluflix/perfil_provider.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';

class PreferenciasFilhoScreen extends StatefulWidget {
  final String apelido;
  final String avatar;

  const PreferenciasFilhoScreen({
    super.key,
    required this.apelido,
    required this.avatar,
  });

  @override
  State<PreferenciasFilhoScreen> createState() =>
      _PreferenciasFilhoScreenState();
}

class _PreferenciasFilhoScreenState extends State<PreferenciasFilhoScreen> {
  bool _isLoading = false;

  // Lista de gÃªneros disponÃ­veis (mesmos do catÃ¡logo)
  final Map<String, Map<String, dynamic>> _generos = {
    'AÃ§Ã£o': {'emoji': 'ðŸŽ¬', 'cor': Colors.red},
    'ComÃ©dia': {'emoji': 'ðŸ˜‚', 'cor': Colors.orange},
    'Drama': {'emoji': 'ðŸ’”', 'cor': Colors.purple},
    'Terror': {'emoji': 'ðŸ˜±', 'cor': Colors.grey},
    'FicÃ§Ã£o CientÃ­fica': {'emoji': 'ðŸš€', 'cor': Colors.blue},
    'Romance': {'emoji': 'â¤ï¸', 'cor': Colors.pink},
    'AnimaÃ§Ã£o': {'emoji': 'ðŸŽ¨', 'cor': Colors.green},
    'DocumentÃ¡rio': {'emoji': 'ðŸ“š', 'cor': Colors.brown},
  };

  // Map para controlar os checkboxes
  final Map<String, bool> _preferencias = {};

  @override
  void initState() {
    super.initState();
    // Inicializa todas as preferÃªncias como false
    for (var genero in _generos.keys) {
      _preferencias[genero] = false;
    }
  }

  bool get _algumaSelecionada => _preferencias.values.any((v) => v == true);

  Future<void> _salvarPreferencias() async {
    if (!_algumaSelecionada) {
      _mostrarErro('Selecione pelo menos um gÃªnero de interesse');
      return;
    }

    setState(() => _isLoading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        throw Exception('UsuÃ¡rio nÃ£o autenticado');
      }

      // Pega apenas os gÃªneros selecionados
      final List<String> generosSelecionados = _preferencias.entries
          .where((entry) => entry.value == true)
          .map((entry) => entry.key)
          .toList();

      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
      print("ðŸ’¾ SALVANDO PREFERÃŠNCIAS DO PERFIL FILHO");
      print("   Apelido: ${widget.apelido}");
      print("   Avatar: ${widget.avatar}");
      print("   PreferÃªncias: $generosSelecionados");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      // Busca o documento do usuÃ¡rio
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .get();

      if (!userDoc.exists) {
        throw Exception('Documento do usuÃ¡rio nÃ£o encontrado');
      }

      // Pega a lista atual de perfis filhos
      List<dynamic> perfisFilhos = userDoc.data()?['perfisFilhos'] ?? [];

      // Verifica se jÃ¡ tem 4 perfis
      if (perfisFilhos.length >= 4) {
        if (!mounted) return;
        _mostrarErro('Limite de 4 perfis atingido!');
        setState(() => _isLoading = false);
        return;
      }

      // Cria o novo perfil filho com preferÃªncias
      final novoPerfilFilho = {
        'apelido': widget.apelido,
        'avatar': widget.avatar,
        'interesses': generosSelecionados, // âœ… Padronizado como 'interesses'
        'criadoEm': Timestamp.now(),
      };

      // Adiciona o novo perfil Ã  lista
      perfisFilhos.add(novoPerfilFilho);

      // Atualiza o Firestore
      await FirebaseFirestore.instance.collection('users').doc(user.uid).update(
        {'perfisFilhos': perfisFilhos},
      );

      print("   âœ… Perfil filho salvo com preferÃªncias!");
      print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

      if (!mounted) return;

      // Mostra mensagem de sucesso
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Perfil "${widget.apelido}" criado com sucesso!'),
          backgroundColor: Colors.green,
          duration: const Duration(seconds: 2),
        ),
      );

      if (!mounted) return;

      // Define o perfil filho como ativo
      final perfilProvider = Provider.of<PerfilProvider>(
        context,
        listen: false,
      );
      await perfilProvider.setPerfilAtivo(
        apelido: widget.apelido,
        avatar: widget.avatar,
        isPai: false,
      );
      // Navega para o catÃ¡logo
      context.go('/catalogo');
    } catch (e) {
      print("âŒ ERRO ao salvar preferÃªncias: $e");
      if (!mounted) return;

      _mostrarErro('Erro ao salvar: ${e.toString()}');
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _mostrarErro(String mensagem) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(mensagem),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  void _toggleSelecaoTodas() {
    setState(() {
      final bool novoValor = !_algumaSelecionada;
      for (var genero in _generos.keys) {
        _preferencias[genero] = novoValor;
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false),
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              // TÃ­tulo e subtÃ­tulo
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Column(
                  children: [
                    // Avatar escolhido
                    CircleAvatar(
                      radius: 40,
                      backgroundImage: AssetImage(widget.avatar),
                    ),
                    const SizedBox(height: 12),

                    Text(
                      widget.apelido,
                      style: TextStyle(
                        color: appTema.textColor,
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 8),

                    Text(
                      'Quais gÃªneros vocÃª gosta?',
                      style: TextStyle(
                        color: appTema.textColor,
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 8),

                    Text(
                      'Selecione seus gÃªneros favoritos para\npersonalizar sua experiÃªncia',
                      style: TextStyle(
                        color: appTema.textSecondaryColor,
                        fontSize: 14,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ],
                ),
              ),

              // BotÃ£o "Selecionar Todas"
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: SizedBox(
                  width: double.infinity,
                  child: OutlinedButton.icon(
                    onPressed: _toggleSelecaoTodas,
                    icon: Icon(
                      _algumaSelecionada ? Icons.deselect : Icons.select_all,
                      color: const Color(0xFFA9DBF4),
                    ),
                    label: Text(
                      _algumaSelecionada
                          ? 'Desmarcar Todas'
                          : 'Selecionar Todas',
                      style: const TextStyle(
                        color: Color(0xFFA9DBF4),
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(
                        color: Color(0xFFA9DBF4),
                        width: 2,
                      ),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 16),

              // Lista de gÃªneros com checkboxes
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  children: _generos.entries.map((entry) {
                    final genero = entry.key;
                    final dados = entry.value;
                    final isSelected = _preferencias[genero] ?? false;

                    return Padding(
                      padding: const EdgeInsets.only(bottom: 12.0),
                      child: _buildGeneroCheckbox(
                        genero: genero,
                        emoji: dados['emoji'],
                        cor: dados['cor'],
                        isSelected: isSelected,
                        appTema: appTema,
                      ),
                    );
                  }).toList(),
                ),
              ),

              // BotÃµes
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : () => context.pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey[300],
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text("Voltar"),
                      ),
                    ),
                    const SizedBox(width: 20),
                    SizedBox(
                      width: 140,
                      height: 50,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _salvarPreferencias,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFA9DBF4),
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  color: Colors.black,
                                  strokeWidth: 2.5,
                                ),
                              )
                            : const Text("Salvar"),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildGeneroCheckbox({
    required String genero,
    required String emoji,
    required Color cor,
    required bool isSelected,
    required AppTema appTema,
  }) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _preferencias[genero] = !isSelected;
        });
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isSelected
              ? (appTema.isDarkMode
                    ? const Color(0xFFA9DBF4).withValues(alpha: 0.2)
                    : const Color(0xFFA9DBF4).withValues(alpha: 0.3))
              : (appTema.isDarkMode
                    ? Colors.grey[800]?.withValues(alpha: 0.5)
                    : Colors.white.withValues(alpha: 0.7)),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? const Color(0xFFA9DBF4)
                : (appTema.isDarkMode ? Colors.white24 : Colors.black12),
            width: isSelected ? 3 : 1,
          ),
        ),
        child: Row(
          children: [
            // Emoji e nome do gÃªnero
            Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: cor.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Center(
                child: Text(emoji, style: const TextStyle(fontSize: 32)),
              ),
            ),
            const SizedBox(width: 16),

            Expanded(
              child: Text(
                genero,
                style: TextStyle(
                  color: appTema.textColor,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),

            // Checkbox
            AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: isSelected
                    ? const Color(0xFFA9DBF4)
                    : Colors.transparent,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: isSelected
                      ? const Color(0xFFA9DBF4)
                      : appTema.textSecondaryColor,
                  width: 2,
                ),
              ),
              child: isSelected
                  ? const Icon(Icons.check, color: Colors.black, size: 20)
                  : null,
            ),
          ],
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\seguranca_config.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';
import 'services/pin_service.dart';

class SegurancaConfigScreen extends StatefulWidget {
  const SegurancaConfigScreen({super.key});

  @override
  State<SegurancaConfigScreen> createState() => _SegurancaConfigScreenState();
}

class _SegurancaConfigScreenState extends State<SegurancaConfigScreen> {
  final TextEditingController _pinController = TextEditingController();
  final TextEditingController _confirmPinController = TextEditingController();
  bool _isLoading = false;
  String? _pinAtual;

  @override
  void initState() {
    super.initState();
    _carregarPinAtual();
  }

  @override
  void dispose() {
    _pinController.dispose();
    _confirmPinController.dispose();
    super.dispose();
  }

  Future<void> _carregarPinAtual() async {
    try {
      final pinService = PinService();
      final temPin = await pinService.temPinConfigurado();

      if (mounted) {
        setState(() {
          _pinAtual = temPin ? 'CONFIGURADO' : null;
        });
      }
    } catch (e) {
      print('Erro ao carregar PIN: $e');
    }
  }

  Future<void> _salvarPin() async {
    final pin = _pinController.text.trim();
    final confirmPin = _confirmPinController.text.trim();

    if (pin.isEmpty || confirmPin.isEmpty) {
      _mostrarErro('Por favor, preencha todos os campos');
      return;
    }

    if (pin.length != 4) {
      _mostrarErro('O PIN deve ter exatamente 4 dÃ­gitos');
      return;
    }

    if (pin != confirmPin) {
      _mostrarErro('Os PINs nÃ£o coincidem');
      return;
    }

    setState(() => _isLoading = true);

    try {
      final pinService = PinService();

      // Se jÃ¡ tem PIN, precisa alterar (nÃ£o implementado aqui)
      // Se nÃ£o tem PIN, cria novo
      final sucesso = await pinService.criarPinPerfilPai(pin);

      if (!mounted) return;

      if (sucesso) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('PIN configurado com sucesso!'),
            backgroundColor: Colors.green,
          ),
        );

        context.pop();
      } else {
        _mostrarErro('Erro ao salvar PIN');
      }
    } catch (e) {
      _mostrarErro('Erro ao salvar PIN: ${e.toString()}');
    } finally {
      setState(() => _isLoading = false);
    }
  }

  Future<void> _removerPin() async {
    // Mostra diÃ¡logo de confirmaÃ§Ã£o
    final confirmar = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Remover PIN?'),
        content: const Text(
          'Tem certeza que deseja remover o PIN de seguranÃ§a? '
          'VocÃª precisarÃ¡ digitar o PIN atual para confirmar.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancelar'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('Remover', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    // âœ… Verifica se o widget ainda estÃ¡ montado
    if (!mounted) return;

    if (confirmar == true) {
      setState(() => _isLoading = true);

      try {
        // Solicita PIN para confirmar
        final pinController = TextEditingController();

        final pin = await showDialog<String>(
          context: context,
          builder: (context) => AlertDialog(
            title: const Text('Digite seu PIN'),
            content: TextField(
              controller: pinController,
              obscureText: true,
              keyboardType: TextInputType.number,
              maxLength: 4,
              inputFormatters: [FilteringTextInputFormatter.digitsOnly],
              textAlign: TextAlign.center,
              style: const TextStyle(
                fontSize: 24,
                letterSpacing: 8,
                fontWeight: FontWeight.bold,
              ),
              decoration: InputDecoration(
                counterText: '',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Cancelar'),
              ),
              TextButton(
                onPressed: () => Navigator.pop(context, pinController.text),
                child: const Text('OK'),
              ),
            ],
          ),
        );

        // âœ… Verifica mounted novamente
        if (!mounted) return;

        if (pin == null || pin.isEmpty) {
          setState(() => _isLoading = false);
          return;
        }

        final pinService = PinService();
        final sucesso = await pinService.removerPinPerfilPai(pin);

        if (!mounted) return;

        if (sucesso) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('PIN removido com sucesso!'),
              backgroundColor: Colors.green,
            ),
          );
          context.pop();
        } else {
          _mostrarErro('PIN incorreto ou erro ao remover');
        }
      } catch (e) {
        if (!mounted) return; // âœ… Verifica antes de mostrar erro
        _mostrarErro('Erro ao remover PIN: ${e.toString()}');
      } finally {
        if (mounted) {
          // âœ… Verifica antes de setState
          setState(() => _isLoading = false);
        }
      }
    }
  }

  void _mostrarErro(String mensagem) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(mensagem), backgroundColor: Colors.red),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    children: [
                      Icon(
                        Icons.lock_outline,
                        size: 80,
                        color: const Color(0xFFA9DBF4),
                      ),
                      const SizedBox(height: 24),

                      Text(
                        _pinAtual == null
                            ? 'Configurar PIN de SeguranÃ§a'
                            : 'Alterar PIN de SeguranÃ§a',
                        style: TextStyle(
                          color: appTema.textColor,
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                        ),
                        textAlign: TextAlign.center,
                      ),

                      const SizedBox(height: 12),

                      Text(
                        'Use um PIN de 4 dÃ­gitos para proteger aÃ§Ãµes sensÃ­veis',
                        style: TextStyle(
                          color: appTema.textSecondaryColor,
                          fontSize: 14,
                        ),
                        textAlign: TextAlign.center,
                      ),

                      const SizedBox(height: 40),

                      // Campo PIN
                      _buildPinField(
                        controller: _pinController,
                        label: 'Digite o PIN',
                        appTema: appTema,
                      ),

                      const SizedBox(height: 20),

                      // Campo Confirmar PIN
                      _buildPinField(
                        controller: _confirmPinController,
                        label: 'Confirme o PIN',
                        appTema: appTema,
                      ),

                      const SizedBox(height: 40),

                      // BotÃ£o Salvar
                      SizedBox(
                        width: double.infinity,
                        height: 50,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : _salvarPin,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFFA9DBF4),
                            foregroundColor: Colors.black,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          child: _isLoading
                              ? const SizedBox(
                                  width: 24,
                                  height: 24,
                                  child: CircularProgressIndicator(
                                    color: Colors.black,
                                    strokeWidth: 2.5,
                                  ),
                                )
                              : Text(
                                  _pinAtual == null
                                      ? 'Configurar PIN'
                                      : 'Alterar PIN',
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                        ),
                      ),

                      // BotÃ£o Remover (sÃ³ aparece se jÃ¡ tiver PIN)
                      if (_pinAtual != null) ...[
                        const SizedBox(height: 16),
                        SizedBox(
                          width: double.infinity,
                          height: 50,
                          child: OutlinedButton(
                            onPressed: _isLoading ? null : _removerPin,
                            style: OutlinedButton.styleFrom(
                              foregroundColor: Colors.red,
                              side: const BorderSide(color: Colors.red),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            child: const Text(
                              'Remover PIN',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPinField({
    required TextEditingController controller,
    required String label,
    required AppTema appTema,
  }) {
    return TextField(
      controller: controller,
      keyboardType: TextInputType.number,
      maxLength: 4,
      obscureText: true,
      textAlign: TextAlign.center,
      style: TextStyle(
        color: appTema.textColor,
        fontSize: 24,
        letterSpacing: 12,
        fontWeight: FontWeight.bold,
      ),
      inputFormatters: [FilteringTextInputFormatter.digitsOnly],
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: appTema.textSecondaryColor),
        filled: true,
        fillColor: appTema.isDarkMode
            ? Colors.white.withValues(alpha: 0.1)
            : Colors.white.withValues(alpha: 0.8),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        counterText: '',
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\splash.dart
// ========================================
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();

    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.5, curve: Curves.easeIn),
      ),
    );

    _scaleAnimation = Tween<double>(
      begin: 0.8,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _controller.forward();

    // Timer de 3 segundos para ir para a tela de opÃ§Ãµes
    Timer(const Duration(seconds: 3), () {
      if (mounted) {
        context.go('/options');
      }
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: const BoxDecoration(
          image: DecorationImage(
            image: AssetImage("assets/morning_background.png"),
            fit: BoxFit.cover,
          ),
        ),
        child: Center(
          child: AnimatedBuilder(
            animation: _controller,
            builder: (context, child) {
              return Opacity(
                opacity: _fadeAnimation.value,
                child: Transform.scale(
                  scale: _scaleAnimation.value,
                  child: Image.asset("assets/logo.png", width: 250),
                ),
              );
            },
          ),
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\tema_config.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'app_tema.dart';
import 'widgets/theme_toggle_button.dart';

class TemaConfigScreen extends StatelessWidget {
  const TemaConfigScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage(appTema.backgroundImage),
            fit: BoxFit.cover,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // AppBar
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  children: [
                    Image.asset("assets/logo.png", height: 40),
                    const Spacer(),
                    const ThemeToggleButton(showLogo: false), // âœ… SEM logo
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: Icon(
                        Icons.close,
                        color: appTema.textColor,
                        size: 28,
                      ),
                    ),
                  ],
                ),
              ),

              // TÃ­tulo
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Text(
                  'PreferÃªncia de Tema',
                  style: TextStyle(
                    color: appTema.textColor,
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),

              const SizedBox(height: 40),

              // OpÃ§Ã£o Claro
              _buildTemaCard(
                context: context,
                appTema: appTema,
                isDark: false,
                isSelected: !appTema.isDarkMode,
              ),

              const SizedBox(height: 20),

              // OpÃ§Ã£o Escuro
              _buildTemaCard(
                context: context,
                appTema: appTema,
                isDark: true,
                isSelected: appTema.isDarkMode,
              ),

              const Spacer(),

              // InformaÃ§Ã£o
              Padding(
                padding: const EdgeInsets.all(20.0),
                child: Text(
                  'Sua preferÃªncia serÃ¡ salva automaticamente',
                  style: TextStyle(
                    color: appTema.textSecondaryColor,
                    fontSize: 13,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTemaCard({
    required BuildContext context,
    required AppTema appTema,
    required bool isDark,
    required bool isSelected,
  }) {
    return GestureDetector(
      onTap: () {
        if (isDark != appTema.isDarkMode) {
          appTema.toggleTheme(); // âœ… Remove o await

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Tema ${isDark ? "escuro" : "claro"} ativado!'),
              backgroundColor: Colors.green,
              duration: const Duration(seconds: 2),
            ),
          );
        }
      },
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 40),
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: isDark
              ? Colors.grey[900]?.withValues(alpha: 0.7)
              : Colors.white.withValues(alpha: 0.7),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? const Color(0xFFA9DBF4)
                : (isDark ? Colors.white24 : Colors.black12),
            width: isSelected ? 3 : 1,
          ),
        ),
        child: Row(
          children: [
            Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: isDark ? Colors.black : Colors.white,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: isDark ? Colors.white24 : Colors.black12,
                  width: 2,
                ),
              ),
              child: Icon(
                isDark ? Icons.nightlight_round : Icons.wb_sunny,
                color: isDark ? Colors.amber : Colors.orange,
                size: 32,
              ),
            ),
            const SizedBox(width: 20),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    isDark ? 'Modo Escuro' : 'Modo Claro',
                    style: TextStyle(
                      color: isDark ? Colors.white : Colors.black,
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    isDark
                        ? 'Interface escura para conforto visual e menor distraÃ§Ã£o.'
                        : 'Interface clara para uma experiÃªncia mais nÃ­tida e energizante',
                    style: TextStyle(
                      color: isDark ? Colors.white70 : Colors.black54,
                      fontSize: 13,
                    ),
                  ),
                ],
              ),
            ),
            if (isSelected)
              const Icon(
                Icons.check_circle,
                color: Color(0xFFA9DBF4),
                size: 28,
              ),
          ],
        ),
      ),
    );
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\video_model_youtube.dart
// ========================================
import 'package:cloud_firestore/cloud_firestore.dart';

/// Modelo de dados para vÃ­deos do YouTube no BluFlix
class VideoModelYoutube {
  final String id;
  final String titulo;
  final String descricao;
  final String youtubeId; // ID do vÃ­deo no YouTube (ex: "dQw4w9WgXcQ")
  final String youtubeUrl; // URL completa (ex: "https://www.youtube.com/watch?v=...")
  final List<String> generos;
  final DateTime dataUpload;
  final bool ativo;

  VideoModelYoutube({
    required this.id,
    required this.titulo,
    required this.descricao,
    required this.youtubeId,
    required this.youtubeUrl,
    required this.generos,
    required this.dataUpload,
    this.ativo = true,
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONVERSÃƒO FIRESTORE â†’ MODELO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Cria um VideoModelYoutube a partir de um documento do Firestore
  factory VideoModelYoutube.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;

    return VideoModelYoutube(
      id: doc.id,
      titulo: data['titulo'] ?? '',
      descricao: data['descricao'] ?? '',
      youtubeId: data['youtubeId'] ?? '',
      youtubeUrl: data['youtubeUrl'] ?? '',
      generos: List<String>.from(data['generos'] ?? []),
      dataUpload: (data['dataUpload'] as Timestamp).toDate(),
      ativo: data['ativo'] ?? true,
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONVERSÃƒO MODELO â†’ FIRESTORE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Converte o modelo para Map (para salvar no Firestore)
  Map<String, dynamic> toMap() {
    return {
      'titulo': titulo,
      'descricao': descricao,
      'youtubeId': youtubeId,
      'youtubeUrl': youtubeUrl,
      'generos': generos,
      'dataUpload': Timestamp.fromDate(dataUpload),
      'ativo': ativo,
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILITÃRIOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Retorna a URL da thumbnail do YouTube
  /// Formato: https://img.youtube.com/vi/{youtubeId}/hqdefault.jpg
  String get thumbnailUrl =>
      'https://img.youtube.com/vi/$youtubeId/hqdefault.jpg';

  /// Extrai o ID do YouTube de uma URL
  /// Suporta formatos:
  /// - https://www.youtube.com/watch?v=VIDEO_ID
  /// - https://youtu.be/VIDEO_ID
  /// - https://m.youtube.com/watch?v=VIDEO_ID
  static String? extractYoutubeId(String url) {
    final regExp = RegExp(
      r'(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})',
      caseSensitive: false,
    );

    final match = regExp.firstMatch(url);
    return match?.group(1);
  }

  /// Copia o modelo com alteraÃ§Ãµes opcionais
  VideoModelYoutube copyWith({
    String? id,
    String? titulo,
    String? descricao,
    String? youtubeId,
    String? youtubeUrl,
    List<String>? generos,
    DateTime? dataUpload,
    bool? ativo,
  }) {
    return VideoModelYoutube(
      id: id ?? this.id,
      titulo: titulo ?? this.titulo,
      descricao: descricao ?? this.descricao,
      youtubeId: youtubeId ?? this.youtubeId,
      youtubeUrl: youtubeUrl ?? this.youtubeUrl,
      generos: generos ?? this.generos,
      dataUpload: dataUpload ?? this.dataUpload,
      ativo: ativo ?? this.ativo,
    );
  }

  @override
  String toString() {
    return 'VideoModelYoutube(id: $id, titulo: $titulo, youtubeId: $youtubeId)';
  }
}

// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\video_player_youtube_screen.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:youtube_player_flutter/youtube_player_flutter.dart';
import 'app_tema.dart';
import 'video_model_youtube.dart';

class VideoPlayerYoutubeScreen extends StatefulWidget {
  final VideoModelYoutube video;

  const VideoPlayerYoutubeScreen({super.key, required this.video});

  @override
  State<VideoPlayerYoutubeScreen> createState() =>
      _VideoPlayerYoutubeScreenState();
}

class _VideoPlayerYoutubeScreenState extends State<VideoPlayerYoutubeScreen> {
  late YoutubePlayerController _controller;
  bool _isPlayerReady = false;

  @override
  void initState() {
    super.initState();
    _inicializarPlayer();
  }

  void _inicializarPlayer() {
    _controller =
        YoutubePlayerController(
          initialVideoId: widget.video.youtubeId,
          flags: const YoutubePlayerFlags(
            autoPlay: true,
            mute: false,
            enableCaption: true,
            controlsVisibleAtStart: true,
            hideControls: false,
          ),
        )..addListener(() {
          if (_controller.value.isReady && !_isPlayerReady) {
            setState(() {
              _isPlayerReady = true;
            });
          }
        });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    return YoutubePlayerBuilder(
      player: YoutubePlayer(
        controller: _controller,
        showVideoProgressIndicator: true,
        progressIndicatorColor: const Color(0xFFA9DBF4),
        progressColors: const ProgressBarColors(
          playedColor: Color(0xFFA9DBF4),
          handleColor: Color(0xFFA9DBF4),
        ),
      ),
      builder: (context, player) {
        return Scaffold(
          backgroundColor: appTema.backgroundColor,
          appBar: AppBar(
            backgroundColor: const Color(0xFFA9DBF4),
            foregroundColor: Colors.black,
            title: Text(
              widget.video.titulo,
              style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
            leading: IconButton(
              icon: const Icon(Icons.arrow_back, size: 28),
              onPressed: () => context.pop(),
            ),
          ),
          body: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // PLAYER DO YOUTUBE
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                player,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // INFORMAÃ‡Ã•ES DO VÃDEO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // TÃ­tulo
                      Text(
                        widget.video.titulo,
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: appTema.textColor,
                        ),
                      ),

                      const SizedBox(height: 16),

                      // GÃªneros
                      Wrap(
                        spacing: 8,
                        runSpacing: 8,
                        children: widget.video.generos.map((genero) {
                          return Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 16,
                              vertical: 8,
                            ),
                            decoration: BoxDecoration(
                              color: const Color(0xFFA9DBF4),
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: Text(
                              genero,
                              style: const TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: Colors.black,
                              ),
                            ),
                          );
                        }).toList(),
                      ),

                      const SizedBox(height: 20),

                      // Divisor
                      Divider(
                        color: appTema.isDarkMode
                            ? Colors.white.withValues(alpha: 0.2)
                            : Colors.black.withValues(alpha: 0.1),
                      ),

                      const SizedBox(height: 20),

                      // DescriÃ§Ã£o
                      if (widget.video.descricao.isNotEmpty) ...[
                        Text(
                          'DescriÃ§Ã£o',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: appTema.textColor,
                          ),
                        ),
                        const SizedBox(height: 12),
                        Text(
                          widget.video.descricao,
                          style: TextStyle(
                            fontSize: 16,
                            height: 1.5,
                            color: appTema.textSecondaryColor,
                          ),
                        ),
                      ],

                      const SizedBox(height: 24),

                      // Data de upload
                      Row(
                        children: [
                          Icon(
                            Icons.calendar_today,
                            size: 16,
                            color: appTema.textSecondaryColor,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            'Adicionado em ${_formatarData(widget.video.dataUpload)}',
                            style: TextStyle(
                              fontSize: 14,
                              color: appTema.textSecondaryColor,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILITÃRIOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  String _formatarData(DateTime data) {
    final meses = [
      'janeiro',
      'fevereiro',
      'marÃ§o',
      'abril',
      'maio',
      'junho',
      'julho',
      'agosto',
      'setembro',
      'outubro',
      'novembro',
      'dezembro',
    ];

    return '${data.day} de ${meses[data.month - 1]} de ${data.year}';
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\video_service_youtube.dart
// ========================================
import 'package:cloud_firestore/cloud_firestore.dart';
import 'video_model_youtube.dart';

/// ServiÃ§o para gerenciar vÃ­deos do YouTube no Firestore
class VideoServiceYoutube {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUSCAR VÃDEOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Busca todos os vÃ­deos ativos
  Future<List<VideoModelYoutube>> buscarTodosVideos() async {
    try {
      final query = await _firestore
          .collection('videos_youtube')
          .where('ativo', isEqualTo: true)
          .orderBy('dataUpload', descending: true)
          .get();

      return query.docs
          .map((doc) => VideoModelYoutube.fromFirestore(doc))
          .toList();
    } catch (e) {
      print('âŒ Erro ao buscar vÃ­deos: $e');
      return [];
    }
  }

  /// Busca vÃ­deos por gÃªnero especÃ­fico
  Future<List<VideoModelYoutube>> buscarVideosPorGenero(String genero) async {
    try {
      final query = await _firestore
          .collection('videos_youtube')
          .where('ativo', isEqualTo: true)
          .where('generos', arrayContains: genero)
          .orderBy('dataUpload', descending: true)
          .get();

      return query.docs
          .map((doc) => VideoModelYoutube.fromFirestore(doc))
          .toList();
    } catch (e) {
      print('âŒ Erro ao buscar vÃ­deos por gÃªnero: $e');
      return [];
    }
  }

  /// Busca vÃ­deos por mÃºltiplos gÃªneros
  Future<List<VideoModelYoutube>> buscarVideosPorGeneros(
    List<String> generos,
  ) async {
    try {
      // Busca vÃ­deos que contenham pelo menos um dos gÃªneros
      final query = await _firestore
          .collection('videos_youtube')
          .where('ativo', isEqualTo: true)
          .orderBy('dataUpload', descending: true)
          .get();

      // Filtra manualmente para incluir vÃ­deos que tenham qualquer um dos gÃªneros
      final videos = query.docs
          .map((doc) => VideoModelYoutube.fromFirestore(doc))
          .where(
            (video) => video.generos.any((genero) => generos.contains(genero)),
          )
          .toList();

      return videos;
    } catch (e) {
      print('âŒ Erro ao buscar vÃ­deos por mÃºltiplos gÃªneros: $e');
      return [];
    }
  }

  /// Busca um vÃ­deo especÃ­fico por ID
  Future<VideoModelYoutube?> buscarVideoPorId(String videoId) async {
    try {
      final doc = await _firestore
          .collection('videos_youtube')
          .doc(videoId)
          .get();

      if (doc.exists) {
        return VideoModelYoutube.fromFirestore(doc);
      }
      return null;
    } catch (e) {
      print('âŒ Erro ao buscar vÃ­deo por ID: $e');
      return null;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ADICIONAR VÃDEO (APENAS ADMIN)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Adiciona um novo vÃ­deo do YouTube ao Firestore
  /// Retorna o ID do documento criado ou null se houver erro
  Future<String?> adicionarVideo({
    required String titulo,
    required String descricao,
    required String youtubeUrl,
    required List<String> generos,
  }) async {
    try {
      // Extrai o ID do YouTube da URL
      final youtubeId = VideoModelYoutube.extractYoutubeId(youtubeUrl);

      if (youtubeId == null) {
        print('âŒ URL do YouTube invÃ¡lida: $youtubeUrl');
        return null;
      }

      // Cria o mapa de dados
      final videoData = {
        'titulo': titulo,
        'descricao': descricao,
        'youtubeId': youtubeId,
        'youtubeUrl': youtubeUrl,
        'generos': generos,
        'dataUpload': FieldValue.serverTimestamp(),
        'ativo': true,
      };

      // Adiciona ao Firestore
      final docRef = await _firestore
          .collection('videos_youtube')
          .add(videoData);

      print('âœ… VÃ­deo adicionado com sucesso! ID: ${docRef.id}');
      return docRef.id;
    } catch (e) {
      print('âŒ Erro ao adicionar vÃ­deo: $e');
      return null;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ATUALIZAR VÃDEO (APENAS ADMIN)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Atualiza um vÃ­deo existente
  Future<bool> atualizarVideo({
    required String videoId,
    String? titulo,
    String? descricao,
    String? youtubeUrl,
    List<String>? generos,
    bool? ativo,
  }) async {
    try {
      final Map<String, dynamic> updates = {};

      if (titulo != null) updates['titulo'] = titulo;
      if (descricao != null) updates['descricao'] = descricao;
      if (generos != null) updates['generos'] = generos;
      if (ativo != null) updates['ativo'] = ativo;

      if (youtubeUrl != null) {
        final youtubeId = VideoModelYoutube.extractYoutubeId(youtubeUrl);
        if (youtubeId != null) {
          updates['youtubeUrl'] = youtubeUrl;
          updates['youtubeId'] = youtubeId;
        }
      }

      if (updates.isEmpty) {
        print('âš ï¸ Nenhuma atualizaÃ§Ã£o fornecida');
        return false;
      }

      await _firestore
          .collection('videos_youtube')
          .doc(videoId)
          .update(updates);

      print('âœ… VÃ­deo atualizado com sucesso!');
      return true;
    } catch (e) {
      print('âŒ Erro ao atualizar vÃ­deo: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXCLUIR VÃDEO (APENAS ADMIN)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Exclui um vÃ­deo do Firestore
  Future<bool> excluirVideo(String videoId) async {
    try {
      await _firestore.collection('videos_youtube').doc(videoId).delete();

      print('âœ… VÃ­deo excluÃ­do com sucesso!');
      return true;
    } catch (e) {
      print('âŒ Erro ao excluir vÃ­deo: $e');
      return false;
    }
  }

  /// Desativa um vÃ­deo (soft delete)
  Future<bool> desativarVideo(String videoId) async {
    try {
      await _firestore.collection('videos_youtube').doc(videoId).update({
        'ativo': false,
      });

      print('âœ… VÃ­deo desativado com sucesso!');
      return true;
    } catch (e) {
      print('âŒ Erro ao desativar vÃ­deo: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ANALYTICS (VISUALIZAÃ‡Ã•ES)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Registra uma visualizaÃ§Ã£o do vÃ­deo
  Future<void> registrarVisualizacao(String videoId, String userId) async {
    try {
      await _firestore
          .collection('videos_youtube')
          .doc(videoId)
          .collection('visualizacoes')
          .add({'userId': userId, 'timestamp': FieldValue.serverTimestamp()});

      print('âœ… VisualizaÃ§Ã£o registrada');
    } catch (e) {
      print('âŒ Erro ao registrar visualizaÃ§Ã£o: $e');
    }
  }

  /// Busca o total de visualizaÃ§Ãµes de um vÃ­deo
  Future<int> buscarTotalVisualizacoes(String videoId) async {
    try {
      final query = await _firestore
          .collection('videos_youtube')
          .doc(videoId)
          .collection('visualizacoes')
          .get();

      return query.docs.length;
    } catch (e) {
      print('âŒ Erro ao buscar visualizaÃ§Ãµes: $e');
      return 0;
    }
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\services\pin_service.dart
// ========================================
import 'dart:convert';
import 'package:crypto/crypto.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';

/// ServiÃ§o para gerenciamento seguro de PINs
///
/// Este serviÃ§o usa SHA-256 para hash de PINs, garantindo que
/// os PINs nunca sejam armazenados em texto plano no Firestore.
///
/// âœ… ATUALIZADO: Apenas gerencia PIN do perfil PAI (array nÃ£o tem PIN prÃ³prio)
class PinService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HASH DE PIN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Gera um hash SHA-256 do PIN
  ///
  /// Exemplo: "1234" â†’ "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"
  String _hashPin(String pin) {
    final bytes = utf8.encode(pin);
    final hash = sha256.convert(bytes);
    return hash.toString();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CRIAR PIN (APENAS PERFIL PAI)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Cria um novo PIN para o usuÃ¡rio atual (perfil pai)
  ///
  /// Retorna:
  /// - `true` se o PIN foi criado com sucesso
  /// - `false` em caso de erro
  Future<bool> criarPinPerfilPai(String pin) async {
    try {
      final user = _auth.currentUser;
      if (user == null) {
        print('âŒ UsuÃ¡rio nÃ£o autenticado');
        return false;
      }

      // ValidaÃ§Ã£o bÃ¡sica
      if (!_validarPin(pin)) {
        print('âŒ PIN invÃ¡lido');
        return false;
      }

      // Hash do PIN
      final pinHash = _hashPin(pin);

      // Salva no Firestore
      await _firestore.collection('users').doc(user.uid).update({
        'pinHash': pinHash,
        'pinCriadoEm': FieldValue.serverTimestamp(),
      });

      print('âœ… PIN criado com sucesso para ${user.uid}');
      return true;
    } catch (e) {
      print('âŒ Erro ao criar PIN: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VERIFICAR PIN (APENAS PERFIL PAI)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Verifica se o PIN fornecido corresponde ao PIN do perfil pai
  ///
  /// Retorna:
  /// - `true` se o PIN estÃ¡ correto
  /// - `false` se o PIN estÃ¡ incorreto ou ocorreu erro
  Future<bool> verificarPinPerfilPai(String pin) async {
    try {
      final user = _auth.currentUser;
      if (user == null) {
        print('âŒ UsuÃ¡rio nÃ£o autenticado');
        return false;
      }

      // Busca o hash do Firestore
      final userDoc = await _firestore.collection('users').doc(user.uid).get();

      if (!userDoc.exists) {
        print('âŒ Documento do usuÃ¡rio nÃ£o encontrado');
        return false;
      }

      final pinHashSalvo = userDoc.data()?['pinHash'] as String?;

      if (pinHashSalvo == null) {
        print('âš ï¸ UsuÃ¡rio nÃ£o tem PIN configurado');
        return false;
      }

      // Compara o hash do PIN fornecido com o hash salvo
      final pinHashFornecido = _hashPin(pin);
      final pinCorreto = pinHashFornecido == pinHashSalvo;

      if (pinCorreto) {
        print('âœ… PIN correto');
      } else {
        print('âŒ PIN incorreto');
      }

      return pinCorreto;
    } catch (e) {
      print('âŒ Erro ao verificar PIN: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ALTERAR PIN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Altera o PIN do perfil pai
  ///
  /// Requer o PIN antigo para autorizaÃ§Ã£o
  Future<bool> alterarPinPerfilPai(String pinAntigo, String pinNovo) async {
    try {
      // Primeiro verifica o PIN antigo
      final pinAntigoCorreto = await verificarPinPerfilPai(pinAntigo);

      if (!pinAntigoCorreto) {
        print('âŒ PIN antigo incorreto');
        return false;
      }

      // Valida o novo PIN
      if (!_validarPin(pinNovo)) {
        print('âŒ Novo PIN invÃ¡lido');
        return false;
      }

      // Cria o novo hash
      final user = _auth.currentUser;
      if (user == null) return false;

      final pinHashNovo = _hashPin(pinNovo);

      // Atualiza no Firestore
      await _firestore.collection('users').doc(user.uid).update({
        'pinHash': pinHashNovo,
        'pinAlteradoEm': FieldValue.serverTimestamp(),
      });

      print('âœ… PIN alterado com sucesso');
      return true;
    } catch (e) {
      print('âŒ Erro ao alterar PIN: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // REMOVER PIN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Remove o PIN do perfil pai (requer PIN para autorizaÃ§Ã£o)
  Future<bool> removerPinPerfilPai(String pin) async {
    try {
      // Primeiro verifica o PIN
      final pinCorreto = await verificarPinPerfilPai(pin);

      if (!pinCorreto) {
        print('âŒ PIN incorreto');
        return false;
      }

      final user = _auth.currentUser;
      if (user == null) return false;

      // Remove o hash do Firestore
      await _firestore.collection('users').doc(user.uid).update({
        'pinHash': FieldValue.delete(),
        'pinCriadoEm': FieldValue.delete(),
        'pinAlteradoEm': FieldValue.delete(),
      });

      print('âœ… PIN removido com sucesso');
      return true;
    } catch (e) {
      print('âŒ Erro ao remover PIN: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VERIFICAR SE TEM PIN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Verifica se o usuÃ¡rio tem PIN configurado
  Future<bool> temPinConfigurado() async {
    try {
      final user = _auth.currentUser;
      if (user == null) return false;

      final userDoc = await _firestore.collection('users').doc(user.uid).get();

      if (!userDoc.exists) return false;

      final pinHash = userDoc.data()?['pinHash'];
      return pinHash != null && pinHash is String && pinHash.isNotEmpty;
    } catch (e) {
      print('âŒ Erro ao verificar PIN: $e');
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDAÃ‡ÃƒO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Valida se o PIN Ã© vÃ¡lido
  ///
  /// Regras:
  /// - Deve ter exatamente 4 dÃ­gitos
  /// - Deve conter apenas nÃºmeros
  bool _validarPin(String pin) {
    if (pin.length != 4) {
      print('âš ï¸ PIN deve ter 4 dÃ­gitos');
      return false;
    }

    if (!RegExp(r'^\d{4}$').hasMatch(pin)) {
      print('âš ï¸ PIN deve conter apenas nÃºmeros');
      return false;
    }

    return true;
  }
}


// ========================================
// filepath: C:\Users\Rafoso\Downloads\bluflix\lib\widgets\theme_toggle_button.dart
// ========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../app_tema.dart';

class ThemeToggleButton extends StatelessWidget {
  final bool showLogo; // âœ… ParÃ¢metro para controlar se mostra a logo

  const ThemeToggleButton({
    super.key,
    this.showLogo = true, // Por padrÃ£o mostra a logo
  });

  @override
  Widget build(BuildContext context) {
    final appTema = Provider.of<AppTema>(context);

    // Widget do botÃ£o (sempre o mesmo)
    final button = IconButton(
      onPressed: () => appTema.toggleTheme(),
      icon: AnimatedSwitcher(
        duration: const Duration(milliseconds: 300),
        transitionBuilder: (child, animation) {
          return RotationTransition(
            turns: animation,
            child: FadeTransition(opacity: animation, child: child),
          );
        },
        child: Icon(
          appTema.isDarkMode ? Icons.nightlight_round : Icons.wb_sunny,
          key: ValueKey(appTema.isDarkMode),
          color: appTema.isDarkMode ? Colors.amber : Colors.orange,
          size: 28,
        ),
      ),
      tooltip: appTema.isDarkMode ? 'Modo Claro' : 'Modo Escuro',
      splashRadius: 24,
      hoverColor: appTema.isDarkMode
          ? Colors.white.withValues(alpha: 0.1)
          : Colors.black.withValues(alpha: 0.05),
    );

    // Se showLogo for false, retorna apenas o botÃ£o
    if (!showLogo) {
      return button;
    }

    // Se showLogo for true, retorna logo + botÃ£o sem usar Spacer
    return Row(
      mainAxisSize:
          MainAxisSize.min, // âœ… IMPORTANTE: Evita unbounded constraints
      children: [
        Image.asset("assets/logo.png", height: 40),
        const SizedBox(width: 8), // EspaÃ§o fixo em vez de Spacer
        button,
      ],
    );
  }
}


